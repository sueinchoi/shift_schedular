<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì£¼ë³„ ë‹¹ì§í‘œ ìƒì„±ê¸°</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }

        h2 {
            color: #34495e;
            margin-top: 30px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .input-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .result-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* ì¸ì› ëª©ë¡ ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ */
        #personList {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 12px;
            margin-top: 15px;
        }

        .person-entry {
            background: white;
            padding: 12px;
            border-radius: 5px;
            border-left: 4px solid #3498db;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: box-shadow 0.2s;
        }

        .person-entry.team-a {
            border-left-color: #e74c3c;
        }

        .person-entry.team-b {
            border-left-color: #2ecc71;
        }

        .person-entry:hover {
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }

        .person-entry.edit-mode {
            border: 2px solid #3498db;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.3);
        }

        .person-entry:not(.edit-mode) {
            cursor: pointer;
        }

        .person-entry:not(.edit-mode):hover {
            background: #f8f9fa;
        }

        .edit-form-header {
            background: #3498db;
            color: white;
            padding: 8px 12px;
            margin: -12px -12px 12px -12px;
            border-radius: 3px 3px 0 0;
            font-weight: 600;
            font-size: 14px;
        }

        .edit-form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }

        .edit-form-field {
            margin-bottom: 12px;
        }

        .edit-form-field label {
            font-size: 12px;
            font-weight: 600;
            color: #2c3e50;
            margin: 0 0 4px 0;
            display: block;
        }

        .edit-form-field input,
        .edit-form-field select {
            width: 100%;
            padding: 8px;
            font-size: 13px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .edit-form-field input:focus,
        .edit-form-field select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
        }

        .edit-form-buttons {
            display: flex;
            gap: 8px;
            margin-top: 15px;
        }

        .edit-form-buttons button {
            flex: 1;
            padding: 10px;
            font-size: 13px;
            font-weight: 600;
        }

        .person-entry h3 {
            margin: 0 0 8px 0;
            color: #2c3e50;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .team-badge {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 600;
        }

        .team-badge.team-a {
            background: #fee;
            color: #c0392b;
        }

        .team-badge.team-b {
            background: #e8f8f0;
            color: #27ae60;
        }

        .person-compact-info {
            font-size: 12px;
            color: #666;
            line-height: 1.5;
        }

        .person-compact-info strong {
            color: #2c3e50;
            font-weight: 600;
        }

        label {
            display: block;
            margin: 8px 0 4px 0;
            font-weight: 500;
            color: #555;
            font-size: 14px;
        }

        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background 0.3s;
            margin: 5px;
        }

        button:hover {
            background: #2980b9;
        }

        button.secondary {
            background: #95a5a6;
        }

        button.secondary:hover {
            background: #7f8c8d;
        }

        button.danger {
            background: #e74c3c;
        }

        button.danger:hover {
            background: #c0392b;
        }

        .button-group {
            text-align: center;
            margin: 20px 0;
        }

        /* ì£¼ë³„ ìŠ¤ì¼€ì¤„ ê·¸ë¦¬ë“œ */
        .schedule-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .week-card {
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .week-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .week-card.mixed-team {
            background: linear-gradient(135deg, #fff5f5 0%, #f5fff5 100%);
            border-color: #9b59b6;
        }

        .week-card.manually-edited {
            border: 2px solid #f39c12;
        }

        .week-card.edit-mode {
            border: 2px solid #3498db;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.3);
        }

        .week-header {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .week-number {
            font-size: 18px;
        }

        .mixed-badge {
            font-size: 10px;
            background: #9b59b6;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
        }

        .week-assignments {
            font-size: 14px;
        }

        .assignment-person {
            padding: 5px 0;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .assignment-person .team-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .assignment-person .team-indicator.team-a {
            background: #e74c3c;
        }

        .assignment-person .team-indicator.team-b {
            background: #2ecc71;
        }

        .manual-edit-badge {
            font-size: 10px;
            background: #f39c12;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
        }

        .edit-controls {
            margin-top: 10px;
        }

        .edit-controls select {
            margin-bottom: 8px;
        }

        .alert {
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
        }

        .stats {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }

        .stats h3 {
            margin: 0 0 15px 0;
            color: #2c3e50;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
        }

        .stat-item {
            background: white;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
        }

        .stat-item strong {
            display: block;
            color: #2c3e50;
        }

        .small-text {
            font-size: 12px;
            color: #666;
        }

        .collapsible-section {
            margin-top: 15px;
        }

        .collapsible-header {
            background: #ecf0f1;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            color: #2c3e50;
        }

        .collapsible-header:hover {
            background: #e0e5e7;
        }

        .collapsible-content {
            padding: 15px;
            background: white;
            border: 1px solid #ecf0f1;
            border-top: none;
            border-radius: 0 0 5px 5px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .week-setting-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
            margin-bottom: 8px;
        }

        .week-setting-row input[type="checkbox"] {
            width: auto;
        }

        .tag {
            display: inline-block;
            padding: 2px 8px;
            background: #e8f4fc;
            color: #2980b9;
            border-radius: 3px;
            font-size: 11px;
            margin: 2px;
        }

        .tag.vacation {
            background: #fef5e7;
            color: #d35400;
        }

        .tag.preferred {
            background: #e8f8f0;
            color: #27ae60;
        }
    </style>
</head>
<body>
    <h1>ğŸ“… ì£¼ë³„ ë‹¹ì§í‘œ ìƒì„±ê¸°</h1>

    <div class="container">
        <!-- ì¸ì› ê´€ë¦¬ ì„¹ì…˜ -->
        <div class="input-section">
            <h2>ğŸ‘¥ ì¸ì› ê´€ë¦¬</h2>

            <!-- ì¸ì› ì¶”ê°€ í¼ -->
            <div class="collapsible-section">
                <div class="collapsible-header" onclick="toggleSection('addPersonSection')">
                    â• ìƒˆ ì¸ì› ì¶”ê°€
                    <span id="addPersonToggle">â–¼</span>
                </div>
                <div id="addPersonSection" class="collapsible-content" style="display: none;">
                    <div class="form-row">
                        <div>
                            <label>ì´ë¦„</label>
                            <input type="text" id="personName" placeholder="ì´ë¦„ ì…ë ¥">
                        </div>
                        <div>
                            <label>íŒ€</label>
                            <select id="personTeam">
                                <option value="A">AíŒ€</option>
                                <option value="B">BíŒ€</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div>
                            <label>ì„ í˜¸ ì£¼ì°¨ (ì‰¼í‘œë¡œ êµ¬ë¶„, ì˜ˆ: 1,5,9)</label>
                            <input type="text" id="preferredWeeks" placeholder="1,5,9">
                        </div>
                        <div>
                            <label>íœ´ê°€ ì£¼ì°¨ (ì‰¼í‘œë¡œ êµ¬ë¶„, ì˜ˆ: 3,7)</label>
                            <input type="text" id="vacationWeeks" placeholder="3,7">
                        </div>
                    </div>
                    <button onclick="addPerson()">ì¸ì› ì¶”ê°€</button>
                </div>
            </div>

            <!-- ë°ì´í„° ê´€ë¦¬ ë²„íŠ¼ -->
            <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button onclick="loadSampleData()" class="secondary">ğŸ“‹ ì˜ˆì‹œ ë°ì´í„°</button>
                <button onclick="downloadJSON()" class="secondary">ğŸ’¾ ì €ì¥</button>
                <label style="display: inline-block; margin: 0;">
                    <input type="file" id="uploadFile" accept=".json" onchange="uploadJSON(event)" style="display: none;">
                    <button onclick="document.getElementById('uploadFile').click()" class="secondary">ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                </label>
                <button onclick="clearAllData()" class="danger">ğŸ—‘ï¸ ì´ˆê¸°í™”</button>
            </div>

            <!-- ì¸ì› ëª©ë¡ -->
            <div id="personList">
                <p class="small-text">ë“±ë¡ëœ ì¸ì›ì´ ì—†ìŠµë‹ˆë‹¤. ìœ„ì—ì„œ ì¸ì›ì„ ì¶”ê°€í•˜ê±°ë‚˜ ì˜ˆì‹œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.</p>
            </div>
        </div>

        <!-- ë‹¹ì§í‘œ ì„¹ì…˜ -->
        <div class="result-section">
            <h2>ğŸ“… ì£¼ë³„ ë‹¹ì§í‘œ</h2>

            <!-- ì„¤ì • -->
            <div style="background: #f0f8ff; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                <label style="font-size: 14px; font-weight: 600; color: #2c3e50; margin-bottom: 8px; display: block;">âš™ï¸ ë‹¹ì§í‘œ ì„¤ì •</label>
                <div class="form-row">
                    <div>
                        <label>ì´ ì£¼ ìˆ˜</label>
                        <input type="number" id="totalWeeks" value="12" min="1" max="52">
                    </div>
                    <div>
                        <label>ì£¼ë‹¹ ì¸ì› ìˆ˜</label>
                        <input type="number" id="peoplePerWeek" value="2" min="1" max="5">
                    </div>
                    <div>
                        <label>ìµœì†Œ ê°„ê²© (ì£¼)</label>
                        <input type="number" id="minGap" value="4" min="1" max="10">
                    </div>
                    <div>
                        <label>1ì¸ë‹¹ ìµœëŒ€ íšŸìˆ˜</label>
                        <input type="number" id="maxDutyPerPerson" value="2" min="1" max="10">
                    </div>
                </div>
            </div>

            <!-- í˜¼í•©íŒ€ ì£¼ì°¨ ì„¤ì • -->
            <div style="background: #fff5f0; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                <label style="font-size: 14px; font-weight: 600; color: #2c3e50; margin-bottom: 8px; display: block;">ğŸ”€ í˜¼í•©íŒ€ ì£¼ì°¨ ì„¤ì • (AíŒ€ 1ëª… + BíŒ€ 1ëª…)</label>
                <div id="mixedWeekSettings" style="max-height: 200px; overflow-y: auto;">
                    <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                </div>
                <button onclick="updateMixedWeekSettings()" class="secondary" style="margin-top: 10px; padding: 8px 16px; font-size: 13px;">ì„¤ì • ìƒˆë¡œê³ ì¹¨</button>
            </div>

            <div id="scheduleWarning" class="alert alert-error" style="display: none; font-size: 13px; margin-bottom: 10px;">
                âš ï¸ <strong>ì¸ì› ì •ë³´ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.</strong> ë³€ê²½ëœ ì •ë³´ë¥¼ ë°˜ì˜í•˜ë ¤ë©´ ë‹¹ì§í‘œë¥¼ ë‹¤ì‹œ ìƒì„±í•´ì£¼ì„¸ìš”.
            </div>

            <div class="button-group">
                <button onclick="generateSchedule()">ğŸ¯ ë‹¹ì§í‘œ ìƒì„±</button>
                <button onclick="generateMultipleSchedules()">ğŸ”„ ì—¬ëŸ¬ ê²½ìš° ìƒì„± (5ê°œ)</button>
                <button onclick="exportSchedule()" class="secondary">ğŸ’¾ ë‚´ë³´ë‚´ê¸°</button>
            </div>

            <div id="scheduleNavigation" style="display: none; text-align: center; margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <button onclick="prevSchedule()" class="secondary" style="padding: 8px 16px;">â—€ ì´ì „</button>
                <span id="scheduleIndicator" style="margin: 0 20px; font-weight: 600; color: #2c3e50;"></span>
                <button onclick="nextSchedule()" class="secondary" style="padding: 8px 16px;">ë‹¤ìŒ â–¶</button>
            </div>

            <div class="alert alert-info" style="font-size: 13px;">
                ğŸ’¡ <strong>íŒ:</strong> ë‹¹ì§í‘œ ìƒì„± í›„ ê° ì£¼ì°¨ë¥¼ í´ë¦­í•˜ë©´ ë‹¹ì§ìë¥¼ ìˆ˜ë™ìœ¼ë¡œ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </div>

            <div id="messages"></div>
            <div id="scheduleGrid"></div>
            <div id="statistics"></div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë°ì´í„°
        let people = [];
        let schedule = null;
        let schedules = []; // ì—¬ëŸ¬ ìŠ¤ì¼€ì¤„ ì €ì¥
        let currentScheduleIndex = 0; // í˜„ì¬ í‘œì‹œ ì¤‘ì¸ ìŠ¤ì¼€ì¤„ ì¸ë±ìŠ¤
        let mixedTeamWeeks = new Set(); // í˜¼í•©íŒ€ ì£¼ì°¨
        let editingWeekIndex = null;
        let editingPersonIndex = null; // í˜„ì¬ í¸ì§‘ ì¤‘ì¸ ì¸ì› ì¸ë±ìŠ¤
        let peopleModifiedAfterSchedule = false;

        // Person í´ë˜ìŠ¤
        class Person {
            constructor(name, team, preferredWeeks = [], vacationWeeks = []) {
                this.name = name;
                this.team = team; // 'A' or 'B'
                this.preferredWeeks = preferredWeeks;
                this.vacationWeeks = vacationWeeks;
                this.dutyCount = 0;
            }

            isOnVacation(weekNumber) {
                return this.vacationWeeks.includes(weekNumber);
            }

            hasPreferredWeek(weekNumber) {
                return this.preferredWeeks.includes(weekNumber);
            }

            canTakeMoreDuties(maxDuty) {
                return this.dutyCount < maxDuty;
            }
        }

        // ì„¹ì…˜ í† ê¸€
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const toggle = document.getElementById(sectionId.replace('Section', 'Toggle'));
            if (section.style.display === 'none') {
                section.style.display = 'block';
                if (toggle) toggle.textContent = 'â–²';
            } else {
                section.style.display = 'none';
                if (toggle) toggle.textContent = 'â–¼';
            }
        }

        // ì¸ì› ì¶”ê°€
        function addPerson() {
            const name = document.getElementById('personName').value.trim();
            const team = document.getElementById('personTeam').value;
            const preferredWeeksStr = document.getElementById('preferredWeeks').value.trim();
            const vacationWeeksStr = document.getElementById('vacationWeeks').value.trim();

            if (!name) {
                showMessage('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            if (people.some(p => p.name === name)) {
                showMessage('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì´ë¦„ì…ë‹ˆë‹¤.', 'error');
                return;
            }

            const preferredWeeks = preferredWeeksStr ? preferredWeeksStr.split(',').map(w => parseInt(w.trim())).filter(w => !isNaN(w)) : [];
            const vacationWeeks = vacationWeeksStr ? vacationWeeksStr.split(',').map(w => parseInt(w.trim())).filter(w => !isNaN(w)) : [];

            people.push(new Person(name, team, preferredWeeks, vacationWeeks));

            // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            document.getElementById('personName').value = '';
            document.getElementById('preferredWeeks').value = '';
            document.getElementById('vacationWeeks').value = '';

            renderPersonList();
            markPeopleModified();
            showMessage(`${name}ë‹˜ì´ ${team}íŒ€ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
        }

        // ì¸ì› ì‚­ì œ
        function removePerson(index) {
            const name = people[index].name;
            if (confirm(`${name}ë‹˜ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                people.splice(index, 1);
                renderPersonList();
                markPeopleModified();
                showMessage(`${name}ë‹˜ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
            }
        }

        // ì˜ˆì‹œ ë°ì´í„° ë¡œë“œ
        function loadSampleData() {
            people = [
                new Person('ê¹€ì² ìˆ˜', 'A', [1, 5], []),
                new Person('ì´ì˜í¬', 'A', [], [3]),
                new Person('ë°•ë¯¼ìˆ˜', 'A', [2], []),
                new Person('ì •ìˆ˜ì§„', 'A', [], [7, 8]),
                new Person('í™ê¸¸ë™', 'A', [4], []),
                new Person('ìµœë¯¼ì •', 'B', [], [2]),
                new Person('ê°•ë™ì›', 'B', [3, 6], []),
                new Person('ìœ¤ì„œì—°', 'B', [], [5]),
                new Person('ì¥ë¯¼í˜¸', 'B', [1], []),
                new Person('í•œì†Œí¬', 'B', [], [])
            ];

            // í˜¼í•©íŒ€ ì£¼ì°¨ ì˜ˆì‹œ ì„¤ì •
            mixedTeamWeeks = new Set([4, 8, 12]);

            renderPersonList();
            updateMixedWeekSettings();
            markPeopleModified();
            showMessage('ì˜ˆì‹œ ë°ì´í„°ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }

        // JSON ë‹¤ìš´ë¡œë“œ
        function downloadJSON() {
            const data = {
                people: people.map(p => ({
                    name: p.name,
                    team: p.team,
                    preferredWeeks: p.preferredWeeks,
                    vacationWeeks: p.vacationWeeks,
                    dutyCount: p.dutyCount
                })),
                mixedTeamWeeks: Array.from(mixedTeamWeeks)
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ì£¼ë³„ë‹¹ì§_ì¸ì›ì •ë³´_' + new Date().toISOString().slice(0, 10) + '.json';
            a.click();
            URL.revokeObjectURL(url);
            showMessage('ì¸ì› ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }

        // JSON ì—…ë¡œë“œ
        function uploadJSON(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    people = data.people.map(p => {
                        const person = new Person(p.name, p.team, p.preferredWeeks || [], p.vacationWeeks || []);
                        person.dutyCount = p.dutyCount || 0;
                        return person;
                    });
                    mixedTeamWeeks = new Set(data.mixedTeamWeeks || []);

                    renderPersonList();
                    updateMixedWeekSettings();
                    markPeopleModified();
                    showMessage(`ì¸ì› ì •ë³´ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤. (${people.length}ëª…)`, 'success');
                } catch (error) {
                    showMessage('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // ì „ì²´ ì´ˆê¸°í™”
        function clearAllData() {
            if (confirm('ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                people = [];
                schedule = null;
                mixedTeamWeeks = new Set();
                renderPersonList();
                renderScheduleGrid();
                renderStatistics();
                updateMixedWeekSettings();
                markPeopleModified();
                showMessage('ëª¨ë“  ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
            }
        }

        // ì¸ì› ëª©ë¡ ë Œë”ë§
        function renderPersonList() {
            const listDiv = document.getElementById('personList');
            if (people.length === 0) {
                listDiv.innerHTML = '<p class="small-text">ë“±ë¡ëœ ì¸ì›ì´ ì—†ìŠµë‹ˆë‹¤. ìœ„ì—ì„œ ì¸ì›ì„ ì¶”ê°€í•˜ê±°ë‚˜ ì˜ˆì‹œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.</p>';
                return;
            }

            // íŒ€ë³„ë¡œ ì •ë ¬
            const sortedPeople = [...people].sort((a, b) => {
                if (a.team !== b.team) return a.team.localeCompare(b.team);
                return a.name.localeCompare(b.name);
            });

            let html = `<div style="grid-column: 1 / -1; margin-bottom: 10px;">
                <strong>ë“±ë¡ëœ ì¸ì›: ${people.length}ëª…</strong>
                (AíŒ€: ${people.filter(p => p.team === 'A').length}ëª…, BíŒ€: ${people.filter(p => p.team === 'B').length}ëª…)
            </div>`;

            sortedPeople.forEach((person, sortedIndex) => {
                const originalIndex = people.indexOf(person);
                const teamClass = person.team === 'A' ? 'team-a' : 'team-b';
                const isEditing = editingPersonIndex === originalIndex;
                const editModeClass = isEditing ? 'edit-mode' : '';

                if (isEditing) {
                    // í¸ì§‘ ëª¨ë“œ - ê°œì„ ëœ í¼
                    html += `
                        <div class="person-entry ${teamClass} ${editModeClass}" id="person_${originalIndex}">
                            <div class="edit-form-header">âœï¸ ${person.name} ì •ë³´ ìˆ˜ì •</div>

                            <div class="edit-form-row">
                                <div class="edit-form-field">
                                    <label>ì´ë¦„</label>
                                    <input type="text" id="editName_${originalIndex}" value="${person.name}" onkeydown="handleEditKeydown(event, ${originalIndex})">
                                </div>
                                <div class="edit-form-field">
                                    <label>íŒ€</label>
                                    <select id="editTeam_${originalIndex}">
                                        <option value="A" ${person.team === 'A' ? 'selected' : ''}>AíŒ€</option>
                                        <option value="B" ${person.team === 'B' ? 'selected' : ''}>BíŒ€</option>
                                    </select>
                                </div>
                            </div>

                            <div class="edit-form-field">
                                <label>ğŸŒŸ ì„ í˜¸ ì£¼ì°¨ (ì‰¼í‘œë¡œ êµ¬ë¶„, ì˜ˆ: 1, 5, 9)</label>
                                <input type="text" id="editPreferred_${originalIndex}" value="${person.preferredWeeks.join(', ')}" placeholder="ì„ í˜¸í•˜ëŠ” ì£¼ì°¨ ì…ë ¥" onkeydown="handleEditKeydown(event, ${originalIndex})">
                            </div>

                            <div class="edit-form-field">
                                <label>ğŸ–ï¸ íœ´ê°€ ì£¼ì°¨ (ì‰¼í‘œë¡œ êµ¬ë¶„, ì˜ˆ: 3, 7)</label>
                                <input type="text" id="editVacation_${originalIndex}" value="${person.vacationWeeks.join(', ')}" placeholder="íœ´ê°€ ì£¼ì°¨ ì…ë ¥" onkeydown="handleEditKeydown(event, ${originalIndex})">
                            </div>

                            <div class="edit-form-buttons">
                                <button onclick="savePersonEdit(${originalIndex})" style="background: #27ae60;">âœ“ ì €ì¥</button>
                                <button onclick="cancelPersonEdit()" class="secondary">âœ• ì·¨ì†Œ</button>
                                <button onclick="confirmRemovePerson(${originalIndex})" class="danger">ğŸ—‘ï¸ ì‚­ì œ</button>
                            </div>
                        </div>
                    `;
                } else {
                    // í‘œì‹œ ëª¨ë“œ - ì¹´ë“œ í´ë¦­ì‹œ í¸ì§‘
                    let tagsHtml = '';
                    if (person.preferredWeeks.length > 0) {
                        tagsHtml += `<span class="tag preferred">ğŸŒŸ ì„ í˜¸: ${person.preferredWeeks.join(', ')}ì£¼</span>`;
                    }
                    if (person.vacationWeeks.length > 0) {
                        tagsHtml += `<span class="tag vacation">ğŸ–ï¸ íœ´ê°€: ${person.vacationWeeks.join(', ')}ì£¼</span>`;
                    }

                    html += `
                        <div class="person-entry ${teamClass}" id="person_${originalIndex}" onclick="togglePersonEditMode(${originalIndex})" title="í´ë¦­í•˜ì—¬ ìˆ˜ì •">
                            <h3>
                                ${person.name}
                                <span class="team-badge ${teamClass}">${person.team}íŒ€</span>
                            </h3>
                            <div class="person-compact-info">
                                ${tagsHtml || '<span class="small-text">ì œì•½ ì—†ìŒ - í´ë¦­í•˜ì—¬ ì¶”ê°€</span>'}
                            </div>
                        </div>
                    `;
                }
            });

            listDiv.innerHTML = html;
        }

        // ì¸ì› í¸ì§‘ ëª¨ë“œ í† ê¸€
        function togglePersonEditMode(index) {
            if (editingPersonIndex !== null && editingPersonIndex !== index) {
                // ë‹¤ë¥¸ í¸ì§‘ ì¤‘ì´ë©´ ë¨¼ì € ì·¨ì†Œ
                editingPersonIndex = null;
            }
            editingPersonIndex = index;
            renderPersonList();

            // ì²« ë²ˆì§¸ ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤
            setTimeout(() => {
                const nameInput = document.getElementById(`editName_${index}`);
                if (nameInput) nameInput.focus();
            }, 100);
        }

        // ì¸ì› í¸ì§‘ ì·¨ì†Œ
        function cancelPersonEdit() {
            editingPersonIndex = null;
            renderPersonList();
        }

        // í‚¤ë³´ë“œ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ (Enter: ì €ì¥, Escape: ì·¨ì†Œ)
        function handleEditKeydown(event, index) {
            if (event.key === 'Enter') {
                event.preventDefault();
                savePersonEdit(index);
            } else if (event.key === 'Escape') {
                event.preventDefault();
                cancelPersonEdit();
            }
        }

        // ì‚­ì œ í™•ì¸
        function confirmRemovePerson(index) {
            event.stopPropagation(); // ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸ ë°©ì§€
            const name = people[index].name;
            if (confirm(`${name}ë‹˜ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                people.splice(index, 1);
                editingPersonIndex = null;
                renderPersonList();
                markPeopleModified();
                showMessage(`${name}ë‹˜ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
            }
        }

        // ì¸ì› í¸ì§‘ ì €ì¥
        function savePersonEdit(index) {
            const person = people[index];

            const newName = document.getElementById(`editName_${index}`).value.trim();
            const newTeam = document.getElementById(`editTeam_${index}`).value;
            const newPreferredStr = document.getElementById(`editPreferred_${index}`).value.trim();
            const newVacationStr = document.getElementById(`editVacation_${index}`).value.trim();

            // ìœ íš¨ì„± ê²€ì‚¬
            if (!newName) {
                showMessage('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            // ì¤‘ë³µ ì´ë¦„ ì²´í¬ (ìê¸° ìì‹  ì œì™¸)
            if (people.some((p, i) => i !== index && p.name === newName)) {
                showMessage('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì´ë¦„ì…ë‹ˆë‹¤.', 'error');
                return;
            }

            // ë°ì´í„° ì—…ë°ì´íŠ¸
            person.name = newName;
            person.team = newTeam;
            person.preferredWeeks = newPreferredStr ? newPreferredStr.split(',').map(w => parseInt(w.trim())).filter(w => !isNaN(w)) : [];
            person.vacationWeeks = newVacationStr ? newVacationStr.split(',').map(w => parseInt(w.trim())).filter(w => !isNaN(w)) : [];

            editingPersonIndex = null;
            renderPersonList();
            markPeopleModified();
            showMessage(`${person.name}ë‹˜ì˜ ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
        }

        // í˜¼í•©íŒ€ ì£¼ì°¨ ì„¤ì • ì—…ë°ì´íŠ¸
        function updateMixedWeekSettings() {
            const totalWeeks = parseInt(document.getElementById('totalWeeks').value) || 12;
            const container = document.getElementById('mixedWeekSettings');

            let html = '';
            for (let week = 1; week <= totalWeeks; week++) {
                const checked = mixedTeamWeeks.has(week) ? 'checked' : '';
                html += `
                    <div class="week-setting-row">
                        <input type="checkbox" id="mixedWeek_${week}" ${checked} onchange="toggleMixedWeek(${week})">
                        <label for="mixedWeek_${week}" style="margin: 0; font-weight: normal;">${week}ì£¼ì°¨</label>
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        // í˜¼í•©íŒ€ ì£¼ì°¨ í† ê¸€
        function toggleMixedWeek(week) {
            if (mixedTeamWeeks.has(week)) {
                mixedTeamWeeks.delete(week);
            } else {
                mixedTeamWeeks.add(week);
            }
        }

        // ì¸ì› ë³€ê²½ í‘œì‹œ
        function markPeopleModified() {
            if (schedule) {
                peopleModifiedAfterSchedule = true;
                updateScheduleWarning();
            }
        }

        function updateScheduleWarning() {
            const warningEl = document.getElementById('scheduleWarning');
            if (warningEl) {
                warningEl.style.display = peopleModifiedAfterSchedule ? 'block' : 'none';
            }
        }

        // ìŠ¤ì¼€ì¤„ ìƒì„±
        function generateSchedule() {
            if (people.length === 0) {
                showMessage('ì¸ì›ì„ ë¨¼ì € ì¶”ê°€í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            const totalWeeks = parseInt(document.getElementById('totalWeeks').value) || 12;
            const peoplePerWeek = parseInt(document.getElementById('peoplePerWeek').value) || 2;
            const minGap = parseInt(document.getElementById('minGap').value) || 4;
            const maxDutyPerPerson = parseInt(document.getElementById('maxDutyPerPerson').value) || 2;

            // ì¸ì› ìˆ˜ í™•ì¸
            if (people.length < peoplePerWeek) {
                showMessage(`ì¸ì›ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. ì£¼ë‹¹ ${peoplePerWeek}ëª…ì´ í•„ìš”í•œë° ${people.length}ëª…ë§Œ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤.`, 'error');
                return;
            }

            // ì¹´ìš´íŠ¸ ì´ˆê¸°í™”
            people.forEach(p => p.dutyCount = 0);

            schedule = [];
            let success = true;
            let attempts = 0;
            const maxAttempts = 100;
            let failureReason = '';

            while (attempts < maxAttempts) {
                attempts++;
                schedule = [];
                people.forEach(p => p.dutyCount = 0);
                success = true;
                failureReason = '';

                for (let week = 1; week <= totalWeeks; week++) {
                    const isMixedWeek = mixedTeamWeeks.has(week);
                    const assigned = [];

                    if (isMixedWeek && peoplePerWeek >= 2) {
                        // í˜¼í•©íŒ€: AíŒ€ 1ëª… + BíŒ€ 1ëª… + ë‚˜ë¨¸ì§€
                        const teamAMember = selectPerson(week, 'A', assigned, minGap, maxDutyPerPerson);
                        if (!teamAMember) {
                            success = false;
                            failureReason = `${week}ì£¼ì°¨: AíŒ€ì—ì„œ ë°°ì • ê°€ëŠ¥í•œ ì¸ì›ì´ ì—†ìŠµë‹ˆë‹¤.`;
                            break;
                        }
                        assigned.push(teamAMember);
                        teamAMember.dutyCount++;

                        const teamBMember = selectPerson(week, 'B', assigned, minGap, maxDutyPerPerson);
                        if (!teamBMember) {
                            success = false;
                            failureReason = `${week}ì£¼ì°¨: BíŒ€ì—ì„œ ë°°ì • ê°€ëŠ¥í•œ ì¸ì›ì´ ì—†ìŠµë‹ˆë‹¤.`;
                            break;
                        }
                        assigned.push(teamBMember);
                        teamBMember.dutyCount++;

                        // ë‚˜ë¨¸ì§€ ì¸ì› (í•„ìš”ì‹œ)
                        for (let i = 2; i < peoplePerWeek; i++) {
                            const member = selectPerson(week, null, assigned, minGap, maxDutyPerPerson);
                            if (!member) {
                                success = false;
                                failureReason = `${week}ì£¼ì°¨: ì¶”ê°€ ì¸ì›ì„ ë°°ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`;
                                break;
                            }
                            assigned.push(member);
                            member.dutyCount++;
                        }
                    } else {
                        // ì¼ë°˜: íŒ€ ìƒê´€ì—†ì´ ë°°ì •
                        for (let i = 0; i < peoplePerWeek; i++) {
                            const member = selectPerson(week, null, assigned, minGap, maxDutyPerPerson);
                            if (!member) {
                                success = false;
                                failureReason = `${week}ì£¼ì°¨: ${i + 1}ë²ˆì§¸ ì¸ì›ì„ ë°°ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`;
                                break;
                            }
                            assigned.push(member);
                            member.dutyCount++;
                        }
                    }

                    if (!success) break;

                    schedule.push({
                        week: week,
                        assigned: assigned.map(p => p.name),
                        isMixed: isMixedWeek
                    });
                }

                if (success) break;
            }

            if (!success) {
                let errorMsg = 'ë‹¹ì§í‘œ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\n';
                if (failureReason) {
                    errorMsg += `âŒ ${failureReason}\n\n`;
                }
                errorMsg += `ğŸ’¡ í•´ê²° ë°©ë²•:\n`;
                errorMsg += `- 1ì¸ë‹¹ ìµœëŒ€ íšŸìˆ˜ë¥¼ ëŠ˜ë ¤ì£¼ì„¸ìš”\n`;
                errorMsg += `- ìµœì†Œ ê°„ê²©ì„ ì¤„ì—¬ì£¼ì„¸ìš”\n`;
                errorMsg += `- ì¸ì›ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”\n`;
                errorMsg += `- íœ´ê°€ ì£¼ì°¨ë¥¼ ì¡°ì •í•´ì£¼ì„¸ìš”\n\n`;
                errorMsg += `(${attempts}ë²ˆ ì‹œë„)`;

                alert(errorMsg);
                showMessage('ë‹¹ì§í‘œ ìƒì„± ì‹¤íŒ¨', 'error');
                return;
            }

            peopleModifiedAfterSchedule = false;
            updateScheduleWarning();

            // ë‹¨ì¼ ìŠ¤ì¼€ì¤„ ìƒì„±ì‹œ ë„¤ë¹„ê²Œì´ì…˜ ìˆ¨ê¸°ê¸°
            schedules = [schedule];
            currentScheduleIndex = 0;
            updateScheduleNavigation();

            showMessage(`ë‹¹ì§í‘œê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤! (${attempts}ë²ˆ ì‹œë„)`, 'success');
            renderScheduleGrid();
            renderStatistics();
        }

        // ì—¬ëŸ¬ ìŠ¤ì¼€ì¤„ ìƒì„± (5ê°œ)
        function generateMultipleSchedules() {
            if (people.length === 0) {
                showMessage('ì¸ì›ì„ ë¨¼ì € ì¶”ê°€í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            const totalWeeks = parseInt(document.getElementById('totalWeeks').value) || 12;
            const peoplePerWeek = parseInt(document.getElementById('peoplePerWeek').value) || 2;
            const minGap = parseInt(document.getElementById('minGap').value) || 4;
            const maxDutyPerPerson = parseInt(document.getElementById('maxDutyPerPerson').value) || 2;

            if (people.length < peoplePerWeek) {
                showMessage(`ì¸ì›ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. ì£¼ë‹¹ ${peoplePerWeek}ëª…ì´ í•„ìš”í•œë° ${people.length}ëª…ë§Œ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤.`, 'error');
                return;
            }

            schedules = [];
            let attempts = 0;
            const maxTotalAttempts = 500;

            while (schedules.length < 5 && attempts < maxTotalAttempts) {
                attempts++;

                // ì¹´ìš´íŠ¸ ì´ˆê¸°í™”
                people.forEach(p => p.dutyCount = 0);

                let tempSchedule = [];
                let success = true;

                for (let week = 1; week <= totalWeeks; week++) {
                    const isMixedWeek = mixedTeamWeeks.has(week);
                    const assigned = [];

                    if (isMixedWeek && peoplePerWeek >= 2) {
                        const teamAMember = selectPerson(week, 'A', assigned, minGap, maxDutyPerPerson, tempSchedule);
                        if (!teamAMember) { success = false; break; }
                        assigned.push(teamAMember);
                        teamAMember.dutyCount++;

                        const teamBMember = selectPerson(week, 'B', assigned, minGap, maxDutyPerPerson, tempSchedule);
                        if (!teamBMember) { success = false; break; }
                        assigned.push(teamBMember);
                        teamBMember.dutyCount++;

                        for (let i = 2; i < peoplePerWeek; i++) {
                            const member = selectPerson(week, null, assigned, minGap, maxDutyPerPerson, tempSchedule);
                            if (!member) { success = false; break; }
                            assigned.push(member);
                            member.dutyCount++;
                        }
                    } else {
                        for (let i = 0; i < peoplePerWeek; i++) {
                            const member = selectPerson(week, null, assigned, minGap, maxDutyPerPerson, tempSchedule);
                            if (!member) { success = false; break; }
                            assigned.push(member);
                            member.dutyCount++;
                        }
                    }

                    if (!success) break;

                    tempSchedule.push({
                        week: week,
                        assigned: assigned.map(p => p.name),
                        isMixed: isMixedWeek
                    });
                }

                if (success && !isDuplicateSchedule(tempSchedule)) {
                    schedules.push(tempSchedule);
                }
            }

            if (schedules.length === 0) {
                let errorMsg = 'ë‹¹ì§í‘œ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\n';
                errorMsg += `ğŸ’¡ í•´ê²° ë°©ë²•:\n`;
                errorMsg += `- 1ì¸ë‹¹ ìµœëŒ€ íšŸìˆ˜ë¥¼ ëŠ˜ë ¤ì£¼ì„¸ìš”\n`;
                errorMsg += `- ìµœì†Œ ê°„ê²©ì„ ì¤„ì—¬ì£¼ì„¸ìš”\n`;
                errorMsg += `- ì¸ì›ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”\n`;
                errorMsg += `- íœ´ê°€ ì£¼ì°¨ë¥¼ ì¡°ì •í•´ì£¼ì„¸ìš”\n\n`;
                errorMsg += `(${attempts}ë²ˆ ì‹œë„)`;
                alert(errorMsg);
                showMessage('ë‹¹ì§í‘œ ìƒì„± ì‹¤íŒ¨', 'error');
                return;
            }

            currentScheduleIndex = 0;
            schedule = schedules[0];
            recalculateCounts();

            peopleModifiedAfterSchedule = false;
            updateScheduleWarning();
            updateScheduleNavigation();

            showMessage(`${schedules.length}ê°œì˜ ë‹¹ì§í‘œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤! (${attempts}ë²ˆ ì‹œë„)`, 'success');
            renderScheduleGrid();
            renderStatistics();
        }

        // ì¤‘ë³µ ìŠ¤ì¼€ì¤„ ì²´í¬
        function isDuplicateSchedule(newSchedule) {
            for (const existingSchedule of schedules) {
                if (existingSchedule.length !== newSchedule.length) continue;

                let isDuplicate = true;
                for (let i = 0; i < newSchedule.length; i++) {
                    const newWeek = newSchedule[i];
                    const existingWeek = existingSchedule[i];

                    const newAssigned = [...newWeek.assigned].sort().join(',');
                    const existingAssigned = [...existingWeek.assigned].sort().join(',');

                    if (newAssigned !== existingAssigned) {
                        isDuplicate = false;
                        break;
                    }
                }

                if (isDuplicate) return true;
            }
            return false;
        }

        // ìŠ¤ì¼€ì¤„ ë„¤ë¹„ê²Œì´ì…˜
        function updateScheduleNavigation() {
            const navDiv = document.getElementById('scheduleNavigation');
            const indicator = document.getElementById('scheduleIndicator');

            if (schedules.length <= 1) {
                navDiv.style.display = 'none';
            } else {
                navDiv.style.display = 'block';
                indicator.textContent = `${currentScheduleIndex + 1} / ${schedules.length}`;
            }
        }

        function prevSchedule() {
            if (currentScheduleIndex > 0) {
                currentScheduleIndex--;
                schedule = schedules[currentScheduleIndex];
                recalculateCounts();
                updateScheduleNavigation();
                renderScheduleGrid();
                renderStatistics();
            }
        }

        function nextSchedule() {
            if (currentScheduleIndex < schedules.length - 1) {
                currentScheduleIndex++;
                schedule = schedules[currentScheduleIndex];
                recalculateCounts();
                updateScheduleNavigation();
                renderScheduleGrid();
                renderStatistics();
            }
        }

        // ì¸ì› ì„ íƒ
        function selectPerson(week, requiredTeam, alreadyAssigned, minGap, maxDutyPerPerson, tempSchedule = null) {
            const scheduleToCheck = tempSchedule || schedule;
            // ì„ í˜¸í•˜ëŠ” ì‚¬ëŒ ë¨¼ì €
            let candidates = people.filter(p => {
                if (alreadyAssigned.includes(p)) return false;
                if (requiredTeam && p.team !== requiredTeam) return false;
                if (p.isOnVacation(week)) return false;
                if (!p.canTakeMoreDuties(maxDutyPerPerson)) return false;
                if (!checkMinGap(p.name, week, minGap, scheduleToCheck)) return false;
                return true;
            });

            if (candidates.length === 0) return null;

            // ì„ í˜¸ ì£¼ì°¨ ë¨¼ì €
            const preferred = candidates.filter(p => p.hasPreferredWeek(week));
            if (preferred.length > 0) {
                // ì„ í˜¸ì ì¤‘ ë‹¹ì§ íšŸìˆ˜ê°€ ê°€ì¥ ì ì€ ì‚¬ëŒ
                preferred.sort((a, b) => a.dutyCount - b.dutyCount);
                // ë™ì¼í•œ íšŸìˆ˜ì¸ ê²½ìš° ëœë¤
                const minDuty = preferred[0].dutyCount;
                const best = preferred.filter(p => p.dutyCount === minDuty);
                return best[Math.floor(Math.random() * best.length)];
            }

            // ì¼ë°˜ í›„ë³´ ì¤‘ ë‹¹ì§ íšŸìˆ˜ê°€ ê°€ì¥ ì ì€ ì‚¬ëŒ
            candidates.sort((a, b) => a.dutyCount - b.dutyCount);
            const minDuty = candidates[0].dutyCount;
            const best = candidates.filter(p => p.dutyCount === minDuty);
            return best[Math.floor(Math.random() * best.length)];
        }

        // ìµœì†Œ ê°„ê²© ì²´í¬
        function checkMinGap(personName, week, minGap, scheduleToCheck = null) {
            const targetSchedule = scheduleToCheck || schedule;
            if (!targetSchedule || targetSchedule.length === 0) return true;

            for (let i = targetSchedule.length - 1; i >= 0; i--) {
                const entry = targetSchedule[i];
                if (entry.assigned.includes(personName)) {
                    const gap = week - entry.week;
                    if (gap < minGap) return false;
                    break;
                }
            }
            return true;
        }

        // ìŠ¤ì¼€ì¤„ ê·¸ë¦¬ë“œ ë Œë”ë§
        function renderScheduleGrid() {
            const gridDiv = document.getElementById('scheduleGrid');
            if (!schedule || schedule.length === 0) {
                gridDiv.innerHTML = '';
                return;
            }

            let html = '<div class="schedule-grid">';
            schedule.forEach((entry, index) => {
                const mixedClass = entry.isMixed ? 'mixed-team' : '';
                const editedClass = entry.manuallyEdited ? 'manually-edited' : '';
                const editModeClass = editingWeekIndex === index ? 'edit-mode' : '';

                let assignmentsHtml = '';
                if (editingWeekIndex === index) {
                    // í¸ì§‘ ëª¨ë“œ
                    assignmentsHtml = '<div class="edit-controls">';
                    entry.assigned.forEach((name, i) => {
                        const person = people.find(p => p.name === name);
                        assignmentsHtml += `
                            <div style="margin-bottom: 8px;">
                                <label style="font-size: 11px; margin: 0;">ë‹¹ì§ ${i + 1}</label>
                                <select id="editAssign_${index}_${i}">
                                    ${people.map(p => `<option value="${p.name}" ${p.name === name ? 'selected' : ''}>${p.name} (${p.team}íŒ€)</option>`).join('')}
                                </select>
                            </div>
                        `;
                    });
                    assignmentsHtml += `
                        <div style="margin-top: 10px;">
                            <button onclick="saveWeekEdit(${index})" style="background: #27ae60; padding: 6px 12px; font-size: 12px;">ì €ì¥</button>
                            <button onclick="cancelWeekEdit()" class="secondary" style="padding: 6px 12px; font-size: 12px;">ì·¨ì†Œ</button>
                        </div>
                    </div>`;
                } else {
                    // í‘œì‹œ ëª¨ë“œ
                    entry.assigned.forEach(name => {
                        const person = people.find(p => p.name === name);
                        const teamClass = person ? (person.team === 'A' ? 'team-a' : 'team-b') : '';
                        assignmentsHtml += `
                            <div class="assignment-person">
                                <span class="team-indicator ${teamClass}"></span>
                                ${name}
                            </div>
                        `;
                    });
                }

                const editedBadge = entry.manuallyEdited ? '<span class="manual-edit-badge">ìˆ˜ì •ë¨</span>' : '';
                const mixedBadge = entry.isMixed ? '<span class="mixed-badge">í˜¼í•©íŒ€</span>' : '';

                html += `
                    <div class="week-card ${mixedClass} ${editedClass} ${editModeClass}"
                         onclick="${editingWeekIndex === index ? '' : `editWeek(${index})`}">
                        <div class="week-header">
                            <span class="week-number">${entry.week}ì£¼ì°¨</span>
                            <span>${mixedBadge} ${editedBadge}</span>
                        </div>
                        <div class="week-assignments">
                            ${assignmentsHtml}
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            gridDiv.innerHTML = html;
        }

        // ì£¼ì°¨ í¸ì§‘
        function editWeek(index) {
            if (editingWeekIndex !== null) {
                cancelWeekEdit();
            }
            editingWeekIndex = index;
            renderScheduleGrid();
        }

        // í¸ì§‘ ì·¨ì†Œ
        function cancelWeekEdit() {
            editingWeekIndex = null;
            renderScheduleGrid();
        }

        // í¸ì§‘ ì €ì¥
        function saveWeekEdit(index) {
            const entry = schedule[index];
            const newAssigned = [];

            for (let i = 0; i < entry.assigned.length; i++) {
                const select = document.getElementById(`editAssign_${index}_${i}`);
                if (select) newAssigned.push(select.value);
            }

            // ì¤‘ë³µ ì²´í¬
            const unique = new Set(newAssigned);
            if (unique.size !== newAssigned.length) {
                showMessage('âŒ ê°™ì€ ì‚¬ëŒì´ ì—¬ëŸ¬ ë²ˆ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            // í˜¼í•©íŒ€ ê²€ì¦
            if (entry.isMixed && newAssigned.length >= 2) {
                const teams = newAssigned.slice(0, 2).map(name => {
                    const person = people.find(p => p.name === name);
                    return person ? person.team : null;
                });
                if (teams[0] === teams[1]) {
                    if (!confirm('âš ï¸ í˜¼í•©íŒ€ ì£¼ì°¨ì¸ë° ê°™ì€ íŒ€ì—ì„œ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                        return;
                    }
                }
            }

            entry.assigned = newAssigned;
            entry.manuallyEdited = true;
            editingWeekIndex = null;

            recalculateCounts();
            renderScheduleGrid();
            renderStatistics();
            showMessage(`${entry.week}ì£¼ì°¨ ë‹¹ì§ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
        }

        // ì¹´ìš´íŠ¸ ì¬ê³„ì‚°
        function recalculateCounts() {
            people.forEach(p => p.dutyCount = 0);
            if (schedule) {
                schedule.forEach(entry => {
                    entry.assigned.forEach(name => {
                        const person = people.find(p => p.name === name);
                        if (person) person.dutyCount++;
                    });
                });
            }
        }

        // í†µê³„ ë Œë”ë§
        function renderStatistics() {
            const statsDiv = document.getElementById('statistics');
            if (!schedule || schedule.length === 0) {
                statsDiv.innerHTML = '';
                return;
            }

            let html = '<div class="stats"><h3>ğŸ“Š í†µê³„</h3><div class="stats-grid">';

            const maxDuty = parseInt(document.getElementById('maxDutyPerPerson').value) || 2;

            // íŒ€ë³„ë¡œ ì •ë ¬
            const sortedPeople = [...people].sort((a, b) => {
                if (a.team !== b.team) return a.team.localeCompare(b.team);
                return a.name.localeCompare(b.name);
            });

            sortedPeople.forEach(person => {
                const isOverMax = person.dutyCount > maxDuty;
                const warningStyle = isOverMax ? 'border: 2px solid #e74c3c; background: #ffe6e6;' : '';
                const warningIcon = isOverMax ? ' âš ï¸' : '';
                const teamColor = person.team === 'A' ? '#e74c3c' : '#2ecc71';

                html += `
                    <div class="stat-item" style="${warningStyle}">
                        <strong style="color: ${teamColor};">${person.name}</strong>
                        <span class="small-text">${person.team}íŒ€</span><br>
                        <span>ë‹¹ì§: ${person.dutyCount}íšŒ${warningIcon}</span>
                    </div>
                `;
            });

            html += '</div></div>';
            statsDiv.innerHTML = html;
        }

        // ë‚´ë³´ë‚´ê¸°
        function exportSchedule() {
            if (!schedule || schedule.length === 0) {
                showMessage('ë¨¼ì € ë‹¹ì§í‘œë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            let text = 'ì£¼ë³„ ë‹¹ì§í‘œ\n\n';

            schedule.forEach(entry => {
                const mixedText = entry.isMixed ? ' [í˜¼í•©íŒ€]' : '';
                const editedText = entry.manuallyEdited ? ' [ìˆ˜ë™í¸ì§‘]' : '';
                const assignedText = entry.assigned.map(name => {
                    const person = people.find(p => p.name === name);
                    return `${name}(${person ? person.team : '?'}íŒ€)`;
                }).join(', ');

                text += `${entry.week}ì£¼ì°¨${mixedText}${editedText}: ${assignedText}\n`;
            });

            text += '\ní†µê³„:\n';
            people.forEach(person => {
                let extra = '';
                if (person.preferredWeeks.length > 0) {
                    extra += ` (ì„ í˜¸: ${person.preferredWeeks.join(',')}ì£¼)`;
                }
                if (person.vacationWeeks.length > 0) {
                    extra += ` (íœ´ê°€: ${person.vacationWeeks.join(',')}ì£¼)`;
                }
                text += `${person.name} (${person.team}íŒ€): ${person.dutyCount}íšŒ${extra}\n`;
            });

            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ì£¼ë³„ë‹¹ì§í‘œ_' + new Date().toISOString().slice(0, 10) + '.txt';
            a.click();
            URL.revokeObjectURL(url);

            showMessage('ë‹¹ì§í‘œê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }

        // ë©”ì‹œì§€ í‘œì‹œ
        function showMessage(msg, type = 'info') {
            const messagesDiv = document.getElementById('messages');
            const alertClass = type === 'error' ? 'alert-error' :
                              type === 'success' ? 'alert-success' : 'alert-info';
            messagesDiv.innerHTML = `<div class="alert ${alertClass}">${msg}</div>`;
            setTimeout(() => {
                messagesDiv.innerHTML = '';
            }, 5000);
        }

        // ì´ˆê¸°í™”
        renderPersonList();
        updateMixedWeekSettings();

        // ì´ ì£¼ ìˆ˜ ë³€ê²½ì‹œ í˜¼í•©íŒ€ ì„¤ì • ì—…ë°ì´íŠ¸
        document.getElementById('totalWeeks').addEventListener('change', updateMixedWeekSettings);
    </script>
</body>
</html>
