<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë³‘ì› ë‹¹ì§í‘œ ìƒì„±ê¸°</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }

        h2 {
            color: #34495e;
            margin-top: 30px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }


        .input-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .result-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* ì¸ì› ëª©ë¡ ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ */
        #personList {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 12px;
            margin-top: 15px;
        }

        #personList > h3 {
            grid-column: 1 / -1;
            margin: 0 0 10px 0;
            font-size: 18px;
        }

        .person-entry {
            background: white;
            padding: 12px;
            border-radius: 5px;
            border-left: 4px solid #3498db;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: box-shadow 0.2s;
        }

        .person-entry:hover {
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }

        .person-entry h3 {
            margin: 0 0 8px 0;
            color: #2c3e50;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .person-compact-info {
            font-size: 12px;
            color: #666;
            line-height: 1.5;
        }

        .person-compact-info strong {
            color: #2c3e50;
            font-weight: 600;
        }

        label {
            display: block;
            margin: 8px 0 4px 0;
            font-weight: 500;
            color: #555;
            font-size: 14px;
        }

        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 5px 0;
        }

        .checkbox-group label {
            display: inline-flex;
            align-items: center;
            margin: 0;
            font-weight: normal;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-right: 5px;
        }

        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background 0.3s;
            margin: 5px;
        }

        button:hover {
            background: #2980b9;
        }

        button.secondary {
            background: #95a5a6;
        }

        button.secondary:hover {
            background: #7f8c8d;
        }

        button.danger {
            background: #e74c3c;
        }

        button.danger:hover {
            background: #c0392b;
        }

        .button-group {
            text-align: center;
            margin: 20px 0;
        }

        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            margin-top: 20px;
            background: #ddd;
            border-radius: 8px;
            overflow: hidden;
        }

        .calendar-header-row {
            display: contents;
        }

        .calendar-day-header {
            background: #34495e;
            color: white;
            padding: 10px;
            text-align: center;
            font-weight: 600;
            font-size: 13px;
        }

        .calendar-day-header.sunday {
            background: #c0392b;
        }

        .calendar-day-header.saturday {
            background: #2980b9;
        }

        .calendar-day {
            border: none;
            padding: 10px;
            border-radius: 0;
            background: white;
            min-height: 90px;
            position: relative;
        }

        .calendar-day.empty {
            background: #f5f5f5;
        }

        .calendar-day.weekend {
            background: #f8f9fa;
        }

        .calendar-day.sunday {
            background: #fff5f5;
        }

        .calendar-day.saturday {
            background: #f5f8ff;
        }

        .calendar-day.holiday {
            background: #fff0f0;
        }

        .calendar-day.week1 { }
        .calendar-day.week2 { }
        .calendar-day.week3 { }
        .calendar-day.week4 { }

        .holiday-name {
            position: absolute;
            top: 2px;
            right: 3px;
            font-size: 9px;
            color: #c0392b;
            font-weight: 600;
            max-width: 80%;
            text-align: right;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .day-number-display {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .day-number-display.sunday {
            color: #c0392b;
        }

        .day-number-display.saturday {
            color: #2980b9;
        }

        .day-number-display.holiday {
            color: #c0392b;
        }

        .preview-calendar {
            margin-top: 15px;
        }

        .preview-calendar .calendar-day {
            min-height: 60px;
            cursor: default;
        }

        .preview-calendar .day-info {
            font-size: 10px;
            color: #888;
            margin-top: 3px;
        }

        .day-header {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 8px;
            padding-bottom: 5px;
            border-bottom: 2px solid #e0e0e0;
        }

        .day-number {
            font-size: 18px;
            color: #3498db;
        }

        .duty-assignment {
            margin: 5px 0;
            font-size: 14px;
        }

        .duty-primary {
            color: #e74c3c;
            font-weight: 600;
        }

        .duty-secondary {
            color: #3498db;
            font-weight: 500;
        }

        .stats {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .stat-item {
            background: white;
            padding: 10px;
            border-radius: 4px;
            border-left: 3px solid #3498db;
        }

        .alert {
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }

        .alert-error {
            background: #fee;
            border-left: 4px solid #e74c3c;
            color: #c0392b;
        }

        .alert-success {
            background: #efe;
            border-left: 4px solid #27ae60;
            color: #229954;
        }

        .alert-info {
            background: #eff;
            border-left: 4px solid #3498db;
            color: #2471a3;
        }

        .small-text {
            font-size: 12px;
            color: #7f8c8d;
            font-style: italic;
        }

        .add-person-form {
            background: #e8f4f8;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .preference-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 12px;
            margin-left: 5px;
        }

        .badge-2nd-preferred {
            background: #d4edda;
            color: #155724;
        }

        .badge-2nd-limited {
            background: #fff3cd;
            color: #856404;
        }

        .badge-vacation {
            background: #f8d7da;
            color: #721c24;
        }

        .vacation-indicator {
            background: #f8d7da;
            color: #721c24;
            padding: 5px;
            border-radius: 3px;
            font-size: 12px;
            margin-top: 5px;
            font-weight: 600;
        }

        .vacation-form {
            background: #fff3cd;
            padding: 8px;
            border-radius: 4px;
            margin-top: 8px;
            border-left: 3px solid #ffc107;
        }

        .vacation-list {
            margin-top: 6px;
        }

        .vacation-item {
            background: #f8f9fa;
            padding: 4px 8px;
            margin: 3px 0;
            border-radius: 3px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
        }

        .vacation-item button {
            padding: 2px 6px !important;
            font-size: 10px !important;
            margin: 0 !important;
        }

        .day-range-input {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 5px;
            align-items: center;
        }

        .day-range-input input {
            width: 100%;
        }

        .calendar-day.editable {
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .calendar-day.editable:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .calendar-day.manually-edited {
            border: 2px solid #f39c12;
            position: relative;
        }

        .manual-edit-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #f39c12;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
        }

        .edit-mode {
            background: #fff9e6 !important;
            border: 2px solid #3498db !important;
        }

        .edit-controls {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #ddd;
        }

        .edit-controls select {
            width: 100%;
            margin: 5px 0;
            padding: 5px;
            font-size: 13px;
        }

        .edit-controls button {
            padding: 5px 10px;
            font-size: 12px;
            margin: 3px;
        }

        /* ì ‘ê¸°/í¼ì¹˜ê¸° ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
        .collapsible-section {
            margin-top: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow: hidden;
        }

        .collapsible-header {
            background: #f8f9fa;
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            transition: background 0.2s;
        }

        .collapsible-header:hover {
            background: #e9ecef;
        }

        .collapsible-header h4 {
            margin: 0;
            font-size: 14px;
            font-weight: 600;
            color: #2c3e50;
        }

        .collapsible-toggle {
            font-size: 18px;
            font-weight: bold;
            color: #6c757d;
            transition: transform 0.3s;
        }

        .collapsible-toggle.expanded {
            transform: rotate(180deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .collapsible-content.expanded {
            max-height: 2000px;
            transition: max-height 0.5s ease-in;
        }

        .collapsible-body {
            padding: 15px;
            background: white;
        }

        /* ì»´íŒ©íŠ¸í•œ ì£¼ë³„ ì œì•½ ë ˆì´ì•„ì›ƒ */
        .week-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .week-item {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
        }

        .week-item strong {
            display: block;
            margin-bottom: 5px;
            font-size: 12px;
        }

        /* ê°„ê²°í•œ í¼ ë ˆì´ì•„ì›ƒ */
        .compact-form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .compact-form-grid label {
            font-size: 13px;
            margin: 3px 0;
        }

        .compact-form-grid input,
        .compact-form-grid select {
            padding: 6px;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <h1>ğŸ¥ ë³‘ì› ë‹¹ì§í‘œ ìë™ ìƒì„±ê¸°</h1>

    <div class="container">
            <!-- Input Section -->
            <div class="input-section">
                <h2>ğŸ“‹ ì¸ì› ê´€ë¦¬</h2>

            <div class="add-person-form">
                <h3>ìƒˆ ì¸ì› ì¶”ê°€</h3>

                <div class="compact-form-grid">
                    <div>
                        <label>ì´ë¦„</label>
                        <input type="text" id="newPersonName" placeholder="ì´ë¦„ ì…ë ¥">
                    </div>
                    <div>
                        <label>ìµœëŒ€ ë‹¹ì§ íšŸìˆ˜</label>
                        <input type="number" id="newPersonMaxDuties" value="5" min="0" max="20">
                    </div>
                </div>

                <div style="margin-top: 10px;">
                    <label>2nd Duty ì„ í˜¸ë„</label>
                    <select id="newPersonSecondDutyPref">
                        <option value="normal">ì¼ë°˜</option>
                        <option value="preferred">ì„ í˜¸ (ë¬´ì œí•œ)</option>
                        <option value="limited">ì œí•œì  (1íšŒë§Œ)</option>
                        <option value="2nd-only">2nd dutyë§Œ</option>
                    </select>
                </div>

                <div style="margin-top: 10px;">
                    <label>ë¶ˆê°€ëŠ¥í•œ ìš”ì¼ (ë‹¹ì§)</label>
                    <div class="checkbox-group">
                        <label><input type="checkbox" value="ì›”" class="new-unavailable-day"> ì›”</label>
                        <label><input type="checkbox" value="í™”" class="new-unavailable-day"> í™”</label>
                        <label><input type="checkbox" value="ìˆ˜" class="new-unavailable-day"> ìˆ˜</label>
                        <label><input type="checkbox" value="ëª©" class="new-unavailable-day"> ëª©</label>
                        <label><input type="checkbox" value="ê¸ˆ" class="new-unavailable-day"> ê¸ˆ</label>
                    </div>
                </div>

                <div style="margin-top: 10px;">
                    <label>ëŒ€ì²´ ê°€ëŠ¥ ìš”ì¼ (2nd dutyë¡œ ê°€ëŠ¥)</label>
                    <div class="checkbox-group">
                        <label><input type="checkbox" value="ì›”" class="new-alternative-day"> ì›”</label>
                        <label><input type="checkbox" value="í™”" class="new-alternative-day"> í™”</label>
                        <label><input type="checkbox" value="ìˆ˜" class="new-alternative-day"> ìˆ˜</label>
                        <label><input type="checkbox" value="ëª©" class="new-alternative-day"> ëª©</label>
                        <label><input type="checkbox" value="ê¸ˆ" class="new-alternative-day"> ê¸ˆ</label>
                    </div>
                </div>

                <!-- ì£¼ë³„ ì œì•½ ì ‘ê¸°/í¼ì¹˜ê¸° ì„¹ì…˜ -->
                <div class="collapsible-section">
                    <div class="collapsible-header" onclick="toggleCollapsible('newPersonWeekly')">
                        <h4>ğŸ“… ì£¼ë³„ ì œì•½ (ì„ íƒì‚¬í•­)</h4>
                        <span class="collapsible-toggle" id="toggle-newPersonWeekly">â–¼</span>
                    </div>
                    <div class="collapsible-content" id="content-newPersonWeekly">
                        <div class="collapsible-body">
                            <p class="small-text" style="margin: 0 0 10px 0;">ê° ì£¼ì°¨ë³„ë¡œ ë‹¤ë¥¸ ë¶ˆê°€ëŠ¥í•œ ìš”ì¼ì„ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                            <div class="week-grid">
                        <!-- 1ì£¼ì°¨ -->
                        <div style="background: white; padding: 10px; border-radius: 4px;">
                            <strong style="font-size: 13px; color: #e74c3c;">1ì£¼ì°¨</strong>
                            <div style="margin-top: 5px;">
                                <label style="font-size: 11px; margin: 3px 0;">ë¶ˆê°€ëŠ¥</label>
                                <div class="checkbox-group">
                                    <label style="font-size: 12px;"><input type="checkbox" value="ì›”" class="new-week1-unavailable"> ì›”</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="í™”" class="new-week1-unavailable"> í™”</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="ìˆ˜" class="new-week1-unavailable"> ìˆ˜</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="ëª©" class="new-week1-unavailable"> ëª©</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="ê¸ˆ" class="new-week1-unavailable"> ê¸ˆ</label>
                                </div>
                                <label style="font-size: 11px; margin: 3px 0;">2nd ê°€ëŠ¥</label>
                                <div class="checkbox-group">
                                    <label style="font-size: 12px;"><input type="checkbox" value="ì›”" class="new-week1-alternative"> ì›”</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="í™”" class="new-week1-alternative"> í™”</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="ìˆ˜" class="new-week1-alternative"> ìˆ˜</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="ëª©" class="new-week1-alternative"> ëª©</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="ê¸ˆ" class="new-week1-alternative"> ê¸ˆ</label>
                                </div>
                            </div>
                        </div>

                        <!-- 2ì£¼ì°¨ -->
                        <div style="background: white; padding: 10px; border-radius: 4px;">
                            <strong style="font-size: 13px; color: #3498db;">2ì£¼ì°¨</strong>
                            <div style="margin-top: 5px;">
                                <label style="font-size: 11px; margin: 3px 0;">ë¶ˆê°€ëŠ¥</label>
                                <div class="checkbox-group">
                                    <label style="font-size: 12px;"><input type="checkbox" value="ì›”" class="new-week2-unavailable"> ì›”</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="í™”" class="new-week2-unavailable"> í™”</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="ìˆ˜" class="new-week2-unavailable"> ìˆ˜</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="ëª©" class="new-week2-unavailable"> ëª©</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="ê¸ˆ" class="new-week2-unavailable"> ê¸ˆ</label>
                                </div>
                                <label style="font-size: 11px; margin: 3px 0;">2nd ê°€ëŠ¥</label>
                                <div class="checkbox-group">
                                    <label style="font-size: 12px;"><input type="checkbox" value="ì›”" class="new-week2-alternative"> ì›”</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="í™”" class="new-week2-alternative"> í™”</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="ìˆ˜" class="new-week2-alternative"> ìˆ˜</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="ëª©" class="new-week2-alternative"> ëª©</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="ê¸ˆ" class="new-week2-alternative"> ê¸ˆ</label>
                                </div>
                            </div>
                        </div>

                        <!-- 3ì£¼ì°¨ -->
                        <div style="background: white; padding: 10px; border-radius: 4px;">
                            <strong style="font-size: 13px; color: #27ae60;">3ì£¼ì°¨</strong>
                            <div style="margin-top: 5px;">
                                <label style="font-size: 11px; margin: 3px 0;">ë¶ˆê°€ëŠ¥</label>
                                <div class="checkbox-group">
                                    <label style="font-size: 12px;"><input type="checkbox" value="ì›”" class="new-week3-unavailable"> ì›”</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="í™”" class="new-week3-unavailable"> í™”</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="ìˆ˜" class="new-week3-unavailable"> ìˆ˜</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="ëª©" class="new-week3-unavailable"> ëª©</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="ê¸ˆ" class="new-week3-unavailable"> ê¸ˆ</label>
                                </div>
                                <label style="font-size: 11px; margin: 3px 0;">2nd ê°€ëŠ¥</label>
                                <div class="checkbox-group">
                                    <label style="font-size: 12px;"><input type="checkbox" value="ì›”" class="new-week3-alternative"> ì›”</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="í™”" class="new-week3-alternative"> í™”</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="ìˆ˜" class="new-week3-alternative"> ìˆ˜</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="ëª©" class="new-week3-alternative"> ëª©</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="ê¸ˆ" class="new-week3-alternative"> ê¸ˆ</label>
                                </div>
                            </div>
                        </div>

                        <!-- 4ì£¼ì°¨ -->
                        <div style="background: white; padding: 10px; border-radius: 4px;">
                            <strong style="font-size: 13px; color: #f39c12;">4ì£¼ì°¨</strong>
                            <div style="margin-top: 5px;">
                                <label style="font-size: 11px; margin: 3px 0;">ë¶ˆê°€ëŠ¥</label>
                                <div class="checkbox-group">
                                    <label style="font-size: 12px;"><input type="checkbox" value="ì›”" class="new-week4-unavailable"> ì›”</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="í™”" class="new-week4-unavailable"> í™”</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="ìˆ˜" class="new-week4-unavailable"> ìˆ˜</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="ëª©" class="new-week4-unavailable"> ëª©</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="ê¸ˆ" class="new-week4-unavailable"> ê¸ˆ</label>
                                </div>
                                <label style="font-size: 11px; margin: 3px 0;">2nd ê°€ëŠ¥</label>
                                <div class="checkbox-group">
                                    <label style="font-size: 12px;"><input type="checkbox" value="ì›”" class="new-week4-alternative"> ì›”</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="í™”" class="new-week4-alternative"> í™”</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="ìˆ˜" class="new-week4-alternative"> ìˆ˜</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="ëª©" class="new-week4-alternative"> ëª©</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="ê¸ˆ" class="new-week4-alternative"> ê¸ˆ</label>
                                </div>
                            </div>
                        </div>
                    </div>
                        </div>
                    </div>
                </div>

                <!-- ì„ í˜¸ ë‚ ì§œ ì ‘ê¸°/í¼ì¹˜ê¸° ì„¹ì…˜ -->
                <div class="collapsible-section">
                    <div class="collapsible-header" onclick="toggleCollapsible('newPersonPreferred')">
                        <h4>â­ ì„ í˜¸ ë‹¹ì§ ë‚ ì§œ (ì„ íƒì‚¬í•­)</h4>
                        <span class="collapsible-toggle" id="toggle-newPersonPreferred">â–¼</span>
                    </div>
                    <div class="collapsible-content" id="content-newPersonPreferred">
                        <div class="collapsible-body">
                            <p class="small-text" style="margin: 0 0 10px 0;">íŠ¹ì • ë‚ ì§œì— ë‹¹ì§ ë˜ëŠ” 2nd ë‹¹ì§ìœ¼ë¡œ ìš°ì„  ë°°ì •ë©ë‹ˆë‹¤.</p>
                            <div id="newPersonPreferredDuties" style="margin-top: 10px;">
                                <!-- Preferred duty entries will be added here -->
                            </div>
                            <button type="button" onclick="addNewPreferredDutyField()" style="padding: 5px 10px; font-size: 12px; margin-top: 10px; background: #f39c12; color: white; border: none; border-radius: 3px; cursor: pointer;">â• ì„ í˜¸ ë‚ ì§œ ì¶”ê°€</button>
                        </div>
                    </div>
                </div>

                <!-- íœ´ê°€ ì ‘ê¸°/í¼ì¹˜ê¸° ì„¹ì…˜ -->
                <div class="collapsible-section">
                    <div class="collapsible-header" onclick="toggleCollapsible('newPersonVacation')">
                        <h4>ğŸ–ï¸ íœ´ê°€ (ì„ íƒì‚¬í•­)</h4>
                        <span class="collapsible-toggle" id="toggle-newPersonVacation">â–¼</span>
                    </div>
                    <div class="collapsible-content" id="content-newPersonVacation">
                        <div class="collapsible-body">
                            <p class="small-text" style="margin: 0 0 10px 0;">íœ´ê°€ ê¸°ê°„ ë™ì•ˆì€ ë‹¹ì§ ë° 2nd ë‹¹ì§ì—ì„œ ì œì™¸ë©ë‹ˆë‹¤.</p>
                            <div id="newPersonVacations" style="margin-top: 10px;">
                                <!-- Vacation entries will be added here -->
                            </div>
                            <button type="button" onclick="addNewVacationField()" style="padding: 5px 10px; font-size: 12px; margin-top: 10px; background: #27ae60; color: white; border: none; border-radius: 3px; cursor: pointer;">â• íœ´ê°€ ì¶”ê°€</button>
                        </div>
                    </div>
                </div>

                <div class="button-group">
                    <button onclick="addPerson()">â• ì¸ì› ì¶”ê°€</button>
                </div>
            </div>

            <div id="personList"></div>

            <div class="button-group">
                <button onclick="loadSampleData()">ğŸ“ ì˜ˆì‹œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</button>
                <button onclick="downloadJSON()" style="background: #16a085;">ğŸ“¥ ì‚¬ëŒ ì •ë³´ ì €ì¥</button>
                <button onclick="document.getElementById('jsonFileInput').click()" style="background: #e67e22;">ğŸ“¤ ì‚¬ëŒ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                <input type="file" id="jsonFileInput" accept=".json" style="display: none;" onchange="uploadJSON(event)">
                <button onclick="clearAllData()" class="danger">ğŸ—‘ï¸ ì „ì²´ ì‚­ì œ</button>
            </div>
        </div>

        <!-- Result Section -->
        <div class="result-section">
            <h2>ğŸ“… ë‹¹ì§í‘œ</h2>

            <!-- ì›” ì„ íƒ ë° ìº˜ë¦°ë” ë¯¸ë¦¬ë³´ê¸° -->
            <div style="background: #f0f8ff; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                <label style="font-size: 14px; font-weight: 600; color: #2c3e50; margin-bottom: 8px; display: block;">ğŸ“† ëŒ€ìƒ ì›” ì„ íƒ</label>
                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <input type="month" id="targetMonthInput" style="padding: 8px; font-size: 14px;" onchange="updateTargetMonth()">
                    <button onclick="prevMonth()" class="secondary" style="padding: 8px 12px;">â—€ ì´ì „ë‹¬</button>
                    <button onclick="nextMonth()" class="secondary" style="padding: 8px 12px;">ë‹¤ìŒë‹¬ â–¶</button>
                    <span id="monthInfoDisplay" style="font-size: 13px; color: #666;"></span>
                </div>
                <div id="previewCalendar" class="preview-calendar"></div>
            </div>

            <!-- ë‹¹ì§ ì¸ì› ì„¤ì • -->
            <div style="background: #fff5f0; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                <label style="font-size: 14px; font-weight: 600; color: #2c3e50; margin-bottom: 8px; display: block;">ğŸ‘¥ ì¼ë³„ ë‹¹ì§ ì¸ì› ì„¤ì •</label>
                <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <label style="font-size: 13px; margin: 0;">ğŸ”´ ë‹¹ì§:</label>
                        <input type="number" id="primaryCountPerDayInput" value="1" min="1" max="10" style="width: 60px; padding: 6px; font-size: 14px;" onchange="updateDutyCountSettings()">
                        <span style="font-size: 13px; color: #666;">ëª…</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <label style="font-size: 13px; margin: 0;">ğŸ”µ 2nd ë‹¹ì§:</label>
                        <input type="number" id="secondaryCountPerDayInput" value="1" min="0" max="10" style="width: 60px; padding: 6px; font-size: 14px;" onchange="updateDutyCountSettings()">
                        <span style="font-size: 13px; color: #666;">ëª…</span>
                    </div>
                    <span id="dutyCountDisplay" style="font-size: 12px; color: #888;">(ì¼ë³„ ì´ 2ëª…)</span>
                </div>
            </div>

            <div id="scheduleWarning" class="alert alert-error" style="display: none; font-size: 13px; margin-bottom: 10px;">
                âš ï¸ <strong>ì‚¬ëŒ ì •ë³´ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.</strong> ë³€ê²½ëœ ì •ë³´ë¥¼ ë°˜ì˜í•˜ë ¤ë©´ ë‹¹ì§í‘œë¥¼ ë‹¤ì‹œ ìƒì„±í•´ì£¼ì„¸ìš”.
            </div>

            <div class="button-group">
                <button onclick="generateSchedule()">ğŸ¯ ë‹¹ì§í‘œ ìƒì„±</button>
                <button onclick="generateMultipleSchedules()">ğŸ”„ ì—¬ëŸ¬ ê²½ìš° ìƒì„± (5ê°œ)</button>
                <button onclick="exportSchedule()" class="secondary">ğŸ’¾ ë‚´ë³´ë‚´ê¸°</button>
            </div>

            <div id="scheduleNavigation" style="display: none; text-align: center; margin: 15px 0; padding: 10px; background: #f0f8ff; border-radius: 5px;">
                <button onclick="previousSchedule()" class="secondary">â—€ ì´ì „</button>
                <span id="scheduleInfo" style="margin: 0 20px; font-weight: 600; color: #2c3e50;">1 / 1</span>
                <button onclick="nextSchedule()" class="secondary">ë‹¤ìŒ â–¶</button>
            </div>

            <div class="alert alert-info" style="font-size: 13px;">
                ğŸ’¡ <strong>íŒ:</strong> ë‹¹ì§í‘œ ìƒì„± í›„ ê° ë‚ ì§œë¥¼ í´ë¦­í•˜ë©´ ë‹¹ì§ìë¥¼ ìˆ˜ë™ìœ¼ë¡œ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìˆ˜ë™ í¸ì§‘ëœ ë‚ ì§œëŠ” ì£¼í™©ìƒ‰ í…Œë‘ë¦¬ë¡œ í‘œì‹œë©ë‹ˆë‹¤.
            </div>

            <div id="messages"></div>
            <div id="calendar"></div>
            <div id="statistics"></div>
        </div>
    </div>

    <script>
        // Global data
        let people = [];
        let schedule = null;
        let schedules = []; // Multiple schedules storage
        let currentScheduleIndex = 0; // Current schedule being viewed
        let startDate = null; // Day1ì˜ ì‹œì‘ ë‚ ì§œ (Date ê°ì²´)
        let peopleModifiedAfterSchedule = false; // ë‹¹ì§í‘œ ìƒì„± í›„ ì‚¬ëŒ ì •ë³´ ë³€ê²½ ì—¬ë¶€
        const DAYS_OF_WEEK = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ'];
        const DAYS_OF_WEEK_FULL = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
        const TOTAL_DAYS = 20;
        const WEEKS = 4;

        // ì›”ë³„ ìº˜ë¦°ë” ê´€ë ¨
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth() + 1;

        // ëŒ€í•œë¯¼êµ­ ê³µíœ´ì¼ ë°ì´í„° (2024-2026)
        const KOREAN_HOLIDAYS = {
            // 2024ë…„
            '2024-01-01': 'ì‹ ì •',
            '2024-02-09': 'ì„¤ë‚  ì—°íœ´',
            '2024-02-10': 'ì„¤ë‚ ',
            '2024-02-11': 'ì„¤ë‚  ì—°íœ´',
            '2024-02-12': 'ëŒ€ì²´ê³µíœ´ì¼',
            '2024-03-01': 'ì‚¼ì¼ì ˆ',
            '2024-04-10': 'êµ­íšŒì˜ì›ì„ ê±°ì¼',
            '2024-05-05': 'ì–´ë¦°ì´ë‚ ',
            '2024-05-06': 'ëŒ€ì²´ê³µíœ´ì¼',
            '2024-05-15': 'ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ ',
            '2024-06-06': 'í˜„ì¶©ì¼',
            '2024-08-15': 'ê´‘ë³µì ˆ',
            '2024-09-16': 'ì¶”ì„ ì—°íœ´',
            '2024-09-17': 'ì¶”ì„',
            '2024-09-18': 'ì¶”ì„ ì—°íœ´',
            '2024-10-03': 'ê°œì²œì ˆ',
            '2024-10-09': 'í•œê¸€ë‚ ',
            '2024-12-25': 'í¬ë¦¬ìŠ¤ë§ˆìŠ¤',
            // 2025ë…„
            '2025-01-01': 'ì‹ ì •',
            '2025-01-28': 'ì„¤ë‚  ì—°íœ´',
            '2025-01-29': 'ì„¤ë‚ ',
            '2025-01-30': 'ì„¤ë‚  ì—°íœ´',
            '2025-03-01': 'ì‚¼ì¼ì ˆ',
            '2025-03-03': 'ëŒ€ì²´ê³µíœ´ì¼',
            '2025-05-05': 'ì–´ë¦°ì´ë‚ ',
            '2025-05-06': 'ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ ',
            '2025-06-06': 'í˜„ì¶©ì¼',
            '2025-08-15': 'ê´‘ë³µì ˆ',
            '2025-10-03': 'ê°œì²œì ˆ',
            '2025-10-05': 'ì¶”ì„ ì—°íœ´',
            '2025-10-06': 'ì¶”ì„',
            '2025-10-07': 'ì¶”ì„ ì—°íœ´',
            '2025-10-08': 'ëŒ€ì²´ê³µíœ´ì¼',
            '2025-10-09': 'í•œê¸€ë‚ ',
            '2025-12-25': 'í¬ë¦¬ìŠ¤ë§ˆìŠ¤',
            // 2026ë…„
            '2026-01-01': 'ì‹ ì •',
            '2026-02-16': 'ì„¤ë‚  ì—°íœ´',
            '2026-02-17': 'ì„¤ë‚ ',
            '2026-02-18': 'ì„¤ë‚  ì—°íœ´',
            '2026-03-01': 'ì‚¼ì¼ì ˆ',
            '2026-03-02': 'ëŒ€ì²´ê³µíœ´ì¼',
            '2026-05-05': 'ì–´ë¦°ì´ë‚ ',
            '2026-05-24': 'ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ ',
            '2026-05-25': 'ëŒ€ì²´ê³µíœ´ì¼',
            '2026-06-06': 'í˜„ì¶©ì¼',
            '2026-08-15': 'ê´‘ë³µì ˆ',
            '2026-08-17': 'ëŒ€ì²´ê³µíœ´ì¼',
            '2026-09-24': 'ì¶”ì„ ì—°íœ´',
            '2026-09-25': 'ì¶”ì„',
            '2026-09-26': 'ì¶”ì„ ì—°íœ´',
            '2026-10-03': 'ê°œì²œì ˆ',
            '2026-10-05': 'ëŒ€ì²´ê³µíœ´ì¼',
            '2026-10-09': 'í•œê¸€ë‚ ',
            '2026-12-25': 'í¬ë¦¬ìŠ¤ë§ˆìŠ¤'
        };

        // ê³µíœ´ì¼ í™•ì¸
        function getHolidayName(year, month, day) {
            const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            return KOREAN_HOLIDAYS[dateStr] || null;
        }

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            currentYear = today.getFullYear();
            currentMonth = today.getMonth() + 1;
            document.getElementById('targetMonthInput').value = `${currentYear}-${String(currentMonth).padStart(2, '0')}`;
            updateTargetMonth();
        });

        // ì¼ë³„ ë‹¹ì§ ì¸ì› ì„¤ì •
        let primaryCountPerDay = 1;  // ì¼ë³„ ë‹¹ì§ ì¸ì› ìˆ˜
        let secondaryCountPerDay = 1;  // ì¼ë³„ 2nd ë‹¹ì§ ì¸ì› ìˆ˜

        // ë‹¹ì§ ì¸ì› ì„¤ì • ì—…ë°ì´íŠ¸
        function updateDutyCountSettings() {
            const primaryInput = document.getElementById('primaryCountPerDayInput');
            const secondaryInput = document.getElementById('secondaryCountPerDayInput');
            const display = document.getElementById('dutyCountDisplay');

            primaryCountPerDay = parseInt(primaryInput.value) || 1;
            const parsedSecondary = parseInt(secondaryInput.value);
            secondaryCountPerDay = isNaN(parsedSecondary) ? 0 : parsedSecondary;

            // ìœ íš¨ ë²”ìœ„ ê²€ì¦
            if (primaryCountPerDay < 1) primaryCountPerDay = 1;
            if (primaryCountPerDay > 10) primaryCountPerDay = 10;
            if (secondaryCountPerDay < 0) secondaryCountPerDay = 0;
            if (secondaryCountPerDay > 10) secondaryCountPerDay = 10;

            primaryInput.value = primaryCountPerDay;
            secondaryInput.value = secondaryCountPerDay;

            const total = primaryCountPerDay + secondaryCountPerDay;
            display.textContent = `(ì¼ë³„ ì´ ${total}ëª…)`;
        }

        // ì‚¬ëŒ ì •ë³´ ë³€ê²½ ì‹œ ê²½ê³  í‘œì‹œ
        function markPeopleModified() {
            if (schedule || schedules.length > 0) {
                peopleModifiedAfterSchedule = true;
                updateScheduleWarning();
            }
        }

        // ê²½ê³  í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateScheduleWarning() {
            const warningEl = document.getElementById('scheduleWarning');
            if (warningEl) {
                warningEl.style.display = peopleModifiedAfterSchedule ? 'block' : 'none';
            }
        }

        // ì›” ì„ íƒ ê´€ë ¨ í•¨ìˆ˜ë“¤
        function updateTargetMonth() {
            const input = document.getElementById('targetMonthInput');
            if (input.value) {
                const [year, month] = input.value.split('-');
                currentYear = parseInt(year);
                currentMonth = parseInt(month);
            }

            // startDateë¥¼ í•´ë‹¹ ì›”ì˜ ì²« ë²ˆì§¸ í‰ì¼ë¡œ ì„¤ì •
            startDate = getFirstWeekday(currentYear, currentMonth);

            updateMonthInfoDisplay();
            renderPreviewCalendar();

            // ê¸°ì¡´ ìŠ¤ì¼€ì¤„ ì´ˆê¸°í™”
            schedule = null;
            schedules = [];
            currentScheduleIndex = 0;
            document.getElementById('calendar').innerHTML = '';
            document.getElementById('statistics').innerHTML = '';
        }

        function prevMonth() {
            currentMonth--;
            if (currentMonth < 1) {
                currentMonth = 12;
                currentYear--;
            }
            document.getElementById('targetMonthInput').value = `${currentYear}-${String(currentMonth).padStart(2, '0')}`;
            updateTargetMonth();
        }

        function nextMonth() {
            currentMonth++;
            if (currentMonth > 12) {
                currentMonth = 1;
                currentYear++;
            }
            document.getElementById('targetMonthInput').value = `${currentYear}-${String(currentMonth).padStart(2, '0')}`;
            updateTargetMonth();
        }

        function getFirstWeekday(year, month) {
            const date = new Date(year, month - 1, 1);
            while (date.getDay() === 0 || date.getDay() === 6) {
                date.setDate(date.getDate() + 1);
            }
            return date;
        }

        function updateMonthInfoDisplay() {
            const display = document.getElementById('monthInfoDisplay');
            const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();

            // í•´ë‹¹ ì›”ì˜ í‰ì¼ ìˆ˜ ê³„ì‚°
            let weekdayCount = 0;
            for (let d = 1; d <= daysInMonth; d++) {
                const date = new Date(currentYear, currentMonth - 1, d);
                const dayOfWeek = date.getDay();
                if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                    weekdayCount++;
                }
            }

            // ê³µíœ´ì¼ ìˆ˜ ê³„ì‚°
            let holidayCount = 0;
            for (let d = 1; d <= daysInMonth; d++) {
                if (getHolidayName(currentYear, currentMonth, d)) {
                    holidayCount++;
                }
            }

            display.textContent = `(í‰ì¼ ${weekdayCount}ì¼, ê³µíœ´ì¼ ${holidayCount}ì¼)`;
        }

        // ë¯¸ë¦¬ë³´ê¸° ìº˜ë¦°ë” ë Œë”ë§
        function renderPreviewCalendar() {
            const container = document.getElementById('previewCalendar');
            const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
            const firstDayOfWeek = new Date(currentYear, currentMonth - 1, 1).getDay();

            let html = '<div class="calendar">';

            // ìš”ì¼ í—¤ë”
            DAYS_OF_WEEK_FULL.forEach((day, i) => {
                let headerClass = 'calendar-day-header';
                if (i === 0) headerClass += ' sunday';
                if (i === 6) headerClass += ' saturday';
                html += `<div class="${headerClass}">${day}</div>`;
            });

            // ë¹ˆ ì¹¸ (ì›” ì‹œì‘ ì „)
            for (let i = 0; i < firstDayOfWeek; i++) {
                html += '<div class="calendar-day empty"></div>';
            }

            // ë‚ ì§œ ì¹¸
            let dayCounter = 0; // í‰ì¼ ì¹´ìš´í„° (ë‹¹ì§ Day ë²ˆí˜¸ìš©)
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(currentYear, currentMonth - 1, day);
                const dayOfWeek = date.getDay();
                const holidayName = getHolidayName(currentYear, currentMonth, day);
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                const isWeekday = !isWeekend;

                let dayClass = 'calendar-day';
                let numberClass = 'day-number-display';

                if (dayOfWeek === 0) {
                    dayClass += ' sunday';
                    numberClass += ' sunday';
                } else if (dayOfWeek === 6) {
                    dayClass += ' saturday';
                    numberClass += ' saturday';
                }

                if (holidayName) {
                    dayClass += ' holiday';
                    numberClass += ' holiday';
                }

                // í‰ì¼ì´ë©´ Day ë²ˆí˜¸ ì¦ê°€
                if (isWeekday) {
                    dayCounter++;
                }

                html += `<div class="${dayClass}">`;

                // ê³µíœ´ì¼ ì´ë¦„
                if (holidayName) {
                    html += `<div class="holiday-name">${holidayName}</div>`;
                }

                // ë‚ ì§œ ìˆ«ì
                html += `<div class="${numberClass}">${day}</div>`;

                // í‰ì¼ì´ë©´ Day ë²ˆí˜¸ í‘œì‹œ
                if (isWeekday && dayCounter <= TOTAL_DAYS) {
                    html += `<div class="day-info">Day ${dayCounter}</div>`;
                } else if (isWeekend) {
                    html += `<div class="day-info" style="color: #ccc;">íœ´ë¬´</div>`;
                } else if (isWeekday && dayCounter > TOTAL_DAYS) {
                    html += `<div class="day-info" style="color: #ccc;">ë²”ìœ„ ì™¸</div>`;
                }

                html += '</div>';
            }

            // ë¹ˆ ì¹¸ (ì›” ë í›„)
            const totalCells = firstDayOfWeek + daysInMonth;
            const remainingCells = (7 - (totalCells % 7)) % 7;
            for (let i = 0; i < remainingCells; i++) {
                html += '<div class="calendar-day empty"></div>';
            }

            html += '</div>';
            container.innerHTML = html;
        }

        // ê¸°ì¡´ í˜¸í™˜ì„±ì„ ìœ„í•œ í•¨ìˆ˜ë“¤
        function updateDateRangeDisplay() {
            // ì´ì œ updateMonthInfoDisplayë¡œ ëŒ€ì²´
            updateMonthInfoDisplay();
        }

        // Day ë²ˆí˜¸ë¥¼ ë‚ ì§œë¡œ ë³€í™˜ (í‰ì¼ë§Œ ì¹´ìš´íŠ¸, í† /ì¼ ì œì™¸)
        function dayToDate(dayNumber) {
            if (!startDate) return null;
            const date = new Date(startDate);
            let weekdaysCount = 0;

            while (weekdaysCount < dayNumber) {
                const dayOfWeek = date.getDay();
                // í‰ì¼ì¸ ê²½ìš°ë§Œ ì¹´ìš´íŠ¸ (ì›”=1, í™”=2, ìˆ˜=3, ëª©=4, ê¸ˆ=5)
                if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                    weekdaysCount++;
                    if (weekdaysCount === dayNumber) {
                        return new Date(date);
                    }
                }
                date.setDate(date.getDate() + 1);
            }
            return null;
        }

        // ë‚ ì§œë¥¼ Day ë²ˆí˜¸ë¡œ ë³€í™˜ (í‰ì¼ë§Œ ì¹´ìš´íŠ¸, í† /ì¼ ì œì™¸)
        function dateToDayNumber(targetDate) {
            if (!startDate) return null;

            const target = new Date(targetDate);
            target.setHours(0, 0, 0, 0);

            const start = new Date(startDate);
            start.setHours(0, 0, 0, 0);

            // íƒ€ê²Ÿ ë‚ ì§œê°€ ì‹œì‘ ë‚ ì§œë³´ë‹¤ ì´ì „ì´ë©´ null
            if (target < start) return null;

            // íƒ€ê²Ÿ ë‚ ì§œê°€ ì£¼ë§ì´ë©´ null
            const targetDayOfWeek = target.getDay();
            if (targetDayOfWeek === 0 || targetDayOfWeek === 6) return null;

            let weekdaysCount = 0;
            const current = new Date(start);

            while (current <= target) {
                const dayOfWeek = current.getDay();
                // í‰ì¼ì¸ ê²½ìš°ë§Œ ì¹´ìš´íŠ¸
                if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                    weekdaysCount++;
                }
                if (current.getTime() === target.getTime()) {
                    return weekdaysCount;
                }
                current.setDate(current.getDate() + 1);
            }
            return weekdaysCount;
        }

        // ë‚ ì§œë¥¼ YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ í¬ë§·
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // ì ‘ê¸°/í¼ì¹˜ê¸° ê¸°ëŠ¥
        function toggleCollapsible(sectionId) {
            const content = document.getElementById('content-' + sectionId);
            const toggle = document.getElementById('toggle-' + sectionId);

            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                toggle.classList.remove('expanded');
            } else {
                content.classList.add('expanded');
                toggle.classList.add('expanded');
            }
        }

        // Person class
        class Person {
            constructor(name, unavailableDays, alternativeDays, maxDuties, secondDutyPref, vacations, weeklyRestrictions, preferredDutyDays) {
                this.name = name;
                this.unavailableDays = unavailableDays || [];
                this.alternativeDays = alternativeDays || [];
                this.maxDuties = maxDuties || 5;
                this.secondDutyPref = secondDutyPref || 'normal'; // 'normal', 'preferred', 'limited'
                this.vacations = vacations || []; // Array of {start, end} objects
                this.weeklyRestrictions = weeklyRestrictions || {}; // {weekNum: {unavailable: [], alternative: []}}
                this.preferredDutyDays = preferredDutyDays || []; // Array of {day: number, type: 'primary' | 'secondary' | 'any'}
                this.primaryCount = 0;
                this.secondaryCount = 0;
            }

            isOnVacation(dayNumber, dateStr) {
                return this.vacations.some(v => {
                    // ë‚ ì§œ ê¸°ë°˜ íœ´ê°€ í™•ì¸
                    if (v.startDate && v.endDate) {
                        if (dateStr) {
                            return dateStr >= v.startDate && dateStr <= v.endDate;
                        }
                        // dayNumberì™€ startDateë¡œë¶€í„° ë‚ ì§œ ê³„ì‚° (í‰ì¼ë§Œ ì¹´ìš´íŠ¸)
                        if (startDate) {
                            const checkDate = dayToDate(dayNumber);
                            if (checkDate) {
                                const checkDateStr = formatDate(checkDate);
                                return checkDateStr >= v.startDate && checkDateStr <= v.endDate;
                            }
                        }
                        return false;
                    }
                    // ê¸°ì¡´ Day ê¸°ë°˜ íœ´ê°€ (í•˜ìœ„ í˜¸í™˜ì„±)
                    return dayNumber >= v.start && dayNumber <= v.end;
                });
            }

            hasPreferredDuty(dayNumber, type, dateStr) {
                return this.preferredDutyDays.some(p => {
                    // ë‚ ì§œ ê¸°ë°˜ ì„ í˜¸ ë‹¹ì§ í™•ì¸
                    if (p.date) {
                        if (dateStr) {
                            return p.date === dateStr && (type === 'any' || p.type === type || p.type === 'any');
                        }
                        // dayNumberì™€ startDateë¡œë¶€í„° ë‚ ì§œ ê³„ì‚° (í‰ì¼ë§Œ ì¹´ìš´íŠ¸)
                        if (startDate) {
                            const checkDate = dayToDate(dayNumber);
                            if (checkDate) {
                                const checkDateStr = formatDate(checkDate);
                                return p.date === checkDateStr && (type === 'any' || p.type === type || p.type === 'any');
                            }
                        }
                        return false;
                    }
                    // ê¸°ì¡´ Day ê¸°ë°˜ (í•˜ìœ„ í˜¸í™˜ì„±)
                    return p.day === dayNumber && (type === 'any' || p.type === type || p.type === 'any');
                });
            }

            addPreferredDuty(date, type) {
                this.preferredDutyDays.push({ date, type });
            }

            removePreferredDuty(index) {
                this.preferredDutyDays.splice(index, 1);
            }

            canDoPrimaryDuty(dayOfWeek, dayNumber, weekNumber) {
                // 2nd duty only staff cannot do primary duty
                if (this.secondDutyPref === '2nd-only') return false;

                if (this.isOnVacation(dayNumber)) return false;

                // Check general unavailable days (applies to all weeks)
                if (this.unavailableDays.includes(dayOfWeek)) return false;

                // Check week-specific restrictions
                if (weekNumber && this.weeklyRestrictions[weekNumber]) {
                    const weekRestriction = this.weeklyRestrictions[weekNumber];
                    if (weekRestriction.unavailable && weekRestriction.unavailable.includes(dayOfWeek)) {
                        return false;
                    }
                }

                return true;
            }

            canDoSecondaryDuty(dayOfWeek, dayNumber, weekNumber) {
                if (this.isOnVacation(dayNumber)) return false;

                // Check week-specific restrictions first
                if (weekNumber && this.weeklyRestrictions[weekNumber]) {
                    const weekRestriction = this.weeklyRestrictions[weekNumber];
                    if (weekRestriction.unavailable && weekRestriction.unavailable.includes(dayOfWeek)) {
                        // Check if this day is in alternative list for this week
                        return weekRestriction.alternative && weekRestriction.alternative.includes(dayOfWeek);
                    }
                }

                // Check general unavailable days
                if (this.unavailableDays.includes(dayOfWeek)) {
                    return this.alternativeDays.includes(dayOfWeek);
                }

                return true;
            }

            getTotalDuties() {
                return this.primaryCount + this.secondaryCount;
            }

            canTakeMoreDuties() {
                // ABSOLUTE CONSTRAINT: Total duties (primary + secondary) must not exceed maxDuties
                // This is checked FIRST, regardless of preference
                const totalDuties = this.getTotalDuties();
                if (totalDuties >= this.maxDuties) {
                    return false; // Already at or over max limit
                }

                // For specific preferences, apply additional rules
                if (this.secondDutyPref === '2nd-only') {
                    // 2nd-only staff: secondary count should also not exceed max
                    return this.secondaryCount < this.maxDuties;
                }
                if (this.secondDutyPref === 'limited' && this.secondaryCount >= 1) {
                    // Limited: max 1 secondary, rest primary
                    return this.primaryCount < this.maxDuties;
                }

                // For 'preferred' and 'normal', just check total (already checked above)
                return true;
            }

            addVacation(startDate, endDate) {
                this.vacations.push({ startDate, endDate });
            }

            removeVacation(index) {
                this.vacations.splice(index, 1);
            }

            addWeeklyRestriction(weekNum, unavailableDays, alternativeDays) {
                this.weeklyRestrictions[weekNum] = {
                    unavailable: unavailableDays || [],
                    alternative: alternativeDays || []
                };
            }

            removeWeeklyRestriction(weekNum) {
                delete this.weeklyRestrictions[weekNum];
            }
        }

        // Load sample data
        function loadSampleData() {
            // Create person with weekly restriction example
            const kimNayoung = new Person('ê¹€ë‚˜ì˜', ['í™”', 'ëª©', 'ê¸ˆ'], [], 3, 'normal', [], {}, []);
            kimNayoung.addWeeklyRestriction(1, ['ì›”', 'ìˆ˜'], []);  // 1ì£¼ì°¨: ì›”, ìˆ˜ ë¶ˆê°€
            kimNayoung.addWeeklyRestriction(2, ['ëª©', 'ê¸ˆ'], ['ëª©']);  // 2ì£¼ì°¨: ëª©, ê¸ˆ ë¶ˆê°€ (ëª©ìš”ì¼ì€ 2nd ê°€ëŠ¥)

            people = [
                kimNayoung,
                new Person('ì´í˜„ê·œ', [], [], 20, 'preferred', [], {}, []),
                new Person('ì´ì •ìˆ˜', ['ìˆ˜', 'ëª©'], ['ìˆ˜'], 5, 'normal', [], {}, []),
                new Person('ìœ ì˜ì² ', ['ìˆ˜', 'ëª©', 'ê¸ˆ'], [], 3, 'normal', [], {}, []),
                new Person('ì„œì§€ìš°', ['ì›”', 'í™”'], ['ì›”'], 5, 'normal', [], {}, []),
                new Person('ì´ë¯¼ì •', ['í™”', 'ìˆ˜'], ['í™”'], 5, 'normal', [], {}, []),
                new Person('ê³µí¬ì •', ['ì›”', 'í™”'], ['ì›”'], 5, 'normal', [], {}, []),
                new Person('ë¬¸ì§€ì• ', ['ëª©', 'ê¸ˆ'], ['ëª©'], 5, 'normal', [], {}, []),
                new Person('ì „ë³‘ë‚¨', ['ìˆ˜', 'ëª©'], ['ìˆ˜'], 5, 'normal', [], {}, []),
                new Person('ë…¸í˜„ì •', ['í™”', 'ìˆ˜'], ['í™”'], 5, 'normal', [], {}, []),
                new Person('ë°±ì§€ì›', [], [], 5, 'limited', [], {}, []),
                new Person('ë°•ìˆ˜ì •', ['ê¸ˆ', 'ì›”'], ['ê¸ˆ'], 5, 'normal', [], {}, [])
            ];
            renderPersonList();
            markPeopleModified();
            showMessage('ì˜ˆì‹œ ë°ì´í„°ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. (ê¹€ë‚˜ì˜: 1ì£¼ì°¨ ì›”/ìˆ˜, 2ì£¼ì°¨ ëª©/ê¸ˆ ë¶ˆê°€)', 'success');
        }

        // Add person
        // Manage preferred duty fields in the add person form
        let newPersonPreferredDutyCounter = 0;

        function addNewPreferredDutyField() {
            const container = document.getElementById('newPersonPreferredDuties');
            const fieldId = newPersonPreferredDutyCounter++;

            const fieldHTML = `
                <div class="new-preferred-duty-field" id="newPreferredField_${fieldId}" style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px; margin-bottom: 10px; padding: 10px; background: white; border-radius: 4px;">
                    <div>
                        <label style="font-size: 12px; margin: 3px 0;">ë‚ ì§œ</label>
                        <input type="date" class="new-preferred-day" data-field-id="${fieldId}" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                    </div>
                    <div>
                        <label style="font-size: 12px; margin: 3px 0;">ìœ í˜•</label>
                        <select class="new-preferred-type" data-field-id="${fieldId}" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                            <option value="any">ë‹¹ì§/2nd</option>
                            <option value="primary">ë‹¹ì§ë§Œ</option>
                            <option value="secondary">2ndë§Œ</option>
                        </select>
                    </div>
                    <div style="display: flex; align-items: flex-end;">
                        <button type="button" onclick="removeNewPreferredDutyField(${fieldId})" style="padding: 5px 10px; font-size: 12px; background: #e74c3c; color: white; border: none; border-radius: 3px; cursor: pointer;">ì‚­ì œ</button>
                    </div>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', fieldHTML);
        }

        function removeNewPreferredDutyField(fieldId) {
            const field = document.getElementById(`newPreferredField_${fieldId}`);
            if (field) {
                field.remove();
            }
        }

        // Manage vacation fields in the add person form
        let newPersonVacationCounter = 0;

        function addNewVacationField() {
            const container = document.getElementById('newPersonVacations');
            const fieldId = newPersonVacationCounter++;

            const fieldHTML = `
                <div class="new-vacation-field" id="newVacationField_${fieldId}" style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px; margin-bottom: 10px; padding: 10px; background: white; border-radius: 4px;">
                    <div>
                        <label style="font-size: 12px; margin: 3px 0;">ì‹œì‘ì¼</label>
                        <input type="date" class="new-vacation-start" data-field-id="${fieldId}" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                    </div>
                    <div>
                        <label style="font-size: 12px; margin: 3px 0;">ì¢…ë£Œì¼</label>
                        <input type="date" class="new-vacation-end" data-field-id="${fieldId}" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                    </div>
                    <div style="display: flex; align-items: flex-end;">
                        <button type="button" onclick="removeNewVacationField(${fieldId})" style="padding: 5px 10px; font-size: 12px; background: #e74c3c; color: white; border: none; border-radius: 3px; cursor: pointer;">ì‚­ì œ</button>
                    </div>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', fieldHTML);
        }

        function removeNewVacationField(fieldId) {
            const field = document.getElementById(`newVacationField_${fieldId}`);
            if (field) {
                field.remove();
            }
        }

        function addPerson() {
            const name = document.getElementById('newPersonName').value.trim();
            if (!name) {
                showMessage('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            const unavailableDays = Array.from(document.querySelectorAll('.new-unavailable-day:checked'))
                .map(cb => cb.value);
            const alternativeDays = Array.from(document.querySelectorAll('.new-alternative-day:checked'))
                .map(cb => cb.value);
            const maxDuties = parseInt(document.getElementById('newPersonMaxDuties').value) || 5;
            const secondDutyPref = document.getElementById('newPersonSecondDutyPref').value;

            // Read weekly restrictions
            const weeklyRestrictions = {};
            for (let week = 1; week <= 4; week++) {
                const weekUnavailable = Array.from(document.querySelectorAll(`.new-week${week}-unavailable:checked`))
                    .map(cb => cb.value);
                const weekAlternative = Array.from(document.querySelectorAll(`.new-week${week}-alternative:checked`))
                    .map(cb => cb.value);

                // Only add if there are restrictions for this week
                if (weekUnavailable.length > 0 || weekAlternative.length > 0) {
                    weeklyRestrictions[week] = {
                        unavailable: weekUnavailable,
                        alternative: weekAlternative
                    };
                }
            }

            // Read preferred duty dates (ë‚ ì§œ ê¸°ë°˜)
            const preferredDutyDays = [];
            const preferredDayInputs = document.querySelectorAll('.new-preferred-day');
            const preferredTypeInputs = document.querySelectorAll('.new-preferred-type');

            for (let i = 0; i < preferredDayInputs.length; i++) {
                const dateValue = preferredDayInputs[i].value;
                const type = preferredTypeInputs[i].value;

                if (dateValue) {
                    preferredDutyDays.push({ date: dateValue, type });
                }
            }

            // Read vacations (ë‚ ì§œ ê¸°ë°˜)
            const vacations = [];
            const vacationStartInputs = document.querySelectorAll('.new-vacation-start');
            const vacationEndInputs = document.querySelectorAll('.new-vacation-end');

            for (let i = 0; i < vacationStartInputs.length; i++) {
                const startDate = vacationStartInputs[i].value;
                const endDate = vacationEndInputs[i].value;

                if (startDate && endDate) {
                    if (startDate > endDate) {
                        showMessage(`íœ´ê°€ ${i + 1}: ì‹œì‘ì¼ì€ ì¢…ë£Œì¼ë³´ë‹¤ ì´ì „ì´ì–´ì•¼ í•©ë‹ˆë‹¤.`, 'error');
                        return;
                    }
                    vacations.push({ startDate, endDate });
                }
            }

            people.push(new Person(name, unavailableDays, alternativeDays, maxDuties, secondDutyPref, vacations, weeklyRestrictions, preferredDutyDays));

            // Clear form
            document.getElementById('newPersonName').value = '';
            document.querySelectorAll('.new-unavailable-day').forEach(cb => cb.checked = false);
            document.querySelectorAll('.new-alternative-day').forEach(cb => cb.checked = false);
            document.getElementById('newPersonMaxDuties').value = 5;
            document.getElementById('newPersonSecondDutyPref').value = 'normal';

            // Clear weekly restrictions
            for (let week = 1; week <= 4; week++) {
                document.querySelectorAll(`.new-week${week}-unavailable`).forEach(cb => cb.checked = false);
                document.querySelectorAll(`.new-week${week}-alternative`).forEach(cb => cb.checked = false);
            }

            // Clear preferred duty dates
            document.getElementById('newPersonPreferredDuties').innerHTML = '';

            // Clear vacations
            document.getElementById('newPersonVacations').innerHTML = '';

            renderPersonList();
            markPeopleModified();
            showMessage(`${name} ë‹˜ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
        }

        // Remove person
        function removePerson(index) {
            const person = people[index];
            if (confirm(person.name + ' ë‹˜ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                people.splice(index, 1);
                renderPersonList();
                markPeopleModified();
                showMessage('ì¸ì›ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
            }
        }

        // Clear all data
        function clearAllData() {
            if (confirm('ëª¨ë“  ì¸ì› ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                people = [];
                schedule = null;
                schedules = [];
                startDate = null;
                peopleModifiedAfterSchedule = false;
                updateScheduleWarning();
                document.getElementById('startDateInput').value = '';
                document.getElementById('dateRangeDisplay').textContent = '';
                renderPersonList();
                document.getElementById('calendar').innerHTML = '';
                document.getElementById('statistics').innerHTML = '';
                showMessage('ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
            }
        }

        // ë°ì´í„° ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° ê¸°ëŠ¥
        function saveToLocalStorage() {
            const data = {
                people: people,
                startDate: startDate ? formatDate(startDate) : null,
                savedAt: new Date().toISOString()
            };
            localStorage.setItem('hospitalDutyScheduler', JSON.stringify(data));
            showMessage('ë°ì´í„°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('hospitalDutyScheduler');
            if (!saved) {
                showMessage('ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            try {
                const data = JSON.parse(saved);

                // Person ê°ì²´ë¡œ ë³µì›
                people = data.people.map(p => {
                    const person = new Person(
                        p.name,
                        p.unavailableDays || [],
                        p.alternativeDays || [],
                        p.maxDuties || 5,
                        p.secondDutyPref || 'normal',
                        p.vacations || [],
                        p.weeklyRestrictions || {},
                        p.preferredDutyDays || []
                    );
                    person.primaryCount = p.primaryCount || 0;
                    person.secondaryCount = p.secondaryCount || 0;
                    return person;
                });

                // ì‹œì‘ ë‚ ì§œ ë³µì›
                if (data.startDate) {
                    startDate = new Date(data.startDate);
                    document.getElementById('startDateInput').value = data.startDate;
                    updateDateRangeDisplay();
                }

                renderPersonList();
                showMessage(`ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤. (${people.length}ëª…)`, 'success');
            } catch (error) {
                showMessage('ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }

        function downloadJSON() {
            const data = {
                people: people,
                startDate: startDate ? formatDate(startDate) : null,
                exportedAt: new Date().toISOString()
            };

            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const dateStr = new Date().toISOString().slice(0, 10);
            a.download = `ì¸ì›ì •ë³´_${dateStr}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showMessage('ì‚¬ëŒ ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }

        function uploadJSON(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);

                    // Person ê°ì²´ë¡œ ë³µì›
                    people = data.people.map(p => {
                        const person = new Person(
                            p.name,
                            p.unavailableDays || [],
                            p.alternativeDays || [],
                            p.maxDuties || 5,
                            p.secondDutyPref || 'normal',
                            p.vacations || [],
                            p.weeklyRestrictions || {},
                            p.preferredDutyDays || []
                        );
                        person.primaryCount = p.primaryCount || 0;
                        person.secondaryCount = p.secondaryCount || 0;
                        return person;
                    });

                    // ì‹œì‘ ë‚ ì§œ ë³µì›
                    if (data.startDate) {
                        startDate = new Date(data.startDate);
                        document.getElementById('startDateInput').value = data.startDate;
                        updateDateRangeDisplay();
                    }

                    renderPersonList();
                    markPeopleModified();
                    showMessage(`ì‚¬ëŒ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤. (${people.length}ëª…)`, 'success');
                } catch (error) {
                    showMessage('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);

            // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™” (ê°™ì€ íŒŒì¼ ì¬ì„ íƒ ê°€ëŠ¥í•˜ë„ë¡)
            event.target.value = '';
        }

        // Render person list
        function renderPersonList() {
            const listDiv = document.getElementById('personList');
            if (people.length === 0) {
                listDiv.innerHTML = '<p class="small-text">ë“±ë¡ëœ ì¸ì›ì´ ì—†ìŠµë‹ˆë‹¤. ìœ„ì—ì„œ ì¸ì›ì„ ì¶”ê°€í•˜ê±°ë‚˜ ì˜ˆì‹œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.</p>';
                return;
            }

            let html = '<h3>ë“±ë¡ëœ ì¸ì› (' + people.length + 'ëª…)</h3>';
            people.forEach((person, index) => {
                // ë°°ì§€
                let badge = '';
                if (person.secondDutyPref === 'preferred') {
                    badge = '<span class="preference-badge badge-2nd-preferred">2ndì„ í˜¸</span>';
                } else if (person.secondDutyPref === 'limited') {
                    badge = '<span class="preference-badge badge-2nd-limited">2nd1íšŒ</span>';
                } else if (person.secondDutyPref === '2nd-only') {
                    badge = '<span class="preference-badge badge-vacation">2ndë§Œ</span>';
                }

                // ê°„ë‹¨í•œ ìš”ì•½ ì •ë³´
                const unavailSummary = person.unavailableDays.length > 0 ? person.unavailableDays.join(',') : '-';
                const weeklyCount = person.weeklyRestrictions ? Object.keys(person.weeklyRestrictions).length : 0;
                const vacationCount = person.vacations ? person.vacations.length : 0;
                const preferredCount = person.preferredDutyDays ? person.preferredDutyDays.length : 0;

                let vacationHTML = '';
                if (person.vacations && person.vacations.length > 0) {
                    vacationHTML = '<div class="vacation-list">';
                    person.vacations.forEach((vacation, vIdx) => {
                        const vacText = vacation.startDate ? vacation.startDate + ' ~ ' + vacation.endDate : 'Day ' + vacation.start + ' ~ ' + vacation.end;
                        vacationHTML += '<div class="vacation-item">';
                        vacationHTML += '<span>ğŸ–ï¸ ' + vacText + '</span>';
                        vacationHTML += '<button class="danger btn-delete-vacation" data-person-index="' + index + '" data-vacation-index="' + vIdx + '" style="padding: 3px 8px; font-size: 12px;">ì‚­ì œ</button>';
                        vacationHTML += '</div>';
                    });
                    vacationHTML += '</div>';
                }

                // Weekly restrictions display and form
                let weeklyHTML = '';
                if (person.weeklyRestrictions && Object.keys(person.weeklyRestrictions).length > 0) {
                    weeklyHTML = '<div class="vacation-list" style="margin-top: 10px;">';
                    Object.keys(person.weeklyRestrictions).sort().forEach(weekNum => {
                        const restriction = person.weeklyRestrictions[weekNum];
                        const unavailText = restriction.unavailable && restriction.unavailable.length > 0
                            ? restriction.unavailable.join(', ') : 'ì—†ìŒ';
                        const altText = restriction.alternative && restriction.alternative.length > 0
                            ? ', 2nd ê°€ëŠ¥: ' + restriction.alternative.join(', ') : '';
                        weeklyHTML += '<div class="vacation-item">';
                        weeklyHTML += '<span>ğŸ“… ' + weekNum + 'ì£¼ì°¨: ' + unavailText + altText + '</span>';
                        weeklyHTML += '<button class="danger btn-delete-weekly" data-person-index="' + index + '" data-week-num="' + weekNum + '" style="padding: 3px 8px; font-size: 12px;">ì‚­ì œ</button>';
                        weeklyHTML += '</div>';
                    });
                    weeklyHTML += '</div>';
                }

                // Preferred duty days display
                let preferredHTML = '';
                if (person.preferredDutyDays && person.preferredDutyDays.length > 0) {
                    preferredHTML = '<div class="vacation-list" style="margin-top: 10px;">';
                    person.preferredDutyDays.forEach((pref, pIdx) => {
                        let typeText = '';
                        if (pref.type === 'primary') typeText = 'ë‹¹ì§';
                        else if (pref.type === 'secondary') typeText = '2nd duty';
                        else typeText = 'ë‹¹ì§/2nd';
                        const dateText = pref.date || 'Day ' + pref.day;
                        preferredHTML += '<div class="vacation-item">';
                        preferredHTML += '<span>â­ ' + dateText + ': ' + typeText + '</span>';
                        preferredHTML += '<button class="danger btn-delete-preferred" data-person-index="' + index + '" data-preferred-index="' + pIdx + '" style="padding: 3px 8px; font-size: 12px;">ì‚­ì œ</button>';
                        preferredHTML += '</div>';
                    });
                    preferredHTML += '</div>';
                }

                html += '<div class="person-entry" id="person_' + index + '">';

                // í—¤ë”: ì´ë¦„ + ë°°ì§€
                html += '<h3>' + person.name + badge + '</h3>';

                // ê°„ë‹¨í•œ ìš”ì•½ ì •ë³´
                html += '<div class="person-compact-info">';
                html += '<strong>ìµœëŒ€:</strong> ' + person.maxDuties + 'íšŒ | ';
                html += '<strong>ë¶ˆê°€:</strong> ' + unavailSummary;
                if (vacationCount > 0 || weeklyCount > 0 || preferredCount > 0) {
                    html += ' | ';
                    const extras = [];
                    if (vacationCount > 0) extras.push('ğŸ–ï¸' + vacationCount);
                    if (weeklyCount > 0) extras.push('ğŸ“…' + weeklyCount);
                    if (preferredCount > 0) extras.push('â­' + preferredCount);
                    html += extras.join(' ');
                }
                html += '</div>';

                // ë²„íŠ¼ ê·¸ë£¹
                html += '<div style="display: flex; gap: 5px; margin-top: 8px;">';
                html += '<button onclick="toggleCollapsible(\'personDetail_' + index + '\')" style="flex: 1; padding: 4px 8px; font-size: 11px; background: #95a5a6;">ìƒì„¸</button>';
                html += '<button onclick="toggleEditMode(' + index + ')" class="secondary" style="flex: 1; padding: 4px 8px; font-size: 11px;">âš™ï¸ í¸ì§‘</button>';
                html += '</div>';

                // ìƒì„¸ ì •ë³´ ì„¹ì…˜ (ì ‘í˜€ìˆìŒ)
                html += '<div class="collapsible-content" id="content-personDetail_' + index + '">';
                html += '<div class="collapsible-body" style="padding: 8px 0;">';

                // ê¸°ë³¸ ì •ë³´
                html += '<div style="font-size: 11px; color: #666; line-height: 1.6; margin-bottom: 8px;">';
                html += '<strong>ë¶ˆê°€ (ì „ì²´):</strong> ' + (person.unavailableDays.join(', ') || 'ì—†ìŒ') + '<br>';
                html += '<strong>2nd ê°€ëŠ¥:</strong> ' + (person.alternativeDays.join(', ') || 'ì—†ìŒ');
                html += '</div>';

                html += '<div class="edit-controls" id="editControls_' + index + '" style="display: none;">';
                html += '<label style="font-size: 13px; font-weight: 600; color: #2c3e50;">ê¸°ë³¸ ì •ë³´ ìˆ˜ì •</label>';
                html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 8px;">';
                html += '<div>';
                html += '<label style="font-size: 12px;">ìµœëŒ€ ë‹¹ì§ íšŸìˆ˜</label>';
                html += '<input type="number" id="editMaxDuties_' + index + '" value="' + person.maxDuties + '" min="1" max="20" style="width: 100%; padding: 5px; font-size: 13px;">';
                html += '</div>';
                html += '<div>';
                html += '<label style="font-size: 12px;">2nd Duty ì„ í˜¸ë„</label>';
                html += '<select id="editSecondPref_' + index + '" style="width: 100%; padding: 5px; font-size: 13px;">';
                html += '<option value="normal"' + (person.secondDutyPref === 'normal' ? ' selected' : '') + '>ì¼ë°˜</option>';
                html += '<option value="preferred"' + (person.secondDutyPref === 'preferred' ? ' selected' : '') + '>2nd ì„ í˜¸</option>';
                html += '<option value="limited"' + (person.secondDutyPref === 'limited' ? ' selected' : '') + '>ì œí•œì  (2nd 1íšŒë§Œ)</option>';
                html += '<option value="2nd-only"' + (person.secondDutyPref === '2nd-only' ? ' selected' : '') + '>2ndë§Œ</option>';
                html += '</select>';
                html += '</div>';
                html += '</div>';

                // ë¶ˆê°€ëŠ¥í•œ ìš”ì¼ (ì „ì²´) í¸ì§‘
                html += '<div style="margin-top: 10px;">';
                html += '<label style="font-size: 12px; font-weight: 600;">ë¶ˆê°€ëŠ¥í•œ ìš”ì¼ (ì „ì²´)</label>';
                html += '<div class="checkbox-group">';
                ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ'].forEach(day => {
                    const checked = person.unavailableDays.includes(day) ? ' checked' : '';
                    html += '<label style="font-size: 12px;"><input type="checkbox" value="' + day + '" class="edit-unavailable-' + index + '"' + checked + '> ' + day + '</label>';
                });
                html += '</div>';
                html += '</div>';

                // ëŒ€ì²´ ê°€ëŠ¥ ìš”ì¼ í¸ì§‘
                html += '<div style="margin-top: 8px;">';
                html += '<label style="font-size: 12px; font-weight: 600;">ëŒ€ì²´ ê°€ëŠ¥ ìš”ì¼ (2nd)</label>';
                html += '<div class="checkbox-group">';
                ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ'].forEach(day => {
                    const checked = person.alternativeDays.includes(day) ? ' checked' : '';
                    html += '<label style="font-size: 12px;"><input type="checkbox" value="' + day + '" class="edit-alternative-' + index + '"' + checked + '> ' + day + '</label>';
                });
                html += '</div>';
                html += '</div>';

                html += '<button onclick="savePersonEdit(' + index + ')" style="background: #27ae60; margin-top: 6px; padding: 4px 8px; font-size: 11px;">âœ“ ì €ì¥</button>';
                html += '<button onclick="toggleEditMode(' + index + ')" class="secondary" style="margin-top: 6px; padding: 4px 8px; font-size: 11px;">ì·¨ì†Œ</button>';
                html += '</div>';

                html += weeklyHTML;
                html += vacationHTML;
                html += preferredHTML;

                html += '<div class="vacation-form" style="background: #e8f4f8; padding: 6px; margin-top: 6px;">';
                html += '<label style="font-size: 11px; margin-bottom: 3px; font-weight: 600;">ì£¼ë³„ ì œì•½ ì¶”ê°€</label>';
                html += '<div style="display: grid; grid-template-columns: auto 1fr; gap: 8px; align-items: start;">';
                html += '<div>';
                html += '<label style="font-size: 10px;">ì£¼ì°¨</label>';
                html += '<select id="weekNum_' + index + '" style="width: 50px; padding: 3px; font-size: 11px;">';
                html += '<option value="1">1ì£¼</option>';
                html += '<option value="2">2ì£¼</option>';
                html += '<option value="3">3ì£¼</option>';
                html += '<option value="4">4ì£¼</option>';
                html += '</select>';
                html += '</div>';
                html += '<div>';
                html += '<label style="font-size: 10px;">ë¶ˆê°€ëŠ¥í•œ ìš”ì¼</label>';
                html += '<div class="checkbox-group" style="margin-bottom: 3px; font-size: 10px;">';
                html += '<label style="font-size: 10px;"><input type="checkbox" value="ì›”" class="week-unavailable-' + index + '"> ì›”</label>';
                html += '<label style="font-size: 10px;"><input type="checkbox" value="í™”" class="week-unavailable-' + index + '"> í™”</label>';
                html += '<label style="font-size: 10px;"><input type="checkbox" value="ìˆ˜" class="week-unavailable-' + index + '"> ìˆ˜</label>';
                html += '<label style="font-size: 10px;"><input type="checkbox" value="ëª©" class="week-unavailable-' + index + '"> ëª©</label>';
                html += '<label style="font-size: 10px;"><input type="checkbox" value="ê¸ˆ" class="week-unavailable-' + index + '"> ê¸ˆ</label>';
                html += '</div>';
                html += '<label style="font-size: 10px;">2nd ê°€ëŠ¥</label>';
                html += '<div class="checkbox-group" style="font-size: 10px;">';
                html += '<label style="font-size: 10px;"><input type="checkbox" value="ì›”" class="week-alternative-' + index + '"> ì›”</label>';
                html += '<label style="font-size: 10px;"><input type="checkbox" value="í™”" class="week-alternative-' + index + '"> í™”</label>';
                html += '<label style="font-size: 10px;"><input type="checkbox" value="ìˆ˜" class="week-alternative-' + index + '"> ìˆ˜</label>';
                html += '<label style="font-size: 10px;"><input type="checkbox" value="ëª©" class="week-alternative-' + index + '"> ëª©</label>';
                html += '<label style="font-size: 10px;"><input type="checkbox" value="ê¸ˆ" class="week-alternative-' + index + '"> ê¸ˆ</label>';
                html += '</div>';
                html += '</div>';
                html += '</div>';
                html += '<button onclick="addWeeklyRestriction(' + index + ')" style="padding: 4px 8px; font-size: 11px; margin-top: 3px; width: 100%;">ì£¼ë³„ ì œì•½ ì¶”ê°€</button>';
                html += '</div>';

                html += '<div class="vacation-form" style="padding: 6px; margin-top: 6px;">';
                html += '<label style="font-size: 11px; margin-bottom: 3px; font-weight: 600;">íœ´ê°€ ì¶”ê°€ (ë‚ ì§œ ê¸°ì¤€)</label>';
                html += '<div class="day-range-input" style="gap: 3px;">';
                html += '<input type="date" id="vacStart_' + index + '" style="padding: 3px; font-size: 11px;">';
                html += '<span style="font-size: 11px;">~</span>';
                html += '<input type="date" id="vacEnd_' + index + '" style="padding: 3px; font-size: 11px;">';
                html += '</div>';
                html += '<button onclick="addVacation(' + index + ')" style="padding: 4px 8px; font-size: 11px; margin-top: 3px; width: 100%;">íœ´ê°€ ì¶”ê°€</button>';
                html += '</div>';

                html += '<div class="vacation-form" style="background: #fff3e6; padding: 6px; margin-top: 6px;">';
                html += '<label style="font-size: 11px; margin-bottom: 3px; font-weight: 600;">ì„ í˜¸ ë‹¹ì§ ë‚ ì§œ ì¶”ê°€</label>';
                html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">';
                html += '<div>';
                html += '<label style="font-size: 10px; margin: 2px 0;">ë‚ ì§œ</label>';
                html += '<input type="date" id="prefDay_' + index + '" style="width: 100%; padding: 3px; font-size: 11px;">';
                html += '</div>';
                html += '<div>';
                html += '<label style="font-size: 10px; margin: 2px 0;">ìœ í˜•</label>';
                html += '<select id="prefType_' + index + '" style="width: 100%; padding: 3px; font-size: 11px;">';
                html += '<option value="any">ë‹¹ì§/2nd</option>';
                html += '<option value="primary">ë‹¹ì§ë§Œ</option>';
                html += '<option value="secondary">2ndë§Œ</option>';
                html += '</select>';
                html += '</div>';
                html += '</div>';
                html += '<button onclick="addPreferredDuty(' + index + ')" style="padding: 4px 8px; font-size: 11px; margin-top: 3px; width: 100%;">ì„ í˜¸ ë‚ ì§œ ì¶”ê°€</button>';
                html += '</div>';

                html += '<button class="danger btn-delete-person" data-person-index="' + index + '" style="padding: 4px 8px; font-size: 11px; margin-top: 8px; width: 100%;">ì¸ì› ì‚­ì œ</button>';

                html += '</div>'; // collapsible-body ë‹«ê¸°
                html += '</div>'; // collapsible-content ë‹«ê¸°
                html += '</div>'; // person-entry ë‹«ê¸°
            });
            listDiv.innerHTML = html;

            // Add event listeners for delete buttons
            document.querySelectorAll('.btn-delete-vacation').forEach(btn => {
                btn.addEventListener('click', function() {
                    const personIndex = parseInt(this.getAttribute('data-person-index'));
                    const vacationIndex = parseInt(this.getAttribute('data-vacation-index'));
                    removeVacation(personIndex, vacationIndex);
                });
            });

            document.querySelectorAll('.btn-delete-weekly').forEach(btn => {
                btn.addEventListener('click', function() {
                    const personIndex = parseInt(this.getAttribute('data-person-index'));
                    const weekNum = this.getAttribute('data-week-num');
                    removeWeeklyRestriction(personIndex, weekNum);
                });
            });

            document.querySelectorAll('.btn-delete-preferred').forEach(btn => {
                btn.addEventListener('click', function() {
                    const personIndex = parseInt(this.getAttribute('data-person-index'));
                    const preferredIndex = parseInt(this.getAttribute('data-preferred-index'));
                    removePreferredDuty(personIndex, preferredIndex);
                });
            });

            document.querySelectorAll('.btn-delete-person').forEach(btn => {
                btn.addEventListener('click', function() {
                    const personIndex = parseInt(this.getAttribute('data-person-index'));
                    removePerson(personIndex);
                });
            });
        }

        // Add weekly restriction
        function addWeeklyRestriction(personIndex) {
            const weekNum = parseInt(document.getElementById(`weekNum_${personIndex}`).value);
            const unavailableDays = Array.from(document.querySelectorAll(`.week-unavailable-${personIndex}:checked`))
                .map(cb => cb.value);
            const alternativeDays = Array.from(document.querySelectorAll(`.week-alternative-${personIndex}:checked`))
                .map(cb => cb.value);

            if (unavailableDays.length === 0) {
                showMessage('ë¶ˆê°€ëŠ¥í•œ ìš”ì¼ì„ ìµœì†Œ 1ê°œ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            people[personIndex].addWeeklyRestriction(weekNum, unavailableDays, alternativeDays);
            renderPersonList();
            markPeopleModified();
            showMessage(`${people[personIndex].name}ì˜ ${weekNum}ì£¼ì°¨ ì œì•½ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
        }

        // Remove weekly restriction
        function removeWeeklyRestriction(personIndex, weekNum) {
            const person = people[personIndex];
            if (!person || !person.weeklyRestrictions || !person.weeklyRestrictions[weekNum]) {
                showMessage('ì‚­ì œ ì˜¤ë¥˜: í•´ë‹¹ ì£¼ì°¨ ì œì•½ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            if (confirm(`${person.name}ì˜ ${weekNum}ì£¼ì°¨ ì œì•½ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                delete person.weeklyRestrictions[weekNum];
                renderPersonList();
                markPeopleModified();
                showMessage('ì£¼ë³„ ì œì•½ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            }
        }

        // Add vacation (ë‚ ì§œ ê¸°ë°˜)
        function addVacation(personIndex) {
            const startInput = document.getElementById(`vacStart_${personIndex}`);
            const endInput = document.getElementById(`vacEnd_${personIndex}`);

            const startDate = startInput.value;
            const endDate = endInput.value;

            if (!startDate || !endDate) {
                showMessage('íœ´ê°€ ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            if (startDate > endDate) {
                showMessage('ì‹œì‘ì¼ì€ ì¢…ë£Œì¼ë³´ë‹¤ ì´ì „ì´ì–´ì•¼ í•©ë‹ˆë‹¤.', 'error');
                return;
            }

            people[personIndex].addVacation(startDate, endDate);
            startInput.value = '';
            endInput.value = '';
            renderPersonList();
            markPeopleModified();
            showMessage(`${people[personIndex].name}ì˜ íœ´ê°€ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤. (${startDate} ~ ${endDate})`, 'success');
        }

        // Remove vacation
        function removeVacation(personIndex, vacationIndex) {
            const person = people[personIndex];
            if (!person || !person.vacations || !person.vacations[vacationIndex]) {
                showMessage('ì‚­ì œ ì˜¤ë¥˜: íœ´ê°€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            const vacation = person.vacations[vacationIndex];
            const vacText = vacation.startDate ? `${vacation.startDate} ~ ${vacation.endDate}` : `Day ${vacation.start} ~ ${vacation.end}`;
            if (confirm(person.name + 'ì˜ íœ´ê°€ (' + vacText + ')ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                person.vacations.splice(vacationIndex, 1);
                renderPersonList();
                markPeopleModified();
                showMessage('íœ´ê°€ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            }
        }

        // Add preferred duty day (ë‚ ì§œ ê¸°ë°˜)
        function addPreferredDuty(personIndex) {
            const dayInput = document.getElementById(`prefDay_${personIndex}`);
            const typeInput = document.getElementById(`prefType_${personIndex}`);

            const dateValue = dayInput.value;
            const type = typeInput.value;

            if (!dateValue) {
                showMessage('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            people[personIndex].addPreferredDuty(dateValue, type);
            dayInput.value = '';
            typeInput.value = 'any';
            renderPersonList();
            markPeopleModified();
            showMessage(`${people[personIndex].name}ì˜ ì„ í˜¸ ë‹¹ì§ ë‚ ì§œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤. (${dateValue})`, 'success');
        }

        // Remove preferred duty day
        function removePreferredDuty(personIndex, preferredIndex) {
            const person = people[personIndex];
            if (!person || !person.preferredDutyDays || !person.preferredDutyDays[preferredIndex]) {
                showMessage('ì‚­ì œ ì˜¤ë¥˜: ì„ í˜¸ ë‹¹ì§ ë‚ ì§œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            const pref = person.preferredDutyDays[preferredIndex];
            let typeText = pref.type === 'primary' ? 'ë‹¹ì§' : pref.type === 'secondary' ? '2nd duty' : 'ë‹¹ì§/2nd';
            const dateText = pref.date || `Day ${pref.day}`;
            if (confirm(`${person.name}ì˜ ì„ í˜¸ ë‹¹ì§ (${dateText}: ${typeText})ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                person.preferredDutyDays.splice(preferredIndex, 1);
                renderPersonList();
                markPeopleModified();
                showMessage('ì„ í˜¸ ë‹¹ì§ ë‚ ì§œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            }
        }

        // Generate schedule
        function generateSchedule() {
            if (people.length === 0) {
                showMessage('ì¸ì›ì„ ë¨¼ì € ì¶”ê°€í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            // ì¸ì› ìˆ˜ í™•ì¸
            const totalPerDay = primaryCountPerDay + secondaryCountPerDay;
            if (people.length < totalPerDay) {
                showMessage(`ì¸ì›ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. ì¼ë³„ ${totalPerDay}ëª…ì´ í•„ìš”í•œë° ${people.length}ëª…ë§Œ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤.`, 'error');
                return;
            }

            // Reset counts
            people.forEach(p => {
                p.primaryCount = 0;
                p.secondaryCount = 0;
            });

            schedule = [];

            // Try to generate schedule
            let success = true;
            let attempts = 0;
            const maxAttempts = 100;
            let failureReason = '';
            let failureDay = 0;

            while (attempts < maxAttempts) {
                attempts++;
                schedule = [];
                people.forEach(p => {
                    p.primaryCount = 0;
                    p.secondaryCount = 0;
                });

                success = true;
                failureReason = '';

                for (let day = 0; day < TOTAL_DAYS; day++) {
                    const week = Math.floor(day / 5);
                    const weekNumber = week + 1;
                    const dayOfWeek = DAYS_OF_WEEK[day % 5];
                    const dayNumber = day + 1;

                    // ì´ ë‚  ë°°ì •ëœ ì¸ì› ì¶”ì 
                    const assignedToday = [];

                    // Find primary duties (ë‹¤ì¤‘ ì¸ì› ì§€ì›)
                    const primaries = [];
                    for (let i = 0; i < primaryCountPerDay; i++) {
                        // ì„ í˜¸ ë‹¹ì§ì ë¨¼ì € í™•ì¸
                        const preferredPrimaryPeople = people.filter(p =>
                            !assignedToday.includes(p) &&
                            p.hasPreferredDuty(dayNumber, 'primary') &&
                            !p.isOnVacation(dayNumber) &&
                            p.canTakeMoreDuties()
                        );

                        let primary = null;
                        if (preferredPrimaryPeople.length > 0) {
                            primary = preferredPrimaryPeople[0];
                        } else {
                            const primaryCandidates = people.filter(p =>
                                !assignedToday.includes(p) &&
                                p.canDoPrimaryDuty(dayOfWeek, dayNumber, weekNumber) &&
                                p.canTakeMoreDuties() &&
                                !isConsecutive(schedule, p.name, day)
                            ).sort((a, b) => {
                                if (a.maxDuties === b.maxDuties) {
                                    return a.getTotalDuties() - b.getTotalDuties();
                                }
                                return a.primaryCount - b.primaryCount;
                            });

                            if (primaryCandidates.length === 0) {
                                success = false;
                                failureDay = dayNumber;
                                failureReason = `Day ${dayNumber} (${dayOfWeek}, ${weekNumber}ì£¼ì°¨): ë‹¹ì§ ${i + 1}ë²ˆì§¸ ì¸ì›ì„ ë°°ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`;
                                break;
                            }
                            primary = primaryCandidates[0];
                        }

                        if (primary) {
                            primaries.push(primary);
                            assignedToday.push(primary);
                            primary.primaryCount++;
                        }
                    }

                    if (!success) break;

                    // Find secondary duties (ë‹¤ì¤‘ ì¸ì› ì§€ì›)
                    const secondaries = [];
                    for (let i = 0; i < secondaryCountPerDay; i++) {
                        // ì„ í˜¸ 2nd ë‹¹ì§ì ë¨¼ì € í™•ì¸
                        const preferredSecondaryPeople = people.filter(p =>
                            !assignedToday.includes(p) &&
                            p.hasPreferredDuty(dayNumber, 'secondary') &&
                            !p.isOnVacation(dayNumber) &&
                            p.canTakeMoreDuties()
                        );

                        let secondary = null;
                        if (preferredSecondaryPeople.length > 0) {
                            secondary = preferredSecondaryPeople[0];
                        } else {
                            const secondaryCandidates = people.filter(p =>
                                !assignedToday.includes(p) &&
                                p.canDoSecondaryDuty(dayOfWeek, dayNumber, weekNumber) &&
                                (p.secondDutyPref === 'preferred' ||
                                 (p.secondDutyPref === '2nd-only' && p.canTakeMoreDuties()) ||
                                 (p.secondDutyPref === 'limited' && p.secondaryCount < 1) ||
                                 (p.secondDutyPref === 'normal' && p.canTakeMoreDuties())) &&
                                !isConsecutive(schedule, p.name, day)
                            ).sort((a, b) => {
                                if (a.secondDutyPref === 'preferred' && b.secondDutyPref !== 'preferred') return -1;
                                if (b.secondDutyPref === 'preferred' && a.secondDutyPref !== 'preferred') return 1;
                                if (a.secondDutyPref === '2nd-only' && b.secondDutyPref !== '2nd-only' && b.secondDutyPref !== 'preferred') return -1;
                                if (b.secondDutyPref === '2nd-only' && a.secondDutyPref !== '2nd-only' && a.secondDutyPref !== 'preferred') return 1;
                                if (a.maxDuties === b.maxDuties) {
                                    return a.getTotalDuties() - b.getTotalDuties();
                                }
                                return a.secondaryCount - b.secondaryCount;
                            });

                            if (secondaryCandidates.length === 0) {
                                success = false;
                                failureDay = dayNumber;
                                failureReason = `Day ${dayNumber} (${dayOfWeek}, ${weekNumber}ì£¼ì°¨): 2nd ë‹¹ì§ ${i + 1}ë²ˆì§¸ ì¸ì›ì„ ë°°ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`;
                                break;
                            }
                            secondary = secondaryCandidates[0];
                        }

                        if (secondary) {
                            secondaries.push(secondary);
                            assignedToday.push(secondary);
                            secondary.secondaryCount++;
                        }
                    }

                    if (!success) break;

                    schedule.push({
                        day: dayNumber,
                        week: weekNumber,
                        dayOfWeek: dayOfWeek,
                        primaries: primaries.map(p => p.name),
                        secondaries: secondaries.map(p => p.name)
                    });
                }

                if (success) break;
            }

            if (!success) {
                let errorMsg = 'ë‹¹ì§í‘œ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\n';
                if (failureReason) {
                    errorMsg += `âŒ ${failureReason}\n\n`;
                }
                errorMsg += `ğŸ’¡ í•´ê²° ë°©ë²•:\n`;
                errorMsg += `- ìµœëŒ€ ë‹¹ì§ íšŸìˆ˜ë¥¼ ëŠ˜ë ¤ì£¼ì„¸ìš”\n`;
                errorMsg += `- ë¶ˆê°€ëŠ¥í•œ ìš”ì¼ ìˆ˜ë¥¼ ì¤„ì—¬ì£¼ì„¸ìš”\n`;
                errorMsg += `- ì¸ì›ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”\n`;
                errorMsg += `- íœ´ê°€ ê¸°ê°„ì„ ì¡°ì •í•´ì£¼ì„¸ìš”\n`;
                errorMsg += `- ì¼ë³„ ë‹¹ì§ ì¸ì› ìˆ˜ë¥¼ ì¤„ì—¬ì£¼ì„¸ìš”\n\n`;
                errorMsg += `(${attempts}ë²ˆ ì‹œë„)`;

                alert(errorMsg);
                showMessage('ë‹¹ì§í‘œ ìƒì„± ì‹¤íŒ¨', 'error');
                return;
            }

            showMessage(`ë‹¹ì§í‘œê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤! (${attempts}ë²ˆ ì‹œë„)`, 'success');
            schedules = [schedule];
            currentScheduleIndex = 0;
            peopleModifiedAfterSchedule = false;
            updateScheduleWarning();
            document.getElementById('scheduleNavigation').style.display = 'none';
            renderCalendar();
            renderStatistics();
        }

        // Generate multiple schedules
        function generateMultipleSchedules() {
            if (people.length === 0) {
                showMessage('ì¸ì›ì„ ë¨¼ì € ì¶”ê°€í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            // ì¸ì› ìˆ˜ í™•ì¸
            const totalPerDay = primaryCountPerDay + secondaryCountPerDay;
            if (people.length < totalPerDay) {
                showMessage(`ì¸ì›ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. ì¼ë³„ ${totalPerDay}ëª…ì´ í•„ìš”í•œë° ${people.length}ëª…ë§Œ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤.`, 'error');
                return;
            }

            const targetCount = 5;
            schedules = [];
            const maxTotalAttempts = 500;
            let totalAttempts = 0;

            showMessage('ì—¬ëŸ¬ ê²½ìš°ì˜ ë‹¹ì§í‘œë¥¼ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...', 'info');

            while (schedules.length < targetCount && totalAttempts < maxTotalAttempts) {
                totalAttempts++;

                // Reset counts
                people.forEach(p => {
                    p.primaryCount = 0;
                    p.secondaryCount = 0;
                });

                let tempSchedule = [];
                let success = true;

                for (let day = 0; day < TOTAL_DAYS; day++) {
                    const week = Math.floor(day / 5);
                    const weekNumber = week + 1;
                    const dayOfWeek = DAYS_OF_WEEK[day % 5];
                    const dayNumber = day + 1;

                    // ì´ ë‚  ë°°ì •ëœ ì¸ì› ì¶”ì 
                    const assignedToday = [];

                    // Find primary duties (ë‹¤ì¤‘ ì¸ì› ì§€ì›)
                    const primaries = [];
                    for (let i = 0; i < primaryCountPerDay; i++) {
                        const preferredPrimaryPeople = people.filter(p =>
                            !assignedToday.includes(p) &&
                            p.hasPreferredDuty(dayNumber, 'primary') &&
                            !p.isOnVacation(dayNumber) &&
                            p.canTakeMoreDuties()
                        );

                        let primary = null;
                        if (preferredPrimaryPeople.length > 0) {
                            primary = preferredPrimaryPeople[0];
                        } else {
                            const primaryCandidates = people.filter(p =>
                                !assignedToday.includes(p) &&
                                p.canDoPrimaryDuty(dayOfWeek, dayNumber, weekNumber) &&
                                p.canTakeMoreDuties() &&
                                !isConsecutive(tempSchedule, p.name, day)
                            ).sort((a, b) => {
                                if (a.maxDuties === b.maxDuties) {
                                    return a.getTotalDuties() - b.getTotalDuties();
                                }
                                return a.primaryCount - b.primaryCount;
                            });

                            if (primaryCandidates.length === 0) {
                                success = false;
                                break;
                            }

                            // Randomly select from candidates with lowest total duties
                            const firstCandidate = primaryCandidates[0];
                            const bestCandidates = primaryCandidates.filter(p =>
                                p.maxDuties === firstCandidate.maxDuties &&
                                p.getTotalDuties() === firstCandidate.getTotalDuties()
                            );
                            primary = bestCandidates[Math.floor(Math.random() * bestCandidates.length)];
                        }

                        if (primary) {
                            primaries.push(primary);
                            assignedToday.push(primary);
                            primary.primaryCount++;
                        } else {
                            success = false;
                            break;
                        }
                    }

                    if (!success) break;

                    // Find secondary duties (ë‹¤ì¤‘ ì¸ì› ì§€ì›)
                    const secondaries = [];
                    for (let i = 0; i < secondaryCountPerDay; i++) {
                        const preferredSecondaryPeople = people.filter(p =>
                            !assignedToday.includes(p) &&
                            p.hasPreferredDuty(dayNumber, 'secondary') &&
                            !p.isOnVacation(dayNumber) &&
                            p.canTakeMoreDuties()
                        );

                        let secondary = null;
                        if (preferredSecondaryPeople.length > 0) {
                            secondary = preferredSecondaryPeople[0];
                        } else {
                            const secondaryCandidates = people.filter(p =>
                                !assignedToday.includes(p) &&
                                p.canDoSecondaryDuty(dayOfWeek, dayNumber, weekNumber) &&
                                (p.secondDutyPref === 'preferred' ||
                                 (p.secondDutyPref === '2nd-only' && p.canTakeMoreDuties()) ||
                                 (p.secondDutyPref === 'limited' && p.secondaryCount < 1) ||
                                 (p.secondDutyPref === 'normal' && p.canTakeMoreDuties())) &&
                                !isConsecutive(tempSchedule, p.name, day)
                            ).sort((a, b) => {
                                if (a.secondDutyPref === 'preferred' && b.secondDutyPref !== 'preferred') return -1;
                                if (b.secondDutyPref === 'preferred' && a.secondDutyPref !== 'preferred') return 1;
                                if (a.secondDutyPref === '2nd-only' && b.secondDutyPref !== '2nd-only' && b.secondDutyPref !== 'preferred') return -1;
                                if (b.secondDutyPref === '2nd-only' && a.secondDutyPref !== '2nd-only' && a.secondDutyPref !== 'preferred') return 1;
                                if (a.maxDuties === b.maxDuties) {
                                    return a.getTotalDuties() - b.getTotalDuties();
                                }
                                return a.secondaryCount - b.secondaryCount;
                            });

                            if (secondaryCandidates.length === 0) {
                                success = false;
                                break;
                            }

                            const topCandidates = secondaryCandidates.slice(0, Math.min(3, secondaryCandidates.length));
                            secondary = topCandidates[Math.floor(Math.random() * topCandidates.length)];
                        }

                        if (secondary) {
                            secondaries.push(secondary);
                            assignedToday.push(secondary);
                            secondary.secondaryCount++;
                        } else {
                            success = false;
                            break;
                        }
                    }

                    if (!success) break;

                    tempSchedule.push({
                        day: dayNumber,
                        week: weekNumber,
                        dayOfWeek: dayOfWeek,
                        primaries: primaries.map(p => p.name),
                        secondaries: secondaries.map(p => p.name)
                    });
                }

                if (success && !isDuplicateSchedule(tempSchedule, schedules)) {
                    schedules.push(JSON.parse(JSON.stringify(tempSchedule)));
                }
            }

            if (schedules.length === 0) {
                let errorMsg = 'ë‹¹ì§í‘œ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\n';
                errorMsg += `âŒ ${totalAttempts}ë²ˆ ì‹œë„í–ˆì§€ë§Œ ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” ë‹¹ì§í‘œë¥¼ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.\n\n`;
                errorMsg += `ğŸ’¡ í•´ê²° ë°©ë²•:\n`;
                errorMsg += `- ìµœëŒ€ ë‹¹ì§ íšŸìˆ˜ë¥¼ ëŠ˜ë ¤ì£¼ì„¸ìš”\n`;
                errorMsg += `- ë¶ˆê°€ëŠ¥í•œ ìš”ì¼ ìˆ˜ë¥¼ ì¤„ì—¬ì£¼ì„¸ìš”\n`;
                errorMsg += `- ì¸ì›ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”\n`;
                errorMsg += `- íœ´ê°€ ê¸°ê°„ì„ ì¡°ì •í•´ì£¼ì„¸ìš”\n`;
                errorMsg += `- ì£¼ë³„ ì œì•½ ì¡°ê±´ì„ ì™„í™”í•´ì£¼ì„¸ìš”\n`;
                errorMsg += `- ì¼ë³„ ë‹¹ì§ ì¸ì› ìˆ˜ë¥¼ ì¤„ì—¬ì£¼ì„¸ìš”`;

                alert(errorMsg);
                showMessage('ë‹¹ì§í‘œ ìƒì„± ì‹¤íŒ¨', 'error');
                return;
            }

            currentScheduleIndex = 0;
            schedule = schedules[currentScheduleIndex];

            // Recalculate counts for display
            recalculateCounts();

            peopleModifiedAfterSchedule = false;
            updateScheduleWarning();
            showMessage(`${schedules.length}ê°œì˜ ë‹¤ë¥¸ ë‹¹ì§í‘œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤! (ì´ ${totalAttempts}ë²ˆ ì‹œë„)`, 'success');
            document.getElementById('scheduleNavigation').style.display = 'block';
            updateScheduleInfo();
            renderCalendar();
            renderStatistics();
        }

        // Check if schedule is duplicate
        function isDuplicateSchedule(newSchedule, existingSchedules) {
            return existingSchedules.some(existing => {
                return existing.every((day, index) => {
                    const newDay = newSchedule[index];
                    // ë°°ì—´ í˜•íƒœ (ë‹¤ì¤‘ ì¸ì›)
                    if (Array.isArray(day.primaries)) {
                        return JSON.stringify(day.primaries) === JSON.stringify(newDay.primaries) &&
                               JSON.stringify(day.secondaries) === JSON.stringify(newDay.secondaries);
                    }
                    // ê¸°ì¡´ í˜•íƒœ (ë‹¨ì¼ ì¸ì›)
                    return day.primary === newDay.primary && day.secondary === newDay.secondary;
                });
            });
        }

        // Navigate to previous schedule
        function previousSchedule() {
            if (schedules.length === 0) return;
            currentScheduleIndex = (currentScheduleIndex - 1 + schedules.length) % schedules.length;
            schedule = schedules[currentScheduleIndex];
            recalculateCounts();
            updateScheduleInfo();
            renderCalendar();
            renderStatistics();
        }

        // Navigate to next schedule
        function nextSchedule() {
            if (schedules.length === 0) return;
            currentScheduleIndex = (currentScheduleIndex + 1) % schedules.length;
            schedule = schedules[currentScheduleIndex];
            recalculateCounts();
            updateScheduleInfo();
            renderCalendar();
            renderStatistics();
        }

        // Update schedule navigation info
        function updateScheduleInfo() {
            const info = document.getElementById('scheduleInfo');
            info.textContent = `${currentScheduleIndex + 1} / ${schedules.length}`;
        }

        // Check if assignment would be consecutive
        function isConsecutive(schedule, personName, currentDay) {
            if (currentDay === 0) return false;

            const previousDay = schedule[currentDay - 1];
            if (!previousDay) return false;

            // ë°°ì—´ í˜•íƒœ ì§€ì› (ë‹¤ì¤‘ ì¸ì›)
            if (Array.isArray(previousDay.primaries)) {
                return previousDay.primaries.includes(personName) || previousDay.secondaries.includes(personName);
            }
            // ê¸°ì¡´ ë‹¨ì¼ ì¸ì› í˜•íƒœ ì§€ì› (í•˜ìœ„ í˜¸í™˜)
            return previousDay.primary === personName || previousDay.secondary === personName;
        }

        // Current editing day
        let editingDayIndex = null;

        // ìŠ¤ì¼€ì¤„ì˜ Day ë²ˆí˜¸ë¡œ ì¸ë±ìŠ¤ ì°¾ê¸°
        function findScheduleIndex(dayNumber) {
            if (!schedule) return -1;
            return schedule.findIndex(d => d.day === dayNumber);
        }

        // Render calendar - 7ì¼ ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒìœ¼ë¡œ ë³€ê²½
        function renderCalendar() {
            const calendarDiv = document.getElementById('calendar');
            if (!schedule || schedule.length === 0) {
                calendarDiv.innerHTML = '';
                return;
            }

            const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
            const firstDayOfWeek = new Date(currentYear, currentMonth - 1, 1).getDay();

            // Day ë²ˆí˜¸ë¥¼ ë‚ ì§œì— ë§¤í•‘
            const dayToDateMap = {};
            let dayCounter = 0;
            for (let d = 1; d <= daysInMonth; d++) {
                const date = new Date(currentYear, currentMonth - 1, d);
                const dow = date.getDay();
                if (dow >= 1 && dow <= 5) { // í‰ì¼ë§Œ
                    dayCounter++;
                    if (dayCounter <= TOTAL_DAYS) {
                        dayToDateMap[d] = dayCounter;
                    }
                }
            }

            let html = '<div class="calendar">';

            // ìš”ì¼ í—¤ë”
            DAYS_OF_WEEK_FULL.forEach((day, i) => {
                let headerClass = 'calendar-day-header';
                if (i === 0) headerClass += ' sunday';
                if (i === 6) headerClass += ' saturday';
                html += `<div class="${headerClass}">${day}</div>`;
            });

            // ë¹ˆ ì¹¸ (ì›” ì‹œì‘ ì „)
            for (let i = 0; i < firstDayOfWeek; i++) {
                html += '<div class="calendar-day empty"></div>';
            }

            // ë‚ ì§œ ì¹¸
            for (let dateNum = 1; dateNum <= daysInMonth; dateNum++) {
                const date = new Date(currentYear, currentMonth - 1, dateNum);
                const dayOfWeek = date.getDay();
                const holidayName = getHolidayName(currentYear, currentMonth, dateNum);
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                const dayNumber = dayToDateMap[dateNum]; // Day 1, Day 2 ë“±

                let dayClass = 'calendar-day';
                let numberClass = 'day-number-display';

                if (dayOfWeek === 0) {
                    dayClass += ' sunday';
                    numberClass += ' sunday';
                } else if (dayOfWeek === 6) {
                    dayClass += ' saturday';
                    numberClass += ' saturday';
                }

                if (holidayName) {
                    dayClass += ' holiday';
                    numberClass += ' holiday';
                }

                // ìŠ¤ì¼€ì¤„ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const scheduleIndex = dayNumber ? findScheduleIndex(dayNumber) : -1;
                const dayData = scheduleIndex >= 0 ? schedule[scheduleIndex] : null;

                const isEditing = editingDayIndex === scheduleIndex && scheduleIndex >= 0;
                const editableClass = dayData ? 'editable' : '';
                const manuallyEditedClass = dayData?.manuallyEdited ? 'manually-edited' : '';
                const editModeClass = isEditing ? 'edit-mode' : '';

                html += `<div class="${dayClass} ${editableClass} ${manuallyEditedClass} ${editModeClass}"`;

                if (dayData && !isEditing) {
                    html += ` onclick="editDay(${scheduleIndex})"`;
                }

                html += '>';

                // ê³µíœ´ì¼ ì´ë¦„
                if (holidayName) {
                    html += `<div class="holiday-name">${holidayName}</div>`;
                }

                // ìˆ˜ë™ í¸ì§‘ ë°°ì§€
                if (dayData?.manuallyEdited) {
                    html += '<div class="manual-edit-badge">ìˆ˜ì •</div>';
                }

                // ë‚ ì§œ ìˆ«ì
                html += `<div class="${numberClass}">${dateNum}</div>`;

                if (isWeekend) {
                    // ì£¼ë§
                    html += '<div class="day-info" style="color: #aaa; font-size: 10px;">íœ´ë¬´</div>';
                } else if (dayData) {
                    // í‰ì¼ - ë‹¹ì§ ì •ë³´ í‘œì‹œ
                    const primaries = Array.isArray(dayData.primaries) ? dayData.primaries : [dayData.primary];
                    const secondaries = Array.isArray(dayData.secondaries) ? dayData.secondaries : [dayData.secondary];

                    if (isEditing) {
                        // í¸ì§‘ ëª¨ë“œ
                        let editHTML = '<div class="edit-controls" style="margin-top: 5px;">';

                        primaries.forEach((name, i) => {
                            editHTML += `
                                <div style="margin-bottom: 3px;">
                                    <label style="font-size: 10px; margin: 0; color: #e74c3c;">ë‹¹ì§${primaries.length > 1 ? (i + 1) : ''}</label>
                                    <select id="editPrimary_${scheduleIndex}_${i}" style="font-size: 11px; padding: 3px;">
                                        ${people.map(p => `<option value="${p.name}" ${p.name === name ? 'selected' : ''}>${p.name}</option>`).join('')}
                                    </select>
                                </div>
                            `;
                        });

                        secondaries.forEach((name, i) => {
                            editHTML += `
                                <div style="margin-bottom: 3px;">
                                    <label style="font-size: 10px; margin: 0; color: #3498db;">2nd${secondaries.length > 1 ? (i + 1) : ''}</label>
                                    <select id="editSecondary_${scheduleIndex}_${i}" style="font-size: 11px; padding: 3px;">
                                        ${people.map(p => `<option value="${p.name}" ${p.name === name ? 'selected' : ''}>${p.name}</option>`).join('')}
                                    </select>
                                </div>
                            `;
                        });

                        editHTML += `
                            <div style="margin-top: 5px;">
                                <button onclick="saveEdit(${scheduleIndex})" style="background: #27ae60; padding: 3px 8px; font-size: 10px;">ì €ì¥</button>
                                <button onclick="cancelEdit()" class="secondary" style="padding: 3px 8px; font-size: 10px;">ì·¨ì†Œ</button>
                            </div>
                        </div>`;

                        html += editHTML;
                    } else {
                        // í‘œì‹œ ëª¨ë“œ
                        html += `<div class="day-info" style="font-size: 10px; color: #888;">Day ${dayNumber}</div>`;
                        html += '<div class="duty-assignment" style="font-size: 11px; margin-top: 3px;">';
                        primaries.forEach(name => {
                            html += `<div class="duty-primary" style="font-size: 11px;">ğŸ”´ ${name}</div>`;
                        });
                        secondaries.forEach(name => {
                            if (name) html += `<div class="duty-secondary" style="font-size: 11px;">ğŸ”µ ${name}</div>`;
                        });
                        html += '</div>';

                        // íœ´ê°€ì í‘œì‹œ
                        const vacationers = people.filter(p => p.isOnVacation(dayNumber)).map(p => p.name);
                        if (vacationers.length > 0) {
                            html += `<div class="vacation-indicator" style="font-size: 9px; padding: 2px;">ğŸ–ï¸ ${vacationers.join(', ')}</div>`;
                        }
                    }
                } else if (!isWeekend && dayNumber) {
                    // í‰ì¼ì´ì§€ë§Œ ìŠ¤ì¼€ì¤„ ì—†ìŒ
                    html += `<div class="day-info" style="font-size: 10px; color: #888;">Day ${dayNumber}</div>`;
                    html += '<div style="font-size: 10px; color: #ccc;">ë¯¸ë°°ì •</div>';
                }

                html += '</div>';
            }

            // ë¹ˆ ì¹¸ (ì›” ë í›„)
            const totalCells = firstDayOfWeek + daysInMonth;
            const remainingCells = (7 - (totalCells % 7)) % 7;
            for (let i = 0; i < remainingCells; i++) {
                html += '<div class="calendar-day empty"></div>';
            }

            html += '</div>';
            calendarDiv.innerHTML = html;
        }

        // Edit day
        function editDay(dayIndex) {
            if (editingDayIndex !== null) {
                cancelEdit();
            }
            editingDayIndex = dayIndex;
            renderCalendar();
        }

        // Cancel edit
        function cancelEdit() {
            editingDayIndex = null;
            renderCalendar();
        }

        // Save edit with comprehensive validation
        function saveEdit(dayIndex) {
            const day = schedule[dayIndex];
            const dayOfWeek = day.dayOfWeek;
            const dayNumber = day.day;
            const weekNumber = day.week;

            // í˜„ì¬ ë°°ì—´ í˜•íƒœì¸ì§€ í™•ì¸
            const currentPrimaries = Array.isArray(day.primaries) ? day.primaries : [day.primary];
            const currentSecondaries = Array.isArray(day.secondaries) ? day.secondaries : [day.secondary];

            // ìƒˆë¡œìš´ ê°’ ìˆ˜ì§‘
            const newPrimaries = [];
            for (let i = 0; i < currentPrimaries.length; i++) {
                const select = document.getElementById(`editPrimary_${dayIndex}_${i}`);
                if (select) newPrimaries.push(select.value);
            }

            const newSecondaries = [];
            for (let i = 0; i < currentSecondaries.length; i++) {
                const select = document.getElementById(`editSecondary_${dayIndex}_${i}`);
                if (select) newSecondaries.push(select.value);
            }

            // ì¤‘ë³µ ì²´í¬
            const allSelected = [...newPrimaries, ...newSecondaries];
            const uniqueSelected = new Set(allSelected);
            if (uniqueSelected.size !== allSelected.length) {
                showMessage('âŒ ê°™ì€ ì‚¬ëŒì´ ì—¬ëŸ¬ ë²ˆ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤. ì¤‘ë³µì„ ì œê±°í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            // Collect all warnings
            const warnings = [];

            // Validate primary duty assignments
            newPrimaries.forEach((name, idx) => {
                const person = people.find(p => p.name === name);
                if (person) {
                    if (person.secondDutyPref === '2nd-only') {
                        warnings.push(`âš ï¸ ${name}ë‹˜ì€ "2nd dutyë§Œ" ê°€ëŠ¥í•œ ì„¤ì •ì…ë‹ˆë‹¤.`);
                    }
                    if (person.isOnVacation(dayNumber)) {
                        warnings.push(`âš ï¸ ${name}ë‹˜ì€ Day ${dayNumber}ì— íœ´ê°€ ì¤‘ì…ë‹ˆë‹¤.`);
                    }
                    if (!person.canDoPrimaryDuty(dayOfWeek, dayNumber, weekNumber)) {
                        warnings.push(`âš ï¸ ${name}ë‹˜ì€ ${dayOfWeek}ìš”ì¼ì— ë‹¹ì§ì„ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                    }
                    if (isConsecutive(schedule, name, dayIndex)) {
                        warnings.push(`âš ï¸ ${name}ë‹˜ì€ ì—°ì† ë‹¹ì§ì´ ë©ë‹ˆë‹¤.`);
                    }
                }
            });

            // Validate secondary duty assignments
            newSecondaries.forEach((name, idx) => {
                const person = people.find(p => p.name === name);
                if (person) {
                    if (person.isOnVacation(dayNumber)) {
                        warnings.push(`âš ï¸ ${name}ë‹˜ì€ Day ${dayNumber}ì— íœ´ê°€ ì¤‘ì…ë‹ˆë‹¤.`);
                    }
                    if (!person.canDoSecondaryDuty(dayOfWeek, dayNumber, weekNumber)) {
                        warnings.push(`âš ï¸ ${name}ë‹˜ì€ ${dayOfWeek}ìš”ì¼ì— 2nd dutyë¥¼ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                    }
                    if (isConsecutive(schedule, name, dayIndex)) {
                        warnings.push(`âš ï¸ ${name}ë‹˜ì€ ì—°ì† ë‹¹ì§ì´ ë©ë‹ˆë‹¤.`);
                    }
                }
            });

            // ì„ì‹œë¡œ ì—…ë°ì´íŠ¸í•˜ì—¬ íšŸìˆ˜ ì²´í¬
            const tempOldPrimaries = day.primaries;
            const tempOldSecondaries = day.secondaries;
            const tempOldPrimary = day.primary;
            const tempOldSecondary = day.secondary;

            day.primaries = newPrimaries;
            day.secondaries = newSecondaries;
            delete day.primary;
            delete day.secondary;
            recalculateCounts();

            // Check max duty violations
            [...newPrimaries, ...newSecondaries].forEach(name => {
                const person = people.find(p => p.name === name);
                if (person && person.secondDutyPref !== 'preferred') {
                    const totalDuties = person.primaryCount + person.secondaryCount;
                    if (totalDuties > person.maxDuties) {
                        warnings.push(`âš ï¸ ${name}ë‹˜ì˜ ë‹¹ì§ íšŸìˆ˜ê°€ ìµœëŒ€ì¹˜(${person.maxDuties}íšŒ)ë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤. (í˜„ì¬: ${totalDuties}íšŒ)`);
                    }
                }
            });

            // If there are warnings, show them and ask for confirmation
            if (warnings.length > 0) {
                const warningMessage = warnings.join('\n\n');
                const confirmMessage = warningMessage + '\n\nê³„ì† ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?';

                if (!confirm(confirmMessage)) {
                    // Revert changes
                    if (tempOldPrimaries) {
                        day.primaries = tempOldPrimaries;
                        day.secondaries = tempOldSecondaries;
                    } else {
                        day.primary = tempOldPrimary;
                        day.secondary = tempOldSecondary;
                        delete day.primaries;
                        delete day.secondaries;
                    }
                    recalculateCounts();
                    return;
                }
            }

            // Mark as manually edited
            day.manuallyEdited = true;

            editingDayIndex = null;
            renderCalendar();
            renderStatistics();
            showMessage(`âœ… Day ${day.day} ë‹¹ì§ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
        }

        // Recalculate duty counts
        function recalculateCounts() {
            // Reset all counts
            people.forEach(p => {
                p.primaryCount = 0;
                p.secondaryCount = 0;
            });

            // Count from schedule
            schedule.forEach(day => {
                // ë°°ì—´ í˜•íƒœ (ë‹¤ì¤‘ ì¸ì›)
                if (Array.isArray(day.primaries)) {
                    day.primaries.forEach(name => {
                        const person = people.find(p => p.name === name);
                        if (person) person.primaryCount++;
                    });
                    day.secondaries.forEach(name => {
                        const person = people.find(p => p.name === name);
                        if (person) person.secondaryCount++;
                    });
                } else {
                    // ê¸°ì¡´ í˜•íƒœ (ë‹¨ì¼ ì¸ì›)
                    const primaryPerson = people.find(p => p.name === day.primary);
                    const secondaryPerson = people.find(p => p.name === day.secondary);

                    if (primaryPerson) primaryPerson.primaryCount++;
                    if (secondaryPerson) secondaryPerson.secondaryCount++;
                }
            });
        }

        // Render statistics
        function renderStatistics() {
            const statsDiv = document.getElementById('statistics');
            if (!schedule || schedule.length === 0) {
                statsDiv.innerHTML = '';
                return;
            }

            let html = '<div class="stats"><h3>ğŸ“Š í†µê³„</h3><div class="stats-grid">';
            people.forEach(person => {
                const total = person.primaryCount + person.secondaryCount;
                const isOverMax = total > person.maxDuties;
                const totalColor = isOverMax ? 'color: #e74c3c; font-weight: bold;' : '';
                const warningIcon = isOverMax ? ' âš ï¸' : '';

                html += `
                    <div class="stat-item" style="${isOverMax ? 'border: 2px solid #e74c3c; background: #ffe6e6;' : ''}">
                        <strong>${person.name}</strong> (ìµœëŒ€: ${person.maxDuties}íšŒ)${warningIcon}<br>
                        <span class="small-text">
                            ë‹¹ì§: ${person.primaryCount}íšŒ |
                            2nd: ${person.secondaryCount}íšŒ |
                            <span style="${totalColor}">ì´: ${total}íšŒ</span>
                        </span>
                    </div>
                `;
            });
            html += '</div></div>';
            statsDiv.innerHTML = html;
        }

        // Show message
        function showMessage(msg, type = 'info') {
            const messagesDiv = document.getElementById('messages');
            const alertClass = type === 'error' ? 'alert-error' :
                              type === 'success' ? 'alert-success' : 'alert-info';
            messagesDiv.innerHTML = `<div class="alert ${alertClass}">${msg}</div>`;
            setTimeout(() => {
                messagesDiv.innerHTML = '';
            }, 5000);
        }

        // Export schedule
        function exportSchedule() {
            if (!schedule || schedule.length === 0) {
                showMessage('ë¨¼ì € ë‹¹ì§í‘œë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            let text = 'ë³‘ì› ë‹¹ì§í‘œ\n\n';

            // Schedule
            schedule.forEach(day => {
                const vacationers = people.filter(p => p.isOnVacation(day.day)).map(p => p.name);
                let vacInfo = vacationers.length > 0 ? ` (íœ´ê°€: ${vacationers.join(', ')})` : '';
                let editInfo = day.manuallyEdited ? ' [ìˆ˜ë™í¸ì§‘]' : '';

                // ë°°ì—´ í˜•íƒœì™€ ë‹¨ì¼ í˜•íƒœ ëª¨ë‘ ì§€ì›
                const primaries = Array.isArray(day.primaries) ? day.primaries : [day.primary];
                const secondaries = Array.isArray(day.secondaries) ? day.secondaries : [day.secondary];

                text += `Day ${day.day} (${day.dayOfWeek}): ë‹¹ì§ ${primaries.join(', ')}, 2nd ${secondaries.join(', ')}${vacInfo}${editInfo}\n`;
            });

            // Statistics
            text += '\ní†µê³„:\n';
            people.forEach(person => {
                let vacText = '';
                if (person.vacations && person.vacations.length > 0) {
                    const vacList = person.vacations.map(v => {
                        if (v.startDate) return `${v.startDate}~${v.endDate}`;
                        return `Day ${v.start}-${v.end}`;
                    }).join(', ');
                    vacText = ` (íœ´ê°€: ${vacList})`;
                }

                let weeklyText = '';
                if (person.weeklyRestrictions && Object.keys(person.weeklyRestrictions).length > 0) {
                    const weeklyList = Object.keys(person.weeklyRestrictions).sort().map(weekNum => {
                        const r = person.weeklyRestrictions[weekNum];
                        const unavail = r.unavailable && r.unavailable.length > 0 ? r.unavailable.join(',') : '';
                        const alt = r.alternative && r.alternative.length > 0 ? `(2nd:${r.alternative.join(',')})` : '';
                        return `${weekNum}ì£¼:${unavail}${alt}`;
                    }).join(', ');
                    weeklyText = ` (ì£¼ë³„ì œì•½: ${weeklyList})`;
                }

                text += `${person.name}: ë‹¹ì§ ${person.primaryCount}íšŒ, 2nd ${person.secondaryCount}íšŒ, ì´ ${person.getTotalDuties()}íšŒ${vacText}${weeklyText}\n`;
            });

            // Manual edits summary
            const manualEdits = schedule.filter(d => d.manuallyEdited);
            if (manualEdits.length > 0) {
                text += '\nìˆ˜ë™ í¸ì§‘ëœ ë‚ ì§œ:\n';
                manualEdits.forEach(day => {
                    text += `- Day ${day.day} (${day.dayOfWeek})\n`;
                });
            }

            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ë‹¹ì§í‘œ_' + new Date().toISOString().slice(0, 10) + '.txt';
            a.click();
            URL.revokeObjectURL(url);

            showMessage('ë‹¹ì§í‘œê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }

        // Initialize
        renderPersonList();

        // Toggle edit mode for person
        function toggleEditMode(personIndex) {
            const editControls = document.getElementById(`editControls_${personIndex}`);
            const personEntry = document.getElementById(`person_${personIndex}`);

            if (editControls.style.display === 'none') {
                editControls.style.display = 'block';
                personEntry.classList.add('edit-mode');
            } else {
                editControls.style.display = 'none';
                personEntry.classList.remove('edit-mode');
            }
        }

        // Save person edit
        function savePersonEdit(personIndex) {
            const person = people[personIndex];
            const newMaxDuties = parseInt(document.getElementById(`editMaxDuties_${personIndex}`).value);
            const newSecondPref = document.getElementById(`editSecondPref_${personIndex}`).value;

            // ë¶ˆê°€ëŠ¥í•œ ìš”ì¼
            const newUnavailableDays = Array.from(document.querySelectorAll(`.edit-unavailable-${personIndex}:checked`))
                .map(cb => cb.value);

            // ëŒ€ì²´ ê°€ëŠ¥ ìš”ì¼
            const newAlternativeDays = Array.from(document.querySelectorAll(`.edit-alternative-${personIndex}:checked`))
                .map(cb => cb.value);

            if (newMaxDuties < 1 || newMaxDuties > 20) {
                showMessage('ìµœëŒ€ ë‹¹ì§ íšŸìˆ˜ëŠ” 1~20 ì‚¬ì´ì—¬ì•¼ í•©ë‹ˆë‹¤.', 'error');
                return;
            }

            person.maxDuties = newMaxDuties;
            person.secondDutyPref = newSecondPref;
            person.unavailableDays = newUnavailableDays;
            person.alternativeDays = newAlternativeDays;

            renderPersonList();
            markPeopleModified();
            showMessage(`${person.name}ë‹˜ì˜ ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
        }
    </script>
</body>
</html>
