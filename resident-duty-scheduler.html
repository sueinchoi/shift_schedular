<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì „ê³µì˜ ë‹¹ì§í‘œ ìƒì„±ê¸° (12ì‹œê°„ ë‹¨ìœ„)</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f6fa;
        }

        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }

        h2 {
            color: #34495e;
            margin-top: 20px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            font-size: 18px;
        }

        .container {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .input-section {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .result-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* ì¸ì› ëª©ë¡ */
        #personList {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 300px;
            overflow-y: auto;
        }

        .person-entry {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            border-left: 4px solid #3498db;
            cursor: pointer;
            transition: all 0.2s;
        }

        .person-entry:hover {
            background: #e8f4fc;
        }

        .person-entry.edit-mode {
            border: 2px solid #3498db;
            cursor: default;
        }

        .person-entry h4 {
            margin: 0 0 5px 0;
            font-size: 14px;
            color: #2c3e50;
        }

        .person-entry .info {
            font-size: 11px;
            color: #666;
        }

        .edit-form-field {
            margin-bottom: 10px;
        }

        .edit-form-field label {
            display: block;
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 3px;
            color: #555;
        }

        .edit-form-field input {
            width: 100%;
            padding: 6px;
            font-size: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .edit-buttons {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }

        .edit-buttons button {
            flex: 1;
            padding: 6px;
            font-size: 11px;
        }

        label {
            display: block;
            margin: 8px 0 4px 0;
            font-weight: 500;
            color: #555;
            font-size: 13px;
        }

        input[type="text"],
        input[type="number"],
        input[type="month"],
        select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }

        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: background 0.3s;
            margin: 3px;
        }

        button:hover {
            background: #2980b9;
        }

        button.secondary {
            background: #95a5a6;
        }

        button.secondary:hover {
            background: #7f8c8d;
        }

        button.danger {
            background: #e74c3c;
        }

        button.danger:hover {
            background: #c0392b;
        }

        button.success {
            background: #27ae60;
        }

        button.success:hover {
            background: #219a52;
        }

        .button-group {
            text-align: center;
            margin: 15px 0;
        }

        /* ìº˜ë¦°ë” ê·¸ë¦¬ë“œ */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            background: #ddd;
            border-radius: 8px;
            overflow: hidden;
        }

        .calendar-day-header {
            background: #34495e;
            color: white;
            padding: 10px;
            text-align: center;
            font-weight: 600;
            font-size: 13px;
        }

        .calendar-day-header.sunday {
            background: #c0392b;
        }

        .calendar-day-header.saturday {
            background: #2980b9;
        }

        .calendar-day {
            background: white;
            min-height: 100px;
            padding: 5px;
            position: relative;
        }

        .calendar-day.empty {
            background: #f5f5f5;
        }

        .calendar-day.sunday {
            background: #fff5f5;
        }

        .calendar-day.saturday {
            background: #f5f8ff;
        }

        .day-number {
            font-weight: 600;
            font-size: 14px;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .shift-slot {
            padding: 4px 6px;
            margin: 2px 0;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .shift-slot:hover {
            transform: scale(1.02);
        }

        .shift-slot.day-shift {
            background: #fff9e6;
            border: 1px solid #f1c40f;
        }

        .shift-slot.night-shift {
            background: #e8eaf6;
            border: 1px solid #5c6bc0;
        }

        .shift-slot.unassigned {
            background: #ffebee;
            border: 1px solid #ef5350;
            color: #c62828;
        }

        .shift-slot.edit-mode {
            border: 2px solid #3498db;
        }

        .shift-slot.manually-edited {
            border: 2px solid #f39c12;
        }

        .shift-slot .shift-label {
            font-weight: 600;
        }

        .shift-slot .person-name {
            font-weight: 500;
        }

        .shift-slot select {
            width: 100%;
            padding: 4px;
            font-size: 11px;
            margin-top: 3px;
        }

        /* í†µê³„ */
        .stats {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }

        .stats h3 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-size: 16px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
        }

        .stat-item {
            background: white;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
            border-left: 3px solid #3498db;
        }

        .stat-item.warning {
            border-left-color: #e74c3c;
            background: #fff5f5;
        }

        .stat-item strong {
            display: block;
            color: #2c3e50;
            font-size: 13px;
        }

        .stat-item .hours {
            font-size: 18px;
            font-weight: 700;
            color: #3498db;
        }

        .stat-item.warning .hours {
            color: #e74c3c;
        }

        .stat-item .detail {
            font-size: 10px;
            color: #888;
        }

        .alert {
            padding: 12px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 13px;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
        }

        .collapsible-header {
            background: #ecf0f1;
            padding: 10px 12px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            font-size: 13px;
            color: #2c3e50;
        }

        .collapsible-header:hover {
            background: #e0e5e7;
        }

        .collapsible-content {
            padding: 12px;
            background: #fafafa;
            border: 1px solid #ecf0f1;
            border-top: none;
            border-radius: 0 0 5px 5px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        .tag {
            display: inline-block;
            padding: 2px 6px;
            background: #e8f4fc;
            color: #2980b9;
            border-radius: 3px;
            font-size: 10px;
            margin: 1px;
        }

        .tag.vacation {
            background: #fef5e7;
            color: #d35400;
        }

        .constraint-warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 4px;
            padding: 8px;
            margin: 10px 0;
            font-size: 12px;
        }

        .constraint-warning strong {
            color: #856404;
        }

        #scheduleNavigation {
            text-align: center;
            margin: 15px 0;
            padding: 12px;
            background: #f0f8ff;
            border-radius: 8px;
        }

        #scheduleNavigation span {
            margin: 0 15px;
            font-weight: 600;
            color: #2c3e50;
        }

        .small-text {
            font-size: 11px;
            color: #888;
        }

        .legend {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
        }

        .legend-color {
            width: 20px;
            height: 14px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <h1>ğŸ¥ ì „ê³µì˜ ë‹¹ì§í‘œ ìƒì„±ê¸° (12ì‹œê°„ ë‹¨ìœ„)</h1>

    <div class="container">
        <!-- ì‚¬ì´ë“œë°”: ì¸ì› ê´€ë¦¬ ë° ì„¤ì • -->
        <div class="sidebar">
            <!-- ê¸°ê°„ ì„¤ì • -->
            <div class="input-section">
                <h2>ğŸ“… ê¸°ê°„ ì„¤ì •</h2>
                <label>ëŒ€ìƒ ì›”</label>
                <input type="month" id="targetMonth" onchange="updateCalendar()">
            </div>

            <!-- ì œì•½ ì¡°ê±´ ì„¤ì • -->
            <div class="input-section">
                <h2>âš™ï¸ ì œì•½ ì¡°ê±´</h2>
                <div class="form-row">
                    <div>
                        <label>ì—°ì† ìµœëŒ€ (ì‹œê°„)</label>
                        <input type="number" id="maxConsecutiveHours" value="36" min="12" max="72" step="12">
                    </div>
                    <div>
                        <label>ì£¼ê°„ ìµœëŒ€ (ì‹œê°„)</label>
                        <input type="number" id="maxWeeklyHours" value="72" min="12" max="168" step="12">
                    </div>
                </div>
                <div>
                    <label>ìŠ¬ë¡¯ë‹¹ ì¸ì› ìˆ˜</label>
                    <input type="number" id="peoplePerSlot" value="1" min="1" max="5">
                </div>
                <p class="small-text" style="margin-top: 10px;">
                    * 12ì‹œê°„ = 1ìŠ¬ë¡¯, 36ì‹œê°„ = 3ìŠ¬ë¡¯ ì—°ì†<br>
                    * 72ì‹œê°„/ì£¼ = ì£¼ë‹¹ ìµœëŒ€ 6ìŠ¬ë¡¯
                </p>
            </div>

            <!-- ì¸ì› ê´€ë¦¬ -->
            <div class="input-section">
                <h2>ğŸ‘¥ ì¸ì› ê´€ë¦¬</h2>

                <div class="collapsible-header" onclick="toggleSection('addPersonSection')">
                    â• ìƒˆ ì¸ì› ì¶”ê°€
                    <span id="addPersonToggle">â–¼</span>
                </div>
                <div id="addPersonSection" class="collapsible-content" style="display: none;">
                    <div class="edit-form-field">
                        <label>ì´ë¦„</label>
                        <input type="text" id="personName" placeholder="ì´ë¦„ ì…ë ¥">
                    </div>
                    <div class="edit-form-field">
                        <label>íœ´ê°€ì¼ (ì‰¼í‘œ êµ¬ë¶„, ì˜ˆ: 1,5,15)</label>
                        <input type="text" id="vacationDays" placeholder="1,5,15">
                    </div>
                    <div class="edit-form-field">
                        <label>ì„ í˜¸ ê·¼ë¬´ì¼ (ì‰¼í‘œ êµ¬ë¶„)</label>
                        <input type="text" id="preferredDays" placeholder="10,20">
                    </div>
                    <button onclick="addPerson()">ì¸ì› ì¶”ê°€</button>
                </div>

                <div style="margin-top: 10px; display: flex; gap: 5px; flex-wrap: wrap;">
                    <button onclick="loadSampleData()" class="secondary" style="font-size: 11px; padding: 6px 10px;">ğŸ“‹ ì˜ˆì‹œ</button>
                    <button onclick="downloadJSON()" class="secondary" style="font-size: 11px; padding: 6px 10px;">ğŸ’¾ ì €ì¥</button>
                    <label style="display: inline-block; margin: 0;">
                        <input type="file" id="uploadFile" accept=".json" onchange="uploadJSON(event)" style="display: none;">
                        <button onclick="document.getElementById('uploadFile').click()" class="secondary" style="font-size: 11px; padding: 6px 10px;">ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                    </label>
                    <button onclick="clearAllData()" class="danger" style="font-size: 11px; padding: 6px 10px;">ğŸ—‘ï¸</button>
                </div>

                <div style="margin-top: 10px;">
                    <strong style="font-size: 12px;">ë“±ë¡ ì¸ì›: <span id="personCount">0</span>ëª…</strong>
                </div>
                <div id="personList" style="margin-top: 10px;">
                    <p class="small-text">ì¸ì›ì„ ì¶”ê°€í•˜ê±°ë‚˜ ì˜ˆì‹œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.</p>
                </div>
            </div>
        </div>

        <!-- ë©”ì¸: ìº˜ë¦°ë” ë° ê²°ê³¼ -->
        <div class="result-section">
            <div class="calendar-header">
                <h2 style="margin: 0; border: none; padding: 0;">ğŸ“… <span id="calendarTitle">2024ë…„ 1ì›”</span> ë‹¹ì§í‘œ</h2>
                <div>
                    <button onclick="prevMonth()" class="secondary" style="padding: 6px 12px;">â—€ ì´ì „ë‹¬</button>
                    <button onclick="nextMonth()" class="secondary" style="padding: 6px 12px;">ë‹¤ìŒë‹¬ â–¶</button>
                </div>
            </div>

            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #fff9e6; border: 1px solid #f1c40f;"></div>
                    <span>ì£¼ê°„ (06-18ì‹œ)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #e8eaf6; border: 1px solid #5c6bc0;"></div>
                    <span>ì•¼ê°„ (18-06ì‹œ)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ffebee; border: 1px solid #ef5350;"></div>
                    <span>ë¯¸ë°°ì •</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="border: 2px solid #f39c12; background: white;"></div>
                    <span>ìˆ˜ë™í¸ì§‘</span>
                </div>
            </div>

            <div id="scheduleWarning" class="alert alert-error" style="display: none;">
                âš ï¸ <strong>ì¸ì› ì •ë³´ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.</strong> ë³€ê²½ëœ ì •ë³´ë¥¼ ë°˜ì˜í•˜ë ¤ë©´ ë‹¹ì§í‘œë¥¼ ë‹¤ì‹œ ìƒì„±í•´ì£¼ì„¸ìš”.
            </div>

            <div class="button-group">
                <button onclick="generateSchedule()">ğŸ¯ ë‹¹ì§í‘œ ìƒì„±</button>
                <button onclick="generateMultipleSchedules()">ğŸ”„ ì—¬ëŸ¬ ê²½ìš° ìƒì„± (5ê°œ)</button>
                <button onclick="exportSchedule()" class="secondary">ğŸ’¾ ë‚´ë³´ë‚´ê¸°</button>
            </div>

            <div id="scheduleNavigation" style="display: none;">
                <button onclick="prevSchedule()" class="secondary" style="padding: 6px 12px;">â—€ ì´ì „</button>
                <span id="scheduleIndicator">1 / 5</span>
                <button onclick="nextSchedule()" class="secondary" style="padding: 6px 12px;">ë‹¤ìŒ â–¶</button>
            </div>

            <div id="constraintWarnings"></div>
            <div id="messages"></div>

            <div id="calendarGrid" class="calendar-grid"></div>

            <div id="statistics"></div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë°ì´í„°
        let people = [];
        let schedule = null; // { 'YYYY-MM-DD': { day: [names], night: [names], dayEdited: bool, nightEdited: bool } }
        let schedules = [];
        let currentScheduleIndex = 0;
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth() + 1;
        let editingPersonIndex = null;
        let editingSlot = null; // { date: 'YYYY-MM-DD', shift: 'day'|'night' }
        let peopleModifiedAfterSchedule = false;

        const SHIFT_HOURS = 12;
        const DAY_NAMES = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            currentYear = today.getFullYear();
            currentMonth = today.getMonth() + 1;
            document.getElementById('targetMonth').value = `${currentYear}-${String(currentMonth).padStart(2, '0')}`;
            updateCalendar();
        });

        // Person í´ë˜ìŠ¤
        class Person {
            constructor(name, vacationDays = [], preferredDays = []) {
                this.name = name;
                this.vacationDays = vacationDays; // [1, 5, 15] ë“± í•´ë‹¹ ì›”ì˜ ì¼ì
                this.preferredDays = preferredDays;
                this.monthlyHours = 0; // ì›”ê°„ ê·¼ë¬´ ì‹œê°„
            }

            isOnVacation(day) {
                return this.vacationDays.includes(day);
            }

            hasPreferredDay(day) {
                return this.preferredDays.includes(day);
            }
        }

        // ì„¹ì…˜ í† ê¸€
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const toggle = document.getElementById(sectionId.replace('Section', 'Toggle'));
            if (section.style.display === 'none') {
                section.style.display = 'block';
                if (toggle) toggle.textContent = 'â–²';
            } else {
                section.style.display = 'none';
                if (toggle) toggle.textContent = 'â–¼';
            }
        }

        // ì¸ì› ì¶”ê°€
        function addPerson() {
            const name = document.getElementById('personName').value.trim();
            const vacationStr = document.getElementById('vacationDays').value.trim();
            const preferredStr = document.getElementById('preferredDays').value.trim();

            if (!name) {
                showMessage('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            if (people.some(p => p.name === name)) {
                showMessage('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì´ë¦„ì…ë‹ˆë‹¤.', 'error');
                return;
            }

            const vacationDays = vacationStr ? vacationStr.split(',').map(d => parseInt(d.trim())).filter(d => !isNaN(d) && d >= 1 && d <= 31) : [];
            const preferredDays = preferredStr ? preferredStr.split(',').map(d => parseInt(d.trim())).filter(d => !isNaN(d) && d >= 1 && d <= 31) : [];

            people.push(new Person(name, vacationDays, preferredDays));

            document.getElementById('personName').value = '';
            document.getElementById('vacationDays').value = '';
            document.getElementById('preferredDays').value = '';

            renderPersonList();
            markPeopleModified();
            showMessage(`${name}ë‹˜ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
        }

        // ì¸ì› ëª©ë¡ ë Œë”ë§
        function renderPersonList() {
            const listDiv = document.getElementById('personList');
            document.getElementById('personCount').textContent = people.length;

            if (people.length === 0) {
                listDiv.innerHTML = '<p class="small-text">ì¸ì›ì„ ì¶”ê°€í•˜ê±°ë‚˜ ì˜ˆì‹œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.</p>';
                return;
            }

            let html = '';
            people.forEach((person, index) => {
                const isEditing = editingPersonIndex === index;

                if (isEditing) {
                    html += `
                        <div class="person-entry edit-mode">
                            <div class="edit-form-field">
                                <label>ì´ë¦„</label>
                                <input type="text" id="editName_${index}" value="${person.name}" onkeydown="handlePersonKeydown(event, ${index})">
                            </div>
                            <div class="edit-form-field">
                                <label>íœ´ê°€ì¼</label>
                                <input type="text" id="editVacation_${index}" value="${person.vacationDays.join(', ')}" placeholder="1,5,15" onkeydown="handlePersonKeydown(event, ${index})">
                            </div>
                            <div class="edit-form-field">
                                <label>ì„ í˜¸ì¼</label>
                                <input type="text" id="editPreferred_${index}" value="${person.preferredDays.join(', ')}" placeholder="10,20" onkeydown="handlePersonKeydown(event, ${index})">
                            </div>
                            <div class="edit-buttons">
                                <button onclick="savePersonEdit(${index})" class="success">ì €ì¥</button>
                                <button onclick="cancelPersonEdit()" class="secondary">ì·¨ì†Œ</button>
                                <button onclick="removePerson(${index})" class="danger">ì‚­ì œ</button>
                            </div>
                        </div>
                    `;
                } else {
                    let tags = '';
                    if (person.vacationDays.length > 0) {
                        tags += `<span class="tag vacation">íœ´ê°€: ${person.vacationDays.join(',')}ì¼</span>`;
                    }
                    if (person.preferredDays.length > 0) {
                        tags += `<span class="tag">ì„ í˜¸: ${person.preferredDays.join(',')}ì¼</span>`;
                    }

                    html += `
                        <div class="person-entry" onclick="editPerson(${index})">
                            <h4>${person.name}</h4>
                            <div class="info">${tags || 'ì œì•½ ì—†ìŒ'}</div>
                        </div>
                    `;
                }
            });

            listDiv.innerHTML = html;
        }

        function editPerson(index) {
            editingPersonIndex = index;
            renderPersonList();
            setTimeout(() => {
                const input = document.getElementById(`editName_${index}`);
                if (input) input.focus();
            }, 50);
        }

        function cancelPersonEdit() {
            editingPersonIndex = null;
            renderPersonList();
        }

        function handlePersonKeydown(event, index) {
            if (event.key === 'Enter') {
                event.preventDefault();
                savePersonEdit(index);
            } else if (event.key === 'Escape') {
                cancelPersonEdit();
            }
        }

        function savePersonEdit(index) {
            const person = people[index];
            const newName = document.getElementById(`editName_${index}`).value.trim();
            const vacationStr = document.getElementById(`editVacation_${index}`).value.trim();
            const preferredStr = document.getElementById(`editPreferred_${index}`).value.trim();

            if (!newName) {
                showMessage('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            if (people.some((p, i) => i !== index && p.name === newName)) {
                showMessage('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì´ë¦„ì…ë‹ˆë‹¤.', 'error');
                return;
            }

            person.name = newName;
            person.vacationDays = vacationStr ? vacationStr.split(',').map(d => parseInt(d.trim())).filter(d => !isNaN(d) && d >= 1 && d <= 31) : [];
            person.preferredDays = preferredStr ? preferredStr.split(',').map(d => parseInt(d.trim())).filter(d => !isNaN(d) && d >= 1 && d <= 31) : [];

            editingPersonIndex = null;
            renderPersonList();
            markPeopleModified();
            showMessage(`${person.name}ë‹˜ì˜ ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
        }

        function removePerson(index) {
            const name = people[index].name;
            if (confirm(`${name}ë‹˜ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                people.splice(index, 1);
                editingPersonIndex = null;
                renderPersonList();
                markPeopleModified();
                showMessage(`${name}ë‹˜ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
            }
        }

        // ì˜ˆì‹œ ë°ì´í„° ë¡œë“œ
        function loadSampleData() {
            people = [
                new Person('ê¹€ì „ê³µ', [5, 6], [1, 15]),
                new Person('ì´ì „ê³µ', [10, 11, 12], []),
                new Person('ë°•ì „ê³µ', [], [20, 21]),
                new Person('ìµœì „ê³µ', [25], [5]),
                new Person('ì •ì „ê³µ', [1, 2], [10]),
                new Person('í•œì „ê³µ', [15, 16], []),
                new Person('ì˜¤ì „ê³µ', [], [25, 26]),
                new Person('ì„œì „ê³µ', [20], [])
            ];

            renderPersonList();
            markPeopleModified();
            showMessage('ì˜ˆì‹œ ë°ì´í„°ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. (8ëª…)', 'success');
        }

        // JSON ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸°
        function downloadJSON() {
            const data = {
                people: people.map(p => ({
                    name: p.name,
                    vacationDays: p.vacationDays,
                    preferredDays: p.preferredDays
                })),
                settings: {
                    maxConsecutiveHours: parseInt(document.getElementById('maxConsecutiveHours').value),
                    maxWeeklyHours: parseInt(document.getElementById('maxWeeklyHours').value),
                    peoplePerSlot: parseInt(document.getElementById('peoplePerSlot').value)
                }
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ì „ê³µì˜ë‹¹ì§_${currentYear}ë…„${currentMonth}ì›”_ì¸ì›ì •ë³´.json`;
            a.click();
            URL.revokeObjectURL(url);
            showMessage('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }

        function uploadJSON(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    people = data.people.map(p => new Person(p.name, p.vacationDays || [], p.preferredDays || []));

                    if (data.settings) {
                        document.getElementById('maxConsecutiveHours').value = data.settings.maxConsecutiveHours || 36;
                        document.getElementById('maxWeeklyHours').value = data.settings.maxWeeklyHours || 72;
                        document.getElementById('peoplePerSlot').value = data.settings.peoplePerSlot || 1;
                    }

                    renderPersonList();
                    markPeopleModified();
                    showMessage(`ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤. (${people.length}ëª…)`, 'success');
                } catch (error) {
                    showMessage('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function clearAllData() {
            if (confirm('ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                people = [];
                schedule = null;
                schedules = [];
                renderPersonList();
                renderCalendar();
                renderStatistics();
                showMessage('ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
            }
        }

        // ì¸ì› ë³€ê²½ í‘œì‹œ
        function markPeopleModified() {
            if (schedule || schedules.length > 0) {
                peopleModifiedAfterSchedule = true;
                updateScheduleWarning();
            }
        }

        function updateScheduleWarning() {
            const warning = document.getElementById('scheduleWarning');
            warning.style.display = peopleModifiedAfterSchedule ? 'block' : 'none';
        }

        // ì›” ë„¤ë¹„ê²Œì´ì…˜
        function updateCalendar() {
            const monthInput = document.getElementById('targetMonth').value;
            if (monthInput) {
                const [year, month] = monthInput.split('-');
                currentYear = parseInt(year);
                currentMonth = parseInt(month);
            }
            document.getElementById('calendarTitle').textContent = `${currentYear}ë…„ ${currentMonth}ì›”`;
            renderCalendar();
        }

        function prevMonth() {
            currentMonth--;
            if (currentMonth < 1) {
                currentMonth = 12;
                currentYear--;
            }
            document.getElementById('targetMonth').value = `${currentYear}-${String(currentMonth).padStart(2, '0')}`;
            schedule = null;
            schedules = [];
            updateScheduleNavigation();
            renderCalendar();
            renderStatistics();
        }

        function nextMonth() {
            currentMonth++;
            if (currentMonth > 12) {
                currentMonth = 1;
                currentYear++;
            }
            document.getElementById('targetMonth').value = `${currentYear}-${String(currentMonth).padStart(2, '0')}`;
            schedule = null;
            schedules = [];
            updateScheduleNavigation();
            renderCalendar();
            renderStatistics();
        }

        // ìº˜ë¦°ë” ë Œë”ë§
        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
            const firstDayOfWeek = new Date(currentYear, currentMonth - 1, 1).getDay();

            let html = '';

            // ìš”ì¼ í—¤ë”
            DAY_NAMES.forEach((day, i) => {
                let className = 'calendar-day-header';
                if (i === 0) className += ' sunday';
                if (i === 6) className += ' saturday';
                html += `<div class="${className}">${day}</div>`;
            });

            // ë¹ˆ ì¹¸ (ì›” ì‹œì‘ ì „)
            for (let i = 0; i < firstDayOfWeek; i++) {
                html += '<div class="calendar-day empty"></div>';
            }

            // ë‚ ì§œ ì¹¸
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(currentYear, currentMonth - 1, day);
                const dayOfWeek = date.getDay();
                const dateStr = formatDate(currentYear, currentMonth, day);

                let className = 'calendar-day';
                if (dayOfWeek === 0) className += ' sunday';
                if (dayOfWeek === 6) className += ' saturday';

                const daySchedule = schedule ? schedule[dateStr] : null;

                html += `<div class="${className}">`;
                html += `<div class="day-number">${day}</div>`;

                // ì£¼ê°„ ìŠ¬ë¡¯
                html += renderShiftSlot(dateStr, 'day', daySchedule);
                // ì•¼ê°„ ìŠ¬ë¡¯
                html += renderShiftSlot(dateStr, 'night', daySchedule);

                html += '</div>';
            }

            // ë¹ˆ ì¹¸ (ì›” ë í›„)
            const totalCells = firstDayOfWeek + daysInMonth;
            const remainingCells = (7 - (totalCells % 7)) % 7;
            for (let i = 0; i < remainingCells; i++) {
                html += '<div class="calendar-day empty"></div>';
            }

            grid.innerHTML = html;
        }

        function renderShiftSlot(dateStr, shift, daySchedule) {
            const isEditing = editingSlot && editingSlot.date === dateStr && editingSlot.shift === shift;
            const shiftLabel = shift === 'day' ? 'ì£¼ê°„' : 'ì•¼ê°„';
            const shiftClass = shift === 'day' ? 'day-shift' : 'night-shift';
            const peoplePerSlot = parseInt(document.getElementById('peoplePerSlot').value) || 1;

            let assigned = [];
            let isEdited = false;

            if (daySchedule) {
                assigned = daySchedule[shift] || [];
                isEdited = daySchedule[shift + 'Edited'] || false;
            }

            const isEmpty = assigned.length === 0;
            const slotClass = isEmpty ? 'unassigned' : shiftClass;
            const editedClass = isEdited ? 'manually-edited' : '';
            const editModeClass = isEditing ? 'edit-mode' : '';

            if (isEditing) {
                // í¸ì§‘ ëª¨ë“œ
                let selectsHtml = '';
                for (let i = 0; i < peoplePerSlot; i++) {
                    const currentName = assigned[i] || '';
                    selectsHtml += `
                        <select id="editSlot_${dateStr}_${shift}_${i}">
                            <option value="">--ì„ íƒ--</option>
                            ${people.map(p => `<option value="${p.name}" ${p.name === currentName ? 'selected' : ''}>${p.name}</option>`).join('')}
                        </select>
                    `;
                }

                return `
                    <div class="shift-slot ${shiftClass} edit-mode" onclick="event.stopPropagation()">
                        <div><span class="shift-label">${shiftLabel}</span></div>
                        ${selectsHtml}
                        <div style="margin-top: 5px; display: flex; gap: 3px;">
                            <button onclick="saveSlotEdit('${dateStr}', '${shift}')" class="success" style="padding: 3px 6px; font-size: 10px;">ì €ì¥</button>
                            <button onclick="cancelSlotEdit()" class="secondary" style="padding: 3px 6px; font-size: 10px;">ì·¨ì†Œ</button>
                        </div>
                    </div>
                `;
            }

            // í‘œì‹œ ëª¨ë“œ
            const namesDisplay = isEmpty ? 'ë¯¸ë°°ì •' : assigned.join(', ');

            return `
                <div class="shift-slot ${slotClass} ${editedClass}" onclick="editSlot('${dateStr}', '${shift}')">
                    <span class="shift-label">${shiftLabel}</span>
                    <span class="person-name">${namesDisplay}</span>
                </div>
            `;
        }

        function editSlot(dateStr, shift) {
            if (!schedule) {
                showMessage('ë¨¼ì € ë‹¹ì§í‘œë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            editingSlot = { date: dateStr, shift: shift };
            renderCalendar();
        }

        function cancelSlotEdit() {
            editingSlot = null;
            renderCalendar();
        }

        function saveSlotEdit(dateStr, shift) {
            const peoplePerSlot = parseInt(document.getElementById('peoplePerSlot').value) || 1;
            const newAssigned = [];

            for (let i = 0; i < peoplePerSlot; i++) {
                const select = document.getElementById(`editSlot_${dateStr}_${shift}_${i}`);
                if (select && select.value) {
                    newAssigned.push(select.value);
                }
            }

            // ì¤‘ë³µ ì²´í¬
            const unique = new Set(newAssigned);
            if (unique.size !== newAssigned.length) {
                showMessage('ê°™ì€ ì‚¬ëŒì´ ì—¬ëŸ¬ ë²ˆ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            if (!schedule[dateStr]) {
                schedule[dateStr] = { day: [], night: [], dayEdited: false, nightEdited: false };
            }

            schedule[dateStr][shift] = newAssigned;
            schedule[dateStr][shift + 'Edited'] = true;

            // í˜„ì¬ ìŠ¤ì¼€ì¤„ì„ ë°°ì—´ì—ë„ ì—…ë°ì´íŠ¸
            if (schedules.length > 0) {
                schedules[currentScheduleIndex] = JSON.parse(JSON.stringify(schedule));
            }

            editingSlot = null;
            recalculateHours();
            renderCalendar();
            renderStatistics();
            checkConstraints();
            showMessage('ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }

        // ë‚ ì§œ í¬ë§·
        function formatDate(year, month, day) {
            return `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        }

        // ìŠ¤ì¼€ì¤„ ìƒì„±
        function generateSchedule() {
            if (people.length === 0) {
                showMessage('ì¸ì›ì„ ë¨¼ì € ì¶”ê°€í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            const result = tryGenerateSchedule();

            if (!result.success) {
                alert('ë‹¹ì§í‘œ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\n' + result.reason + '\n\nì œì•½ ì¡°ê±´ì„ ì™„í™”í•˜ê±°ë‚˜ ì¸ì›ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.');
                showMessage('ìƒì„± ì‹¤íŒ¨', 'error');
                return;
            }

            schedule = result.schedule;
            schedules = [schedule];
            currentScheduleIndex = 0;

            recalculateHours();
            peopleModifiedAfterSchedule = false;
            updateScheduleWarning();
            updateScheduleNavigation();
            renderCalendar();
            renderStatistics();
            checkConstraints();
            showMessage('ë‹¹ì§í‘œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        }

        function generateMultipleSchedules() {
            if (people.length === 0) {
                showMessage('ì¸ì›ì„ ë¨¼ì € ì¶”ê°€í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            schedules = [];
            let attempts = 0;
            const maxAttempts = 200;

            while (schedules.length < 5 && attempts < maxAttempts) {
                attempts++;
                const result = tryGenerateSchedule();

                if (result.success && !isDuplicateSchedule(result.schedule)) {
                    schedules.push(result.schedule);
                }
            }

            if (schedules.length === 0) {
                alert('ë‹¹ì§í‘œ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\nì œì•½ ì¡°ê±´ì„ ì™„í™”í•˜ê±°ë‚˜ ì¸ì›ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.');
                showMessage('ìƒì„± ì‹¤íŒ¨', 'error');
                return;
            }

            currentScheduleIndex = 0;
            schedule = schedules[0];

            recalculateHours();
            peopleModifiedAfterSchedule = false;
            updateScheduleWarning();
            updateScheduleNavigation();
            renderCalendar();
            renderStatistics();
            checkConstraints();
            showMessage(`${schedules.length}ê°œì˜ ë‹¹ì§í‘œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!`, 'success');
        }

        function tryGenerateSchedule() {
            const maxConsecutiveHours = parseInt(document.getElementById('maxConsecutiveHours').value) || 36;
            const maxWeeklyHours = parseInt(document.getElementById('maxWeeklyHours').value) || 72;
            const peoplePerSlot = parseInt(document.getElementById('peoplePerSlot').value) || 1;

            const maxConsecutiveSlots = maxConsecutiveHours / SHIFT_HOURS;
            const maxWeeklySlots = maxWeeklyHours / SHIFT_HOURS;

            const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();

            // ì¸ì›ë³„ ì‹œê°„ ì´ˆê¸°í™”
            people.forEach(p => p.monthlyHours = 0);

            // ê° ì¸ì›ì˜ ì—°ì† ê·¼ë¬´ ìŠ¬ë¡¯ ì¶”ì 
            const consecutiveSlots = {};
            // ê° ì¸ì›ì˜ ì£¼ê°„ ê·¼ë¬´ ì‹œê°„ ì¶”ì  (ì£¼ì°¨ë³„)
            const weeklyHours = {};

            people.forEach(p => {
                consecutiveSlots[p.name] = 0;
                weeklyHours[p.name] = {};
            });

            const newSchedule = {};
            let failureReason = '';

            // ëª©í‘œ ì›”ê°„ ì‹œê°„ ê³„ì‚° (ê· ë“± ë°°ë¶„)
            const totalSlots = daysInMonth * 2 * peoplePerSlot;
            const targetHoursPerPerson = (totalSlots * SHIFT_HOURS) / people.length;

            // ëª¨ë“  ìŠ¬ë¡¯ ìˆœíšŒ (ë‚ ì§œ + ì£¼ê°„/ì•¼ê°„)
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = formatDate(currentYear, currentMonth, day);
                const date = new Date(currentYear, currentMonth - 1, day);
                const weekNumber = getWeekNumber(date);

                newSchedule[dateStr] = { day: [], night: [], dayEdited: false, nightEdited: false };

                for (const shift of ['day', 'night']) {
                    const assigned = [];

                    for (let slot = 0; slot < peoplePerSlot; slot++) {
                        const person = selectPersonForSlot(
                            day, shift, assigned, newSchedule,
                            consecutiveSlots, weeklyHours, weekNumber,
                            maxConsecutiveSlots, maxWeeklySlots, targetHoursPerPerson
                        );

                        if (!person) {
                            failureReason = `${day}ì¼ ${shift === 'day' ? 'ì£¼ê°„' : 'ì•¼ê°„'} ${slot + 1}ë²ˆì§¸ ì¸ì› ë°°ì • ì‹¤íŒ¨`;
                            return { success: false, reason: failureReason };
                        }

                        assigned.push(person.name);
                        person.monthlyHours += SHIFT_HOURS;
                        consecutiveSlots[person.name]++;

                        if (!weeklyHours[person.name][weekNumber]) {
                            weeklyHours[person.name][weekNumber] = 0;
                        }
                        weeklyHours[person.name][weekNumber] += SHIFT_HOURS;
                    }

                    newSchedule[dateStr][shift] = assigned;

                    // ì´ ìŠ¬ë¡¯ì— ë°°ì •ë˜ì§€ ì•Šì€ ì‚¬ëŒë“¤ì˜ ì—°ì† ì¹´ìš´íŠ¸ ë¦¬ì…‹
                    people.forEach(p => {
                        if (!assigned.includes(p.name)) {
                            consecutiveSlots[p.name] = 0;
                        }
                    });
                }
            }

            return { success: true, schedule: newSchedule };
        }

        function selectPersonForSlot(day, shift, alreadyAssigned, currentSchedule, consecutiveSlots, weeklyHours, weekNumber, maxConsecutiveSlots, maxWeeklySlots, targetHours) {
            let candidates = people.filter(p => {
                // ì´ë¯¸ ì´ ìŠ¬ë¡¯ì— ë°°ì •ë¨
                if (alreadyAssigned.includes(p.name)) return false;

                // íœ´ê°€
                if (p.isOnVacation(day)) return false;

                // ì—°ì† ê·¼ë¬´ ì œí•œ
                if (consecutiveSlots[p.name] >= maxConsecutiveSlots) return false;

                // ì£¼ê°„ ê·¼ë¬´ ì œí•œ
                const currentWeeklyHours = weeklyHours[p.name][weekNumber] || 0;
                if (currentWeeklyHours >= maxWeeklySlots * SHIFT_HOURS) return false;

                return true;
            });

            if (candidates.length === 0) return null;

            // ì„ í˜¸ì¼ ìš°ì„ 
            const preferred = candidates.filter(p => p.hasPreferredDay(day));
            if (preferred.length > 0) {
                candidates = preferred;
            }

            // ì›”ê°„ ì‹œê°„ì´ ì ì€ ì‚¬ëŒ ìš°ì„  (ê· ë“± ë°°ë¶„)
            candidates.sort((a, b) => a.monthlyHours - b.monthlyHours);

            // ê°™ì€ ì‹œê°„ì´ë©´ ëœë¤
            const minHours = candidates[0].monthlyHours;
            const best = candidates.filter(p => p.monthlyHours === minHours);

            return best[Math.floor(Math.random() * best.length)];
        }

        function getWeekNumber(date) {
            // í•´ë‹¹ ì›”ì˜ ëª‡ ë²ˆì§¸ ì£¼ì¸ì§€ ê³„ì‚°
            const firstDayOfMonth = new Date(date.getFullYear(), date.getMonth(), 1);
            const dayOfMonth = date.getDate();
            const firstDayOfWeek = firstDayOfMonth.getDay();
            return Math.ceil((dayOfMonth + firstDayOfWeek) / 7);
        }

        // ì¤‘ë³µ ìŠ¤ì¼€ì¤„ ì²´í¬
        function isDuplicateSchedule(newSchedule) {
            for (const existing of schedules) {
                let isDuplicate = true;

                for (const dateStr in newSchedule) {
                    if (!existing[dateStr]) {
                        isDuplicate = false;
                        break;
                    }

                    const newDay = [...(newSchedule[dateStr].day || [])].sort().join(',');
                    const existingDay = [...(existing[dateStr].day || [])].sort().join(',');
                    const newNight = [...(newSchedule[dateStr].night || [])].sort().join(',');
                    const existingNight = [...(existing[dateStr].night || [])].sort().join(',');

                    if (newDay !== existingDay || newNight !== existingNight) {
                        isDuplicate = false;
                        break;
                    }
                }

                if (isDuplicate) return true;
            }
            return false;
        }

        // ìŠ¤ì¼€ì¤„ ë„¤ë¹„ê²Œì´ì…˜
        function updateScheduleNavigation() {
            const nav = document.getElementById('scheduleNavigation');
            const indicator = document.getElementById('scheduleIndicator');

            if (schedules.length <= 1) {
                nav.style.display = 'none';
            } else {
                nav.style.display = 'block';
                indicator.textContent = `${currentScheduleIndex + 1} / ${schedules.length}`;
            }
        }

        function prevSchedule() {
            if (currentScheduleIndex > 0) {
                currentScheduleIndex--;
                schedule = schedules[currentScheduleIndex];
                recalculateHours();
                updateScheduleNavigation();
                renderCalendar();
                renderStatistics();
                checkConstraints();
            }
        }

        function nextSchedule() {
            if (currentScheduleIndex < schedules.length - 1) {
                currentScheduleIndex++;
                schedule = schedules[currentScheduleIndex];
                recalculateHours();
                updateScheduleNavigation();
                renderCalendar();
                renderStatistics();
                checkConstraints();
            }
        }

        // ì‹œê°„ ì¬ê³„ì‚°
        function recalculateHours() {
            people.forEach(p => p.monthlyHours = 0);

            if (!schedule) return;

            for (const dateStr in schedule) {
                const daySchedule = schedule[dateStr];
                ['day', 'night'].forEach(shift => {
                    (daySchedule[shift] || []).forEach(name => {
                        const person = people.find(p => p.name === name);
                        if (person) {
                            person.monthlyHours += SHIFT_HOURS;
                        }
                    });
                });
            }
        }

        // ì œì•½ ì¡°ê±´ ì²´í¬
        function checkConstraints() {
            const warnings = [];
            const maxConsecutiveHours = parseInt(document.getElementById('maxConsecutiveHours').value) || 36;
            const maxWeeklyHours = parseInt(document.getElementById('maxWeeklyHours').value) || 72;

            if (!schedule) {
                document.getElementById('constraintWarnings').innerHTML = '';
                return;
            }

            // ì—°ì† ê·¼ë¬´ ì²´í¬
            const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
            const slots = []; // { date, shift, assigned }

            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = formatDate(currentYear, currentMonth, day);
                const daySchedule = schedule[dateStr];
                if (daySchedule) {
                    slots.push({ day, shift: 'day', assigned: daySchedule.day || [] });
                    slots.push({ day, shift: 'night', assigned: daySchedule.night || [] });
                }
            }

            // ê° ì¸ì›ë³„ ì—°ì† ì²´í¬
            people.forEach(person => {
                let consecutive = 0;
                let maxConsecutive = 0;

                slots.forEach(slot => {
                    if (slot.assigned.includes(person.name)) {
                        consecutive++;
                        maxConsecutive = Math.max(maxConsecutive, consecutive);
                    } else {
                        consecutive = 0;
                    }
                });

                if (maxConsecutive * SHIFT_HOURS > maxConsecutiveHours) {
                    warnings.push(`${person.name}: ì—°ì† ${maxConsecutive * SHIFT_HOURS}ì‹œê°„ ê·¼ë¬´ (ì œí•œ: ${maxConsecutiveHours}ì‹œê°„)`);
                }
            });

            // ì£¼ê°„ ì²´í¬
            const weeklyHours = {};
            people.forEach(p => weeklyHours[p.name] = {});

            slots.forEach(slot => {
                const date = new Date(currentYear, currentMonth - 1, slot.day);
                const weekNum = getWeekNumber(date);

                slot.assigned.forEach(name => {
                    if (!weeklyHours[name][weekNum]) weeklyHours[name][weekNum] = 0;
                    weeklyHours[name][weekNum] += SHIFT_HOURS;
                });
            });

            people.forEach(person => {
                for (const week in weeklyHours[person.name]) {
                    if (weeklyHours[person.name][week] > maxWeeklyHours) {
                        warnings.push(`${person.name}: ${week}ì£¼ì°¨ ${weeklyHours[person.name][week]}ì‹œê°„ ê·¼ë¬´ (ì œí•œ: ${maxWeeklyHours}ì‹œê°„)`);
                    }
                }
            });

            const warningsDiv = document.getElementById('constraintWarnings');
            if (warnings.length > 0) {
                warningsDiv.innerHTML = `
                    <div class="constraint-warning">
                        <strong>âš ï¸ ì œì•½ ì¡°ê±´ ìœ„ë°˜:</strong><br>
                        ${warnings.map(w => 'â€¢ ' + w).join('<br>')}
                    </div>
                `;
            } else {
                warningsDiv.innerHTML = '';
            }
        }

        // í†µê³„ ë Œë”ë§
        function renderStatistics() {
            const statsDiv = document.getElementById('statistics');

            if (!schedule || people.length === 0) {
                statsDiv.innerHTML = '';
                return;
            }

            const avgHours = people.reduce((sum, p) => sum + p.monthlyHours, 0) / people.length;

            let html = '<div class="stats"><h3>ğŸ“Š ì›”ê°„ ê·¼ë¬´ì‹œê°„ í†µê³„</h3>';
            html += `<p class="small-text" style="margin-bottom: 15px;">í‰ê· : ${avgHours.toFixed(1)}ì‹œê°„ | ëª©í‘œ í¸ì°¨: Â±12ì‹œê°„ ì´ë‚´</p>`;
            html += '<div class="stats-grid">';

            const sortedPeople = [...people].sort((a, b) => b.monthlyHours - a.monthlyHours);

            sortedPeople.forEach(person => {
                const diff = person.monthlyHours - avgHours;
                const isWarning = Math.abs(diff) > 24; // 24ì‹œê°„ ì´ìƒ ì°¨ì´ë‚˜ë©´ ê²½ê³ 
                const warningClass = isWarning ? 'warning' : '';
                const diffText = diff >= 0 ? `+${diff.toFixed(0)}` : diff.toFixed(0);

                html += `
                    <div class="stat-item ${warningClass}">
                        <strong>${person.name}</strong>
                        <div class="hours">${person.monthlyHours}ì‹œê°„</div>
                        <div class="detail">${person.monthlyHours / SHIFT_HOURS}ìŠ¬ë¡¯ (${diffText}h)</div>
                    </div>
                `;
            });

            html += '</div></div>';
            statsDiv.innerHTML = html;
        }

        // ë‚´ë³´ë‚´ê¸°
        function exportSchedule() {
            if (!schedule) {
                showMessage('ë¨¼ì € ë‹¹ì§í‘œë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
            let text = `ì „ê³µì˜ ë‹¹ì§í‘œ - ${currentYear}ë…„ ${currentMonth}ì›”\n`;
            text += '='.repeat(50) + '\n\n';

            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = formatDate(currentYear, currentMonth, day);
                const date = new Date(currentYear, currentMonth - 1, day);
                const dayName = DAY_NAMES[date.getDay()];
                const daySchedule = schedule[dateStr];

                const dayAssigned = daySchedule?.day?.join(', ') || 'ë¯¸ë°°ì •';
                const nightAssigned = daySchedule?.night?.join(', ') || 'ë¯¸ë°°ì •';
                const dayEdited = daySchedule?.dayEdited ? ' [ìˆ˜ì •]' : '';
                const nightEdited = daySchedule?.nightEdited ? ' [ìˆ˜ì •]' : '';

                text += `${day}ì¼ (${dayName})\n`;
                text += `  ì£¼ê°„ (06-18ì‹œ): ${dayAssigned}${dayEdited}\n`;
                text += `  ì•¼ê°„ (18-06ì‹œ): ${nightAssigned}${nightEdited}\n`;
            }

            text += '\n' + '='.repeat(50) + '\n';
            text += 'ì›”ê°„ ê·¼ë¬´ì‹œê°„ í†µê³„\n\n';

            people.forEach(person => {
                const slots = person.monthlyHours / SHIFT_HOURS;
                let extra = '';
                if (person.vacationDays.length > 0) {
                    extra += ` (íœ´ê°€: ${person.vacationDays.join(',')}ì¼)`;
                }
                text += `${person.name}: ${person.monthlyHours}ì‹œê°„ (${slots}ìŠ¬ë¡¯)${extra}\n`;
            });

            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ì „ê³µì˜ë‹¹ì§í‘œ_${currentYear}ë…„${currentMonth}ì›”.txt`;
            a.click();
            URL.revokeObjectURL(url);

            showMessage('ë‹¹ì§í‘œê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }

        // ë©”ì‹œì§€ í‘œì‹œ
        function showMessage(msg, type = 'info') {
            const messagesDiv = document.getElementById('messages');
            const alertClass = type === 'error' ? 'alert-error' :
                              type === 'success' ? 'alert-success' :
                              type === 'warning' ? 'alert-warning' : 'alert-info';
            messagesDiv.innerHTML = `<div class="alert ${alertClass}">${msg}</div>`;
            setTimeout(() => messagesDiv.innerHTML = '', 4000);
        }
    </script>
</body>
</html>
