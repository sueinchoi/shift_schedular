<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì „ê³µì˜ ë‹¹ì§í‘œ</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        body {
            background: #f5f5f5;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        h1, h2, h3, h4 {
            color: #2c3e50;
            margin: 0 0 15px 0;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        /* íƒ­ ìŠ¤íƒ€ì¼ */
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 0;
        }
        .tab {
            padding: 12px 25px;
            cursor: pointer;
            border: none;
            background: #f0f0f0;
            border-radius: 8px 8px 0 0;
            font-size: 14px;
            font-weight: 600;
            color: #666;
            transition: all 0.2s;
            margin-bottom: -2px;
        }
        .tab:hover {
            background: #e0e0e0;
        }
        .tab.active {
            background: #3498db;
            color: white;
            border-bottom: 2px solid #3498db;
        }
        .tab.year1.active { background: #e74c3c; border-bottom-color: #e74c3c; }
        .tab.year2.active { background: #27ae60; border-bottom-color: #27ae60; }
        .tab.senior.active { background: #9b59b6; border-bottom-color: #9b59b6; }
        .tab.combined.active { background: #2c3e50; border-bottom-color: #2c3e50; }

        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }
        button.primary {
            background: #3498db;
            color: white;
        }
        button.primary:hover {
            background: #2980b9;
        }
        button.success {
            background: #27ae60;
            color: white;
        }
        button.success:hover {
            background: #219a52;
        }
        button.danger {
            background: #e74c3c;
            color: white;
        }
        button.danger:hover {
            background: #c0392b;
        }
        button.secondary {
            background: #95a5a6;
            color: white;
        }
        button.secondary:hover {
            background: #7f8c8d;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ì…ë ¥ í•„ë“œ */
        input, select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #3498db;
        }

        /* ì¸ì› ëª©ë¡ */
        .person-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .person-card {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
        }
        .person-card.week-duty-person {
            border-color: #f39c12;
            background: #fef9e7;
        }
        .person-name {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 8px;
        }
        .person-badges {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            margin-bottom: 8px;
        }
        .badge {
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 500;
        }
        .badge.week-duty {
            background: #3498db;
            color: white;
        }
        .badge.preferred {
            background: #27ae60;
            color: white;
        }
        .badge.avoided {
            background: #e74c3c;
            color: white;
        }

        /* ìº˜ë¦°ë” */
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            margin-top: 15px;
        }
        .calendar-day-header {
            text-align: center;
            padding: 10px 5px;
            font-weight: 600;
            font-size: 13px;
            background: #34495e;
            color: white;
        }
        .calendar-day-header.sunday { background: #c0392b; }
        .calendar-day-header.saturday { background: #2980b9; }

        .calendar-day {
            min-height: 100px;
            padding: 5px;
            background: white;
            border: 1px solid #e0e0e0;
            font-size: 11px;
            position: relative;
        }
        .calendar-day.empty {
            background: #f5f5f5;
        }
        .calendar-day.sunday {
            background: #fff5f5;
        }
        .calendar-day.saturday {
            background: #f0f8ff;
        }
        .calendar-day.holiday {
            background: #ffeaea;
        }
        .calendar-day .day-number {
            font-weight: 700;
            font-size: 14px;
            margin-bottom: 5px;
        }
        .calendar-day.sunday .day-number { color: #c0392b; }
        .calendar-day.saturday .day-number { color: #2980b9; }

        .duty-item {
            padding: 2px 5px;
            margin: 2px 0;
            border-radius: 3px;
            font-size: 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .duty-item.year1 { background: #fadbd8; color: #922b21; }
        .duty-item.year2 { background: #d5f5e3; color: #1e8449; }
        .duty-item.senior { background: #e8daef; color: #6c3483; }
        .duty-item.primary { font-weight: 600; }
        .duty-item.secondary { opacity: 0.8; }

        /* í†µê³„ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .stat-card {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
        }
        .stat-card h4 {
            margin: 0 0 10px 0;
            font-size: 14px;
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            padding: 3px 0;
            border-bottom: 1px solid #eee;
        }
        .stat-row:last-child {
            border-bottom: none;
        }
        .stat-label {
            color: #666;
        }
        .stat-value {
            font-weight: 600;
        }
        .stat-value.warning {
            color: #e74c3c;
        }

        /* ì•Œë¦¼ */
        .alert {
            padding: 12px 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 13px;
        }
        .alert-info {
            background: #d6eaf8;
            color: #1a5276;
            border: 1px solid #aed6f1;
        }
        .alert-success {
            background: #d4efdf;
            color: #1e8449;
            border: 1px solid #abebc6;
        }
        .alert-error {
            background: #fadbd8;
            color: #922b21;
            border: 1px solid #f5b7b1;
        }
        .alert-warning {
            background: #fef9e7;
            color: #9a7d0a;
            border: 1px solid #f9e79f;
        }

        /* ì„¤ì • ì˜ì—­ */
        .settings-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .settings-row {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }
        .settings-row:last-child {
            margin-bottom: 0;
        }
        .settings-label {
            font-size: 13px;
            font-weight: 500;
            min-width: 100px;
        }

        /* ì²´í¬ë°•ìŠ¤ */
        .checkbox-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 13px;
        }
        .checkbox-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
        }

        /* ë²„íŠ¼ ê·¸ë£¹ */
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        /* ì›” ì„ íƒ */
        .month-selector {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }

        /* ì£¼ì°¨ë³„ ê°„ë‹¹ì§ ì„¤ì • */
        .week-duty-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .week-duty-item {
            background: #f0f8ff;
            border: 1px solid #aed6f1;
            border-radius: 5px;
            padding: 10px;
        }
        .week-duty-item label {
            font-size: 12px;
            font-weight: 600;
            display: block;
            margin-bottom: 5px;
        }

        /* ì‘ì€ í…ìŠ¤íŠ¸ */
        .small-text {
            font-size: 12px;
            color: #666;
        }

        /* íœ´ì¼ ì´ë¦„ */
        .holiday-name {
            font-size: 9px;
            color: #c0392b;
            position: absolute;
            top: 2px;
            right: 2px;
            max-width: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* ì ‘ì´ì‹ ì„¹ì…˜ */
        .collapsible-header {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .collapsible-header:hover {
            background: #e5e5e5;
        }
        .collapsible-content {
            display: none;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
        }
        .collapsible-content.open {
            display: block;
        }

        /* ë²”ë¡€ */
        .legend {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
        }
        .legend-color {
            width: 20px;
            height: 14px;
            border-radius: 3px;
        }
        .legend-color.year1 { background: #fadbd8; border: 1px solid #e74c3c; }
        .legend-color.year2 { background: #d5f5e3; border: 1px solid #27ae60; }
        .legend-color.senior { background: #e8daef; border: 1px solid #9b59b6; }

        /* ë¯¸ë¦¬ë³´ê¸° ìº˜ë¦°ë” */
        .preview-calendar .calendar-day {
            min-height: 60px;
            cursor: pointer;
        }
        .preview-calendar .calendar-day:hover {
            background: #fff9e6;
        }
        .preview-calendar .day-info {
            font-size: 9px;
            color: #888;
            margin-top: 3px;
        }
        .preview-calendar .duty-count {
            font-size: 10px;
            color: #3498db;
            font-weight: 500;
        }

        /* í¸ì§‘ ì»¨íŠ¸ë¡¤ */
        .edit-controls {
            margin-top: 10px;
            padding: 10px;
            background: #fff9e6;
            border-radius: 5px;
            border: 1px solid #f39c12;
            display: none;
        }
        .edit-controls.active {
            display: block;
        }
        .edit-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }
        .edit-row label {
            font-size: 12px;
            min-width: 80px;
        }

        /* ë‚ ì§œë³„ ì„¤ì • ëª¨ë‹¬ */
        .date-settings-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 30px rgba(0,0,0,0.3);
            z-index: 1000;
            min-width: 300px;
            display: none;
        }
        .date-settings-popup.active {
            display: block;
        }
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }
        .popup-overlay.active {
            display: block;
        }
    </style>
</head>
<body>
    <h1>ì „ê³µì˜ ë‹¹ì§í‘œ ì‹œìŠ¤í…œ (4ì£¼ ë‹¨ìœ„)</h1>

    <!-- ì‹œì‘ì¼ ë° ìº˜ë¦°ë” ë¯¸ë¦¬ë³´ê¸° -->
    <div class="container">
        <h3>ğŸ“… ê¸°ê°„ ì„¤ì •</h3>
        <div class="settings-row">
            <label style="font-weight: 600;">ì‹œì‘ ë‚ ì§œ:</label>
            <input type="date" id="startDate" onchange="updateStartDate()">
            <span id="periodInfo" style="margin-left: 10px; color: #666;"></span>
        </div>
        <p class="small-text">ì‹œì‘ì¼ë¶€í„° 4ì£¼(28ì¼) ê¸°ì¤€ìœ¼ë¡œ ë‹¹ì§í‘œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</p>

        <!-- ìº˜ë¦°ë” ë¯¸ë¦¬ë³´ê¸° -->
        <div class="collapsible-header" onclick="togglePreviewCalendar()">
            <span style="font-weight: 600;">ğŸ“† ìº˜ë¦°ë” ë¯¸ë¦¬ë³´ê¸° (ë‚ ì§œë³„ ë‹¹ì§ ìˆ˜ ì„¤ì •)</span>
            <span id="previewToggle">â–¼</span>
        </div>
        <div id="previewCalendarSection" class="collapsible-content">
            <p class="small-text">ë‚ ì§œë¥¼ í´ë¦­í•˜ë©´ í•´ë‹¹ ë‚ ì§œì˜ ë‹¹ì§/2ndë‹¹ì§ ì¸ì› ìˆ˜ë¥¼ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            <div id="previewCalendar" class="preview-calendar"></div>
        </div>
    </div>

    <!-- ë‚ ì§œ ì„¤ì • íŒì—… -->
    <div class="popup-overlay" id="popupOverlay" onclick="closeDatePopup()"></div>
    <div class="date-settings-popup" id="dateSettingsPopup">
        <h4 id="popupTitle">ë‚ ì§œ ì„¤ì •</h4>
        <div class="edit-row">
            <label>ë‹¹ì§ ì¸ì›:</label>
            <input type="number" id="popupPrimaryCount" min="0" max="5" value="1" style="width: 60px;">
        </div>
        <div class="edit-row">
            <label>2ndë‹¹ì§ ì¸ì›:</label>
            <input type="number" id="popupSecondaryCount" min="0" max="5" value="1" style="width: 60px;">
        </div>
        <div class="button-group">
            <button class="primary" onclick="saveDateSettings()">ì €ì¥</button>
            <button class="secondary" onclick="closeDatePopup()">ì·¨ì†Œ</button>
        </div>
    </div>

    <!-- íƒ­ -->
    <div class="tabs">
        <button class="tab year1 active" onclick="switchTab('year1')">1ë…„ì°¨</button>
        <button class="tab year2" onclick="switchTab('year2')">2ë…„ì°¨</button>
        <button class="tab senior" onclick="switchTab('senior')">ì‹œë‹ˆì–´</button>
        <button class="tab combined" onclick="switchTab('combined')">í†µí•© ìº˜ë¦°ë”</button>
    </div>

    <!-- 1ë…„ì°¨ íƒ­ -->
    <div id="tab-year1" class="tab-content active">
        <div class="container">
            <h2 style="color: #e74c3c;">1ë…„ì°¨ ë‹¹ì§í‘œ</h2>

            <div class="alert alert-info">
                <strong>1ë…„ì°¨ ë‹¹ì§ ê·œì¹™:</strong><br>
                â€¢ í‰ì¼: ë‹¹ì§ 1ëª…, 2nd ë‹¹ì§ (ì›”ëª©: 1ëª…, í™”ìˆ˜ê¸ˆ: 2ëª…)<br>
                â€¢ ì£¼ë§/íœ´ì¼: ë‹¹ì§ 1ëª…<br>
                â€¢ <strong style="color: #c0392b;">[ê°„ë‹¹ì§ ê·œì¹™]</strong> ëª¨ë“  í™”ìš”ì¼ ë‹¹ì§ ë˜ëŠ” 2ndë‹¹ì§ <strong>í•„ìˆ˜ ë°°ì •</strong> / ì¼Â·ì›”Â·ìˆ˜ ë‹¹ì§ ë¶ˆê°€ (2ndë‹¹ì§ì€ ê°€ëŠ¥)
            </div>

            <!-- ì¸ì› ì¶”ê°€ -->
            <div class="settings-section">
                <h4>ì¸ì› ê´€ë¦¬</h4>
                <div class="settings-row">
                    <input type="text" id="year1-name" placeholder="ì´ë¦„" style="width: 100px;">
                    <button onclick="addPerson('year1')" class="primary">ì¶”ê°€</button>
                </div>
                <div id="year1-persons" class="person-list"></div>
            </div>

            <!-- ê°„ë‹¹ì§ ë‹´ë‹¹ì (4ì£¼ ê¸°ì¤€ 1ëª…) -->
            <div class="settings-section">
                <h4>ê°„ë‹¹ì§ ë‹´ë‹¹ì (4ì£¼ ê¸°ì¤€ 1ëª…)</h4>
                <p class="small-text">
                    <strong>ì ˆëŒ€ ì¡°ê±´:</strong> ê°„ë‹¹ì§ìëŠ” <span style="color: #c0392b; font-weight: bold;">ëª¨ë“  í™”ìš”ì¼</span>ì— ë‹¹ì§ ë˜ëŠ” 2ndë‹¹ì§ìœ¼ë¡œ ë°˜ë“œì‹œ ë°°ì •ë©ë‹ˆë‹¤.<br>
                    <strong>ì œí•œ:</strong> ì¼/ì›”/ìˆ˜ì—ëŠ” "ë‹¹ì§" ë¶ˆê°€ (ë‹¨, "2ndë‹¹ì§"ì€ ê°€ëŠ¥)
                </p>
                <div id="year1-week-duty" class="week-duty-grid"></div>
            </div>

            <div class="button-group">
                <button onclick="generateSchedule('year1')" class="success">ë‹¹ì§í‘œ ìƒì„±</button>
                <button onclick="saveSchedule('year1')" class="primary">ì €ì¥</button>
                <button onclick="loadSchedule('year1')" class="secondary">ë¶ˆëŸ¬ì˜¤ê¸°</button>
                <button onclick="loadExampleData('year1')" class="secondary">ì˜ˆì‹œ ë°ì´í„° ë¡œë“œ</button>
            </div>

            <div id="year1-messages"></div>
            <div id="year1-calendar"></div>
            <div id="year1-stats"></div>
        </div>
    </div>

    <!-- 2ë…„ì°¨ íƒ­ -->
    <div id="tab-year2" class="tab-content">
        <div class="container">
            <h2 style="color: #27ae60;">2ë…„ì°¨ ë‹¹ì§í‘œ</h2>

            <div class="alert alert-info">
                <strong>2ë…„ì°¨ ë‹¹ì§ ê·œì¹™:</strong><br>
                â€¢ í‰ì¼: ë‹¹ì§ 1ëª…, 2nd ë‹¹ì§ (ì›”ëª©: 2ëª…, í™”ìˆ˜ê¸ˆ: 1ëª…)<br>
                â€¢ ì£¼ë§/íœ´ì¼: ë‹¹ì§ 1ëª…<br>
                â€¢ <strong style="color: #c0392b;">[ê°„ë‹¹ì§ ê·œì¹™]</strong> ëª¨ë“  í™”ìš”ì¼ ë‹¹ì§ ë˜ëŠ” 2ndë‹¹ì§ <strong>í•„ìˆ˜ ë°°ì •</strong> / ì¼Â·ì›”Â·ìˆ˜ ë‹¹ì§ ë¶ˆê°€ (2ndë‹¹ì§ì€ ê°€ëŠ¥)
            </div>

            <!-- ì¸ì› ì¶”ê°€ -->
            <div class="settings-section">
                <h4>ì¸ì› ê´€ë¦¬</h4>
                <div class="settings-row">
                    <input type="text" id="year2-name" placeholder="ì´ë¦„" style="width: 100px;">
                    <button onclick="addPerson('year2')" class="primary">ì¶”ê°€</button>
                </div>
                <div id="year2-persons" class="person-list"></div>
            </div>

            <!-- ê°„ë‹¹ì§ ë‹´ë‹¹ì -->
            <div class="settings-section">
                <h4>ê°„ë‹¹ì§ ë‹´ë‹¹ì (4ì£¼ ê¸°ì¤€ 1ëª…)</h4>
                <p class="small-text">
                    <strong>ì ˆëŒ€ ì¡°ê±´:</strong> ê°„ë‹¹ì§ìëŠ” <span style="color: #c0392b; font-weight: bold;">ëª¨ë“  í™”ìš”ì¼</span>ì— ë‹¹ì§ ë˜ëŠ” 2ndë‹¹ì§ìœ¼ë¡œ ë°˜ë“œì‹œ ë°°ì •ë©ë‹ˆë‹¤.<br>
                    <strong>ì œí•œ:</strong> ì¼/ì›”/ìˆ˜ì—ëŠ” "ë‹¹ì§" ë¶ˆê°€ (ë‹¨, "2ndë‹¹ì§"ì€ ê°€ëŠ¥)
                </p>
                <div id="year2-week-duty" class="week-duty-grid"></div>
            </div>

            <div class="button-group">
                <button onclick="generateSchedule('year2')" class="success">ë‹¹ì§í‘œ ìƒì„±</button>
                <button onclick="saveSchedule('year2')" class="primary">ì €ì¥</button>
                <button onclick="loadSchedule('year2')" class="secondary">ë¶ˆëŸ¬ì˜¤ê¸°</button>
                <button onclick="loadExampleData('year2')" class="secondary">ì˜ˆì‹œ ë°ì´í„° ë¡œë“œ</button>
            </div>

            <div id="year2-messages"></div>
            <div id="year2-calendar"></div>
            <div id="year2-stats"></div>
        </div>
    </div>

    <!-- ì‹œë‹ˆì–´ íƒ­ -->
    <div id="tab-senior" class="tab-content">
        <div class="container">
            <h2 style="color: #9b59b6;">ì‹œë‹ˆì–´ ë‹¹ì§í‘œ</h2>

            <div class="alert alert-info">
                <strong>ì‹œë‹ˆì–´ ë‹¹ì§ ê·œì¹™:</strong><br>
                â€¢ í‰ì¼/ì£¼ë§/íœ´ì¼ ìƒê´€ì—†ì´ ë‹¹ì§ 1ëª…<br>
                â€¢ <strong style="color: #c0392b;">[ê°„ë‹¹ì§ ê·œì¹™]</strong> ëª¨ë“  í™”ìš”ì¼ ë‹¹ì§ ë˜ëŠ” 2ndë‹¹ì§ <strong>í•„ìˆ˜ ë°°ì •</strong> / ì¼Â·ì›”Â·ìˆ˜ ë‹¹ì§ ë¶ˆê°€ (2ndë‹¹ì§ì€ ê°€ëŠ¥)
            </div>

            <!-- ì¸ì› ì¶”ê°€ -->
            <div class="settings-section">
                <h4>ì¸ì› ê´€ë¦¬</h4>
                <div class="settings-row">
                    <input type="text" id="senior-name" placeholder="ì´ë¦„" style="width: 100px;">
                    <button onclick="addPerson('senior')" class="primary">ì¶”ê°€</button>
                </div>
                <div id="senior-persons" class="person-list"></div>
            </div>

            <!-- ê°„ë‹¹ì§ ë‹´ë‹¹ì -->
            <div class="settings-section">
                <h4>ê°„ë‹¹ì§ ë‹´ë‹¹ì (4ì£¼ ê¸°ì¤€ 1ëª…)</h4>
                <p class="small-text">
                    <strong>ì ˆëŒ€ ì¡°ê±´:</strong> ê°„ë‹¹ì§ìëŠ” <span style="color: #c0392b; font-weight: bold;">ëª¨ë“  í™”ìš”ì¼</span>ì— ë‹¹ì§ ë˜ëŠ” 2ndë‹¹ì§ìœ¼ë¡œ ë°˜ë“œì‹œ ë°°ì •ë©ë‹ˆë‹¤.<br>
                    <strong>ì œí•œ:</strong> ì¼/ì›”/ìˆ˜ì—ëŠ” "ë‹¹ì§" ë¶ˆê°€ (ë‹¨, "2ndë‹¹ì§"ì€ ê°€ëŠ¥)
                </p>
                <div id="senior-week-duty" class="week-duty-grid"></div>
            </div>

            <div class="button-group">
                <button onclick="generateSchedule('senior')" class="success">ë‹¹ì§í‘œ ìƒì„±</button>
                <button onclick="saveSchedule('senior')" class="primary">ì €ì¥</button>
                <button onclick="loadSchedule('senior')" class="secondary">ë¶ˆëŸ¬ì˜¤ê¸°</button>
                <button onclick="loadExampleData('senior')" class="secondary">ì˜ˆì‹œ ë°ì´í„° ë¡œë“œ</button>
            </div>

            <div id="senior-messages"></div>
            <div id="senior-calendar"></div>
            <div id="senior-stats"></div>
        </div>
    </div>

    <!-- í†µí•© ìº˜ë¦°ë” íƒ­ -->
    <div id="tab-combined" class="tab-content">
        <div class="container">
            <h2>í†µí•© ë‹¹ì§í‘œ</h2>

            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color year1"></div>
                    <span>1ë…„ì°¨</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color year2"></div>
                    <span>2ë…„ì°¨</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color senior"></div>
                    <span>ì‹œë‹ˆì–´</span>
                </div>
            </div>

            <div class="button-group">
                <button onclick="loadAllSchedules()" class="primary">ëª¨ë“  ë‹¹ì§í‘œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                <button onclick="exportCombined()" class="secondary">ë‚´ë³´ë‚´ê¸°</button>
            </div>

            <div id="combined-messages"></div>
            <div id="combined-calendar"></div>
        </div>
    </div>

    <script>
        // ===== ì „ì—­ ë°ì´í„° =====
        const data = {
            year1: { persons: [], schedule: [], weekDutyPerson: '' },
            year2: { persons: [], schedule: [], weekDutyPerson: '' },
            senior: { persons: [], schedule: [], weekDutyPerson: '' }
        };

        let startDate = null;
        let currentPopupDate = null;

        // ë‚ ì§œë³„ ë‹¹ì§ ìˆ˜ ì„¤ì • (ê¸°ë³¸ê°’ê³¼ ë‹¤ë¥¸ ê²½ìš°ë§Œ ì €ì¥)
        let dateSpecificDutyCounts = {};

        // ëŒ€í•œë¯¼êµ­ ê³µíœ´ì¼
        const HOLIDAYS = {
            '2024-01-01': 'ì‹ ì •', '2024-02-09': 'ì„¤ë‚ ì—°íœ´', '2024-02-10': 'ì„¤ë‚ ',
            '2024-02-11': 'ì„¤ë‚ ì—°íœ´', '2024-02-12': 'ëŒ€ì²´ê³µíœ´ì¼', '2024-03-01': 'ì‚¼ì¼ì ˆ',
            '2024-05-05': 'ì–´ë¦°ì´ë‚ ', '2024-05-06': 'ëŒ€ì²´ê³µíœ´ì¼', '2024-05-15': 'ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ ',
            '2024-06-06': 'í˜„ì¶©ì¼', '2024-08-15': 'ê´‘ë³µì ˆ', '2024-09-16': 'ì¶”ì„ì—°íœ´',
            '2024-09-17': 'ì¶”ì„', '2024-09-18': 'ì¶”ì„ì—°íœ´', '2024-10-03': 'ê°œì²œì ˆ',
            '2024-10-09': 'í•œê¸€ë‚ ', '2024-12-25': 'í¬ë¦¬ìŠ¤ë§ˆìŠ¤',
            '2025-01-01': 'ì‹ ì •', '2025-01-28': 'ì„¤ë‚ ì—°íœ´', '2025-01-29': 'ì„¤ë‚ ',
            '2025-01-30': 'ì„¤ë‚ ì—°íœ´', '2025-03-01': 'ì‚¼ì¼ì ˆ', '2025-03-03': 'ëŒ€ì²´ê³µíœ´ì¼',
            '2025-05-05': 'ì–´ë¦°ì´ë‚ ', '2025-05-06': 'ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ ', '2025-06-06': 'í˜„ì¶©ì¼',
            '2025-08-15': 'ê´‘ë³µì ˆ', '2025-10-03': 'ê°œì²œì ˆ', '2025-10-05': 'ì¶”ì„ì—°íœ´',
            '2025-10-06': 'ì¶”ì„', '2025-10-07': 'ì¶”ì„ì—°íœ´', '2025-10-08': 'ëŒ€ì²´ê³µíœ´ì¼',
            '2025-10-09': 'í•œê¸€ë‚ ', '2025-12-25': 'í¬ë¦¬ìŠ¤ë§ˆìŠ¤',
            '2026-01-01': 'ì‹ ì •', '2026-02-16': 'ì„¤ë‚ ì—°íœ´', '2026-02-17': 'ì„¤ë‚ ',
            '2026-02-18': 'ì„¤ë‚ ì—°íœ´', '2026-03-01': 'ì‚¼ì¼ì ˆ', '2026-03-02': 'ëŒ€ì²´ê³µíœ´ì¼',
            '2026-05-05': 'ì–´ë¦°ì´ë‚ ', '2026-05-24': 'ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ ', '2026-06-06': 'í˜„ì¶©ì¼',
            '2026-08-15': 'ê´‘ë³µì ˆ', '2026-09-24': 'ì¶”ì„ì—°íœ´', '2026-09-25': 'ì¶”ì„',
            '2026-09-26': 'ì¶”ì„ì—°íœ´', '2026-10-03': 'ê°œì²œì ˆ', '2026-10-09': 'í•œê¸€ë‚ ',
            '2026-12-25': 'í¬ë¦¬ìŠ¤ë§ˆìŠ¤'
        };

        const DAYS_OF_WEEK = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];

        // ===== ì´ˆê¸°í™” =====
        document.addEventListener('DOMContentLoaded', function() {
            // ê¸°ë³¸ ì‹œì‘ì¼: ë‹¤ìŒ ì›”ìš”ì¼
            const today = new Date();
            const dayOfWeek = today.getDay();
            const daysUntilMonday = dayOfWeek === 0 ? 1 : (8 - dayOfWeek) % 7 || 7;
            const nextMonday = new Date(today);
            nextMonday.setDate(today.getDate() + daysUntilMonday);

            document.getElementById('startDate').value = formatDate(nextMonday);
            updateStartDate();
        });

        // ===== ë‚ ì§œ ìœ í‹¸ë¦¬í‹° =====
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function parseDate(dateStr) {
            const [year, month, day] = dateStr.split('-').map(Number);
            return new Date(year, month - 1, day);
        }

        function getHolidayName(dateStr) {
            return HOLIDAYS[dateStr] || null;
        }

        function isHoliday(dateStr) {
            return !!HOLIDAYS[dateStr];
        }

        function isWeekend(date) {
            const dayOfWeek = date.getDay();
            return dayOfWeek === 0 || dayOfWeek === 6;
        }

        // ===== ì‹œì‘ì¼ ì„¤ì • =====
        function updateStartDate() {
            const input = document.getElementById('startDate');
            if (!input.value) return;

            startDate = parseDate(input.value);
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 27); // 4ì£¼ = 28ì¼

            document.getElementById('periodInfo').textContent =
                `${formatDate(startDate)} ~ ${formatDate(endDate)} (4ì£¼, 28ì¼)`;

            renderPreviewCalendar();
            ['year1', 'year2', 'senior'].forEach(yearType => {
                renderWeekDutySelector(yearType);
            });
        }

        // ===== ë¯¸ë¦¬ë³´ê¸° ìº˜ë¦°ë” =====
        function togglePreviewCalendar() {
            const section = document.getElementById('previewCalendarSection');
            const toggle = document.getElementById('previewToggle');
            if (section.classList.contains('open')) {
                section.classList.remove('open');
                toggle.textContent = 'â–¼';
            } else {
                section.classList.add('open');
                toggle.textContent = 'â–²';
            }
        }

        function renderPreviewCalendar() {
            if (!startDate) return;

            const container = document.getElementById('previewCalendar');
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 27);

            // ì‹œì‘ì¼ì˜ í•´ë‹¹ ì›” ì²«ì§¸ë‚ 
            const calendarStart = new Date(startDate.getFullYear(), startDate.getMonth(), 1);
            // ëì¼ì˜ í•´ë‹¹ ì›” ë§ˆì§€ë§‰ë‚ 
            const calendarEnd = new Date(endDate.getFullYear(), endDate.getMonth() + 1, 0);

            let html = '<div class="calendar">';

            // ìš”ì¼ í—¤ë”
            DAYS_OF_WEEK.forEach((name, i) => {
                let headerClass = 'calendar-day-header';
                if (i === 0) headerClass += ' sunday';
                if (i === 6) headerClass += ' saturday';
                html += `<div class="${headerClass}">${name}</div>`;
            });

            // ì²«ì§¸ ì£¼ ë¹ˆ ì¹¸
            const firstDayOfWeek = calendarStart.getDay();
            for (let i = 0; i < firstDayOfWeek; i++) {
                html += '<div class="calendar-day empty"></div>';
            }

            // ë‚ ì§œë“¤
            const current = new Date(calendarStart);
            while (current <= calendarEnd) {
                const dateStr = formatDate(current);
                const dayOfWeek = current.getDay();
                const holidayName = getHolidayName(dateStr);
                const isInRange = current >= startDate && current <= endDate;

                let dayClass = 'calendar-day';
                if (dayOfWeek === 0) dayClass += ' sunday';
                if (dayOfWeek === 6) dayClass += ' saturday';
                if (holidayName) dayClass += ' holiday';
                if (!isInRange) dayClass += ' empty';

                const dutyInfo = getDutyCountsForDate(dateStr, dayOfWeek);

                html += `<div class="${dayClass}" onclick="openDatePopup('${dateStr}')" style="cursor: ${isInRange ? 'pointer' : 'default'}">`;
                html += `<div class="day-number">${current.getDate()}</div>`;

                if (holidayName) {
                    html += `<div class="holiday-name">${holidayName}</div>`;
                }

                if (isInRange) {
                    const weekNum = Math.floor((current - startDate) / (7 * 24 * 60 * 60 * 1000)) + 1;
                    html += `<div class="day-info">${weekNum}ì£¼ì°¨</div>`;
                    html += `<div class="duty-count">ë‹¹ì§:${dutyInfo.primary} 2nd:${dutyInfo.secondary}</div>`;
                }

                html += '</div>';

                current.setDate(current.getDate() + 1);
            }

            html += '</div>';
            container.innerHTML = html;
        }

        function getDutyCountsForDate(dateStr, dayOfWeek) {
            // ë‚ ì§œë³„ ì„¤ì •ì´ ìˆìœ¼ë©´ ì‚¬ìš©
            if (dateSpecificDutyCounts[dateStr]) {
                return dateSpecificDutyCounts[dateStr];
            }

            // ê¸°ë³¸ê°’: ì£¼ë§/íœ´ì¼ì€ ë‹¹ì§ 1ëª…ë§Œ
            if (dayOfWeek === 0 || dayOfWeek === 6 || isHoliday(dateStr)) {
                return { primary: 1, secondary: 0 };
            }

            // í‰ì¼ ê¸°ë³¸ê°’
            return { primary: 1, secondary: 1 };
        }

        function openDatePopup(dateStr) {
            if (!startDate) return;

            const date = parseDate(dateStr);
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 27);

            if (date < startDate || date > endDate) return;

            currentPopupDate = dateStr;
            const dayOfWeek = date.getDay();
            const dutyInfo = getDutyCountsForDate(dateStr, dayOfWeek);
            const holidayName = getHolidayName(dateStr);

            document.getElementById('popupTitle').textContent =
                `${dateStr} (${DAYS_OF_WEEK[dayOfWeek]})${holidayName ? ' - ' + holidayName : ''}`;
            document.getElementById('popupPrimaryCount').value = dutyInfo.primary;
            document.getElementById('popupSecondaryCount').value = dutyInfo.secondary;

            document.getElementById('popupOverlay').classList.add('active');
            document.getElementById('dateSettingsPopup').classList.add('active');
        }

        function closeDatePopup() {
            document.getElementById('popupOverlay').classList.remove('active');
            document.getElementById('dateSettingsPopup').classList.remove('active');
            currentPopupDate = null;
        }

        function saveDateSettings() {
            if (!currentPopupDate) return;

            const primary = parseInt(document.getElementById('popupPrimaryCount').value) || 0;
            const secondary = parseInt(document.getElementById('popupSecondaryCount').value) || 0;

            if (primary === 0 && secondary === 0) {
                // ë‘˜ ë‹¤ 0ì´ë©´ ì„¤ì • ì‚­ì œ (ë‹¹ì§ ì—†ìŒ)
                dateSpecificDutyCounts[currentPopupDate] = { primary: 0, secondary: 0 };
            } else {
                dateSpecificDutyCounts[currentPopupDate] = { primary, secondary };
            }

            renderPreviewCalendar();
            closeDatePopup();
            showMessage('year1', 'ë‚ ì§œë³„ ë‹¹ì§ ìˆ˜ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }

        // ===== íƒ­ ì „í™˜ =====
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            document.querySelector(`.tab.${tabName}`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');

            if (tabName === 'combined') {
                renderCombinedCalendar();
            }
        }

        // ===== ì¸ì› ê´€ë¦¬ =====
        function addPerson(yearType) {
            const nameInput = document.getElementById(`${yearType}-name`);
            const name = nameInput.value.trim();

            if (!name) {
                showMessage(yearType, 'ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            if (data[yearType].persons.find(p => p.name === name)) {
                showMessage(yearType, 'ì´ë¯¸ ë“±ë¡ëœ ì´ë¦„ì…ë‹ˆë‹¤.', 'error');
                return;
            }

            const person = {
                name: name,
                preferredDays: [],  // ì„ í˜¸ ìš”ì¼: [0-6]
                avoidedDays: [],    // ê¸°í”¼ ìš”ì¼: [0-6]
                primaryCount: 0,    // firstë‹¹ì§ ì´ íšŸìˆ˜
                eodangCount: 0,     // ì–´ë‹¹ íšŸìˆ˜: ì¼/ì›”/í™”/ìˆ˜/ëª© ë‹¹ì§ (íœ´ì¼ ì œì™¸) - ê°€ì¤‘ì¹˜ 3
                nonEodangCount: 0,  // ë¹„ì–´ë‹¹ íšŸìˆ˜: ê¸ˆ/í†  ë‹¹ì§ ë˜ëŠ” íœ´ì¼ ë‹¹ì§ - ê°€ì¤‘ì¹˜ 2
                secondaryCount: 0,  // 2ndë‹¹ì§ íšŸìˆ˜ - ê°€ì¤‘ì¹˜ 1
                tuesdayCount: 0     // í™”ìš”ì¼ ë‹¹ì§/2nd íšŸìˆ˜
            };

            data[yearType].persons.push(person);
            nameInput.value = '';

            renderPersonList(yearType);
            renderWeekDutySelector(yearType);
            showMessage(yearType, `${name}ë‹˜ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
        }

        function removePerson(yearType, index) {
            const person = data[yearType].persons[index];
            if (confirm(`${person.name}ë‹˜ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                data[yearType].persons.splice(index, 1);
                renderPersonList(yearType);
                renderWeekDutySelector(yearType);
            }
        }

        function toggleEditPerson(yearType, index) {
            const editDiv = document.getElementById(`edit-${yearType}-${index}`);
            if (editDiv.classList.contains('active')) {
                editDiv.classList.remove('active');
            } else {
                // ë‹¤ë¥¸ í¸ì§‘ì°½ ë‹«ê¸°
                document.querySelectorAll('.edit-controls').forEach(el => el.classList.remove('active'));
                editDiv.classList.add('active');
            }
        }

        function savePersonEdit(yearType, index) {
            const person = data[yearType].persons[index];

            // ì„ í˜¸ ìš”ì¼ ì €ì¥
            const preferredChecks = document.querySelectorAll(`.preferred-day-${yearType}-${index}:checked`);
            person.preferredDays = Array.from(preferredChecks).map(cb => parseInt(cb.value));

            // ê¸°í”¼ ìš”ì¼ ì €ì¥
            const avoidedChecks = document.querySelectorAll(`.avoided-day-${yearType}-${index}:checked`);
            person.avoidedDays = Array.from(avoidedChecks).map(cb => parseInt(cb.value));

            renderPersonList(yearType);
            showMessage(yearType, `${person.name}ë‹˜ì˜ ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
        }

        function renderPersonList(yearType) {
            const container = document.getElementById(`${yearType}-persons`);
            const persons = data[yearType].persons;

            if (persons.length === 0) {
                container.innerHTML = '<p class="small-text">ë“±ë¡ëœ ì¸ì›ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            const weekDutyPerson = data[yearType].weekDutyPerson;

            let html = '';
            persons.forEach((person, index) => {
                const isWeekDuty = weekDutyPerson === person.name;
                const weekDutyClass = isWeekDuty ? 'week-duty-person' : '';

                // ë°°ì§€ ìƒì„±
                let badges = '';
                if (isWeekDuty) {
                    badges += `<span class="badge week-duty">ê°„ë‹¹ì§</span>`;
                }
                if (person.preferredDays && person.preferredDays.length > 0) {
                    const days = person.preferredDays.map(d => DAYS_OF_WEEK[d]).join(',');
                    badges += `<span class="badge preferred">ì„ í˜¸: ${days}</span>`;
                }
                if (person.avoidedDays && person.avoidedDays.length > 0) {
                    const days = person.avoidedDays.map(d => DAYS_OF_WEEK[d]).join(',');
                    badges += `<span class="badge avoided">ê¸°í”¼: ${days}</span>`;
                }

                html += `
                    <div class="person-card ${weekDutyClass}">
                        <div class="person-name">${person.name}</div>
                        <div class="person-badges">${badges}</div>
                        <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                            <button onclick="toggleEditPerson('${yearType}', ${index})"
                                    class="secondary"
                                    style="padding: 3px 8px; font-size: 11px;">
                                í¸ì§‘
                            </button>
                            <button onclick="removePerson('${yearType}', ${index})"
                                    class="danger"
                                    style="padding: 3px 8px; font-size: 11px;">
                                ì‚­ì œ
                            </button>
                        </div>

                        <!-- í¸ì§‘ ì»¨íŠ¸ë¡¤ -->
                        <div class="edit-controls" id="edit-${yearType}-${index}">
                            <div class="edit-row">
                                <label>ì„ í˜¸ ìš”ì¼:</label>
                                <div class="checkbox-group">
                                    ${DAYS_OF_WEEK.map((day, i) => `
                                        <label class="checkbox-item">
                                            <input type="checkbox" class="preferred-day-${yearType}-${index}" value="${i}"
                                                ${person.preferredDays && person.preferredDays.includes(i) ? 'checked' : ''}>
                                            ${day}
                                        </label>
                                    `).join('')}
                                </div>
                            </div>
                            <div class="edit-row">
                                <label>ê¸°í”¼ ìš”ì¼:</label>
                                <div class="checkbox-group">
                                    ${DAYS_OF_WEEK.map((day, i) => `
                                        <label class="checkbox-item">
                                            <input type="checkbox" class="avoided-day-${yearType}-${index}" value="${i}"
                                                ${person.avoidedDays && person.avoidedDays.includes(i) ? 'checked' : ''}>
                                            ${day}
                                        </label>
                                    `).join('')}
                                </div>
                            </div>
                            <button onclick="savePersonEdit('${yearType}', ${index})" class="success" style="padding: 5px 10px; font-size: 12px;">ì €ì¥</button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // ===== ê°„ë‹¹ì§ ë‹´ë‹¹ì (4ì£¼ ê¸°ì¤€ 1ëª…) =====
        function renderWeekDutySelector(yearType) {
            const container = document.getElementById(`${yearType}-week-duty`);
            if (!container) return;

            const persons = data[yearType].persons;

            if (persons.length === 0) {
                container.innerHTML = '<p class="small-text">ì¸ì›ì„ ë¨¼ì € ë“±ë¡í•´ì£¼ì„¸ìš”.</p>';
                return;
            }

            const currentValue = data[yearType].weekDutyPerson || '';

            let html = `
                <div class="week-duty-item">
                    <label>ê°„ë‹¹ì§ ë‹´ë‹¹ì (4ì£¼ ì „ì²´)</label>
                    <select onchange="setWeekDutyPerson('${yearType}', this.value)" style="width: 100%;">
                        <option value="">ì„ íƒì•ˆí•¨</option>
                        ${persons.map(p => `
                            <option value="${p.name}" ${currentValue === p.name ? 'selected' : ''}>
                                ${p.name}
                            </option>
                        `).join('')}
                    </select>
                    <p class="small-text" style="margin-top: 5px;">ì„ íƒëœ ì‚¬ëŒì€ í™”ìš”ì¼ë§ˆë‹¤ ë‹¹ì§ ë˜ëŠ” 2ndë‹¹ì§ìœ¼ë¡œ ë°°ì •ë©ë‹ˆë‹¤.</p>
                </div>
            `;

            container.innerHTML = html;
        }

        function setWeekDutyPerson(yearType, name) {
            data[yearType].weekDutyPerson = name;
            renderPersonList(yearType);
        }

        // ===== ë‹¹ì§í‘œ ìƒì„± =====
        function generateSchedule(yearType) {
            if (!startDate) {
                showMessage(yearType, 'ì‹œì‘ ë‚ ì§œë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            const persons = data[yearType].persons;

            if (persons.length < 2) {
                showMessage(yearType, 'ìµœì†Œ 2ëª… ì´ìƒì˜ ì¸ì›ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
                return;
            }

            // ì¹´ìš´íŠ¸ ì´ˆê¸°í™”
            persons.forEach(p => {
                p.primaryCount = 0;
                p.eodangCount = 0;
                p.nonEodangCount = 0;
                p.secondaryCount = 0;
                p.tuesdayCount = 0;
            });

            const schedule = [];
            const weekDutyPerson = data[yearType].weekDutyPerson;

            let attempts = 0;
            const maxAttempts = 1000;
            const topCandidates = []; // ìƒìœ„ í›„ë³´ ìŠ¤ì¼€ì¤„ ì €ì¥
            const MAX_CANDIDATES = 5; // ìµœëŒ€ í›„ë³´ ìˆ˜

            while (attempts < maxAttempts) {
                attempts++;
                schedule.length = 0;
                persons.forEach(p => {
                    p.primaryCount = 0;
                    p.eodangCount = 0;
                    p.nonEodangCount = 0;
                    p.secondaryCount = 0;
                    p.tuesdayCount = 0;
                });

                let success = true;

                // 28ì¼ (4ì£¼) ìƒì„±
                for (let day = 0; day < 28 && success; day++) {
                    const currentDate = new Date(startDate);
                    currentDate.setDate(startDate.getDate() + day);
                    const dateStr = formatDate(currentDate);
                    const dayOfWeek = currentDate.getDay();
                    const dayName = DAYS_OF_WEEK[dayOfWeek];
                    const holidayName = HOLIDAYS[dateStr];
                    const weekNumber = Math.floor(day / 7) + 1;

                    // ë‹¹ì§ ì¸ì› ìˆ˜ ê²°ì •
                    const dutyInfo = getDutyCountsForDate(dateStr, dayOfWeek);
                    let primaryCount = dutyInfo.primary;
                    let secondaryCount = dutyInfo.secondary;

                    // yearTypeì— ë”°ë¥¸ 2nd ë‹¹ì§ ìˆ˜ ì¡°ì • (ê¸°ë³¸ê°’ì¸ ê²½ìš°ì—ë§Œ)
                    if (!dateSpecificDutyCounts[dateStr] && dayOfWeek >= 1 && dayOfWeek <= 5 && !holidayName) {
                        if (yearType === 'year1') {
                            secondaryCount = (dayOfWeek === 1 || dayOfWeek === 4) ? 1 : 2;
                        } else if (yearType === 'year2') {
                            secondaryCount = (dayOfWeek === 1 || dayOfWeek === 4) ? 2 : 1;
                        } else {
                            secondaryCount = 0;
                        }
                    }

                    const daySchedule = {
                        day: day + 1,
                        date: dateStr,
                        dayOfWeek: dayOfWeek,
                        dayName: dayName,
                        isWeekend: dayOfWeek === 0 || dayOfWeek === 6,
                        isHoliday: holidayName,
                        weekNumber: weekNumber,
                        primaries: [],
                        secondaries: []
                    };

                    const assignedToday = [];

                    // ë‹¹ì§ì ì„ íƒ
                    for (let i = 0; i < primaryCount; i++) {
                        const primary = selectPrimary(yearType, persons, schedule, day, dayOfWeek, weekDutyPerson, assignedToday, holidayName);
                        if (!primary) {
                            success = false;
                            break;
                        }
                        daySchedule.primaries.push(primary.name);
                        assignedToday.push(primary);
                        primary.primaryCount++;

                        // ì–´ë‹¹/ë¹„ì–´ë‹¹ ì¹´ìš´íŠ¸
                        // ì–´ë‹¹: ì¼(0)/ì›”(1)/í™”(2)/ìˆ˜(3)/ëª©(4) ë‹¹ì§ì´ë©´ì„œ íœ´ì¼ì´ ì•„ë‹Œ ê²½ìš°
                        // ë¹„ì–´ë‹¹: ê¸ˆ(5)/í† (6) ë‹¹ì§ ë˜ëŠ” íœ´ì¼ì¸ ê²½ìš°
                        const isEodangDay = dayOfWeek >= 0 && dayOfWeek <= 4; // ì¼~ëª©
                        const isHolidayDay = !!holidayName;
                        if (isEodangDay && !isHolidayDay) {
                            primary.eodangCount++;
                        } else {
                            primary.nonEodangCount++;
                        }

                        if (dayOfWeek === 2) primary.tuesdayCount++;
                    }

                    if (!success) break;

                    // 2nd ë‹¹ì§ì ì„ íƒ
                    for (let i = 0; i < secondaryCount; i++) {
                        const secondary = selectSecondary(yearType, persons, schedule, day, dayOfWeek, weekDutyPerson, assignedToday);
                        if (!secondary) {
                            success = false;
                            break;
                        }
                        daySchedule.secondaries.push(secondary.name);
                        assignedToday.push(secondary);
                        secondary.secondaryCount++;
                        if (dayOfWeek === 2) secondary.tuesdayCount++;
                    }

                    if (success) {
                        schedule.push(daySchedule);
                    }
                }

                if (success) {
                    const scoreObj = calculateBalanceScore(persons);
                    const candidate = {
                        schedule: JSON.parse(JSON.stringify(schedule)),
                        personCounts: persons.map(p => ({
                            name: p.name,
                            primaryCount: p.primaryCount,
                            eodangCount: p.eodangCount,
                            nonEodangCount: p.nonEodangCount,
                            secondaryCount: p.secondaryCount,
                            tuesdayCount: p.tuesdayCount
                        })),
                        score: scoreObj.total,
                        scoreDetails: scoreObj
                    };

                    // ìƒìœ„ í›„ë³´ì— ì¶”ê°€
                    if (topCandidates.length < MAX_CANDIDATES) {
                        topCandidates.push(candidate);
                        topCandidates.sort((a, b) => b.score - a.score);
                    } else if (candidate.score > topCandidates[topCandidates.length - 1].score) {
                        // ì¤‘ë³µ ì œê±°: ë™ì¼í•œ ìŠ¤ì¼€ì¤„ì¸ì§€ ì²´í¬
                        const isDuplicate = topCandidates.some(tc =>
                            JSON.stringify(tc.personCounts) === JSON.stringify(candidate.personCounts)
                        );
                        if (!isDuplicate) {
                            topCandidates.pop();
                            topCandidates.push(candidate);
                            topCandidates.sort((a, b) => b.score - a.score);
                        }
                    }
                }
            }

            if (topCandidates.length === 0) {
                showMessage(yearType, `ë‹¹ì§í‘œ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (${attempts}ë²ˆ ì‹œë„)`, 'error');
                return;
            }

            // í›„ë³´ ìŠ¤ì¼€ì¤„ ì €ì¥
            data[yearType].candidates = topCandidates;
            data[yearType].selectedCandidate = 0;

            // ì²« ë²ˆì§¸ í›„ë³´ë¥¼ ê¸°ë³¸ ìŠ¤ì¼€ì¤„ë¡œ ì„¤ì •
            const bestCandidate = topCandidates[0];
            data[yearType].schedule = bestCandidate.schedule;

            // ìµœì  ìŠ¤ì¼€ì¤„ ë³µì›
            if (bestCandidate.personCounts) {
                bestCandidate.personCounts.forEach(pc => {
                    const person = persons.find(p => p.name === pc.name);
                    if (person) {
                        person.primaryCount = pc.primaryCount;
                        person.eodangCount = pc.eodangCount;
                        person.nonEodangCount = pc.nonEodangCount;
                        person.secondaryCount = pc.secondaryCount;
                        person.tuesdayCount = pc.tuesdayCount;
                    }
                });
            }

            // [ê²€ì¦] ê°„ë‹¹ì§ìê°€ ëª¨ë“  í™”ìš”ì¼ì— ë°°ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸
            let weekDutyWarnings = [];
            if (weekDutyPerson) {
                bestCandidate.schedule.forEach(daySchedule => {
                    if (daySchedule.dayOfWeek === 2) { // í™”ìš”ì¼
                        const isAssigned = daySchedule.primaries.includes(weekDutyPerson) ||
                                          daySchedule.secondaries.includes(weekDutyPerson);
                        if (!isAssigned) {
                            weekDutyWarnings.push(daySchedule.date);
                        }
                    }
                });
            }

            renderCandidateSelector(yearType);
            renderCalendar(yearType);
            renderStats(yearType);

            if (weekDutyWarnings.length > 0) {
                showMessage(yearType, `âš ï¸ ê²½ê³ : ê°„ë‹¹ì§ì(${weekDutyPerson})ê°€ ë‹¤ìŒ í™”ìš”ì¼ì— ë°°ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤: ${weekDutyWarnings.join(', ')}. ì—°ì† ë‹¹ì§ ë¬¸ì œë¡œ ì¸í•´ ë°œìƒí–ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`, 'warning');
            } else {
                const scoreDetails = bestCandidate.scoreDetails;
                showMessage(yearType, `ë‹¹ì§í‘œ ${topCandidates.length}ê°œ í›„ë³´ ìƒì„± ì™„ë£Œ (${attempts}ë²ˆ ì‹œë„)\n` +
                    `ê· ë“±ë„: firstë‹¹ì§ì°¨ì´(${scoreDetails.primaryDiff}) | ` +
                    `ê°€ì¤‘ì¹˜ë¶€ë‹´ì°¨ì´(${scoreDetails.burdenDiff}) | ` +
                    `ì „ì²´ë‹¹ì§ì°¨ì´(${scoreDetails.totalDiff})` +
                    (weekDutyPerson ? ' - ê°„ë‹¹ì§ì ëª¨ë“  í™”ìš”ì¼ ë°°ì • ì™„ë£Œ' : ''), 'success');
            }
        }

        function calculateBalanceScore(persons) {
            // ê°€ì¤‘ì¹˜ ê¸°ë°˜ ê· ë“± ë°°ë¶„
            //
            // ê°€ì¤‘ì¹˜: ë¹„ì–´ë‹¹(3) > ì–´ë‹¹(2) > 2nd(1) - ë¹„ì–´ë‹¹ì´ ê°€ì¥ í˜ë“¦
            // ê°€ì¤‘ì¹˜ ë¶€ë‹´ = (ë¹„ì–´ë‹¹ Ã— 3) + (ì–´ë‹¹ Ã— 2) + (2nd Ã— 1)
            //
            // 1ìˆœìœ„: firstë‹¹ì§ íšŸìˆ˜ ê· ë“± (ì ˆëŒ€ ìš°ì„ )
            // 2ìˆœìœ„: ê°€ì¤‘ì¹˜ ë¶€ë‹´ ê· ë“± (firstë‹¹ì§ ë§ìœ¼ë©´ ì–´ë‹¹ ë¹„ì¤‘ ë†’ì—¬ì„œ ë¶€ë‹´ ê· í˜•)

            const WEIGHT_NON_EODANG = 3;  // ë¹„ì–´ë‹¹ (ê¸ˆ/í†  ë˜ëŠ” íœ´ì¼) - ê°€ì¥ í˜ë“¦
            const WEIGHT_EODANG = 2;      // ì–´ë‹¹ (ì¼~ëª©, íœ´ì¼ì œì™¸)
            const WEIGHT_SECONDARY = 1;   // 2ndë‹¹ì§

            // 1ìˆœìœ„: first ë‹¹ì§ ê· ë“± (max - min ì°¨ì´)
            const primaryValues = persons.map(p => p.primaryCount);
            const primaryMax = Math.max(...primaryValues);
            const primaryMin = Math.min(...primaryValues);
            const primaryDiff = primaryMax - primaryMin;

            // 2ìˆœìœ„: ê°€ì¤‘ì¹˜ ë¶€ë‹´ ê· ë“±
            const burdenValues = persons.map(p => {
                const eodang = p.eodangCount || 0;
                const nonEodang = p.nonEodangCount || 0;
                const secondary = p.secondaryCount || 0;
                return (eodang * WEIGHT_EODANG) + (nonEodang * WEIGHT_NON_EODANG) + (secondary * WEIGHT_SECONDARY);
            });
            const burdenMax = Math.max(...burdenValues);
            const burdenMin = Math.min(...burdenValues);
            const burdenDiff = burdenMax - burdenMin;

            // ì „ì²´ë‹¹ì§(first + 2nd) ì°¨ì´ (ì°¸ê³ ìš©)
            const totalValues = persons.map(p => p.primaryCount + p.secondaryCount);
            const totalMax = Math.max(...totalValues);
            const totalMin = Math.min(...totalValues);
            const totalDiff = totalMax - totalMin;

            // ì ìˆ˜: ì°¨ì´ê°€ ì‘ì„ìˆ˜ë¡ ì¢‹ìŒ (0ì´ ìµœê³ )
            // 1ìˆœìœ„ >> 2ìˆœìœ„
            const score = -(primaryDiff * 10000 + burdenDiff * 100 + totalDiff);

            return {
                total: score,
                primaryDiff: primaryDiff,
                burdenDiff: burdenDiff,
                totalDiff: totalDiff,
                burdenValues: burdenValues
            };
        }

        function selectPrimary(yearType, persons, schedule, day, dayOfWeek, weekDutyPerson, assignedToday, holidayName) {
            // ê°„ë‹¹ì§ìëŠ” í™”ìš”ì¼ì— first ë˜ëŠ” 2nd ì¤‘ í•˜ë‚˜ì— ë°°ì •ë˜ë©´ ë¨
            // firstë‹¹ì§ ì„ íƒì€ ê· ë“± ë°°ë¶„ ìš°ì„ ìœ¼ë¡œ ì§„í–‰ (ê°„ë‹¹ì§ì ìš°ì„ ê¶Œ ì—†ìŒ)
            // ë§Œì•½ firstì— ë°°ì • ì•ˆë˜ë©´ selectSecondaryì—ì„œ 2ndë¡œ ë°°ì •ë¨

            // ì˜¤ëŠ˜ì´ ì–´ë‹¹ ë‚ ì¸ì§€ í™•ì¸
            const isEodangDay = (dayOfWeek >= 0 && dayOfWeek <= 4) && !holidayName;

            // í›„ë³´ì í•„í„°ë§
            let candidates = persons.filter(p =>
                !assignedToday.includes(p) &&
                canAssign(p, schedule, day, dayOfWeek) &&
                canAssignPrimary(p, dayOfWeek, weekDutyPerson)
            );

            if (candidates.length === 0) return null;

            // ì„ í˜¸ ìš”ì¼ì¸ ì‚¬ëŒ ìš°ì„ 
            const preferredCandidates = candidates.filter(p =>
                p.preferredDays && p.preferredDays.includes(dayOfWeek)
            );
            if (preferredCandidates.length > 0) {
                candidates = preferredCandidates;
            }

            // ê¸°í”¼ ìš”ì¼ì¸ ì‚¬ëŒ ì œì™¸ (ê°€ëŠ¥í•˜ë©´)
            const nonAvoidedCandidates = candidates.filter(p =>
                !p.avoidedDays || !p.avoidedDays.includes(dayOfWeek)
            );
            if (nonAvoidedCandidates.length > 0) {
                candidates = nonAvoidedCandidates;
            }

            // ê°€ì¤‘ì¹˜: ë¹„ì–´ë‹¹(3), ì–´ë‹¹(2), 2nd(1) - ë¹„ì–´ë‹¹ì´ ê°€ì¥ í˜ë“¦
            const calcBurden = (p) => {
                return (p.nonEodangCount || 0) * 3 + (p.eodangCount || 0) * 2 + (p.secondaryCount || 0) * 1;
            };

            // ìš°ì„ ìˆœìœ„ ê¸°ë°˜ ì •ë ¬
            // 1ìˆœìœ„: firstë‹¹ì§ íšŸìˆ˜ ê· ë“± (ì ì€ ì‚¬ëŒ ìš°ì„ )
            // 2ìˆœìœ„: ê°€ì¤‘ì¹˜ ë¶€ë‹´ ê· ë“± (ì ì€ ì‚¬ëŒ ìš°ì„ )
            //       - ì–´ë‹¹ ë‚ : firstë‹¹ì§ ë§ì€ ì‚¬ëŒì—ê²Œ ì–´ë‹¹ ë°°ì • â†’ ê°€ì¤‘ì¹˜ ë¶€ë‹´ ë†’ì•„ì§
            //       - ë¹„ì–´ë‹¹ ë‚ : firstë‹¹ì§ ì ì€ ì‚¬ëŒì—ê²Œ ë¹„ì–´ë‹¹ ë°°ì • â†’ ê°€ì¤‘ì¹˜ ë¶€ë‹´ ê· í˜•
            candidates.sort((a, b) => {
                // 1ìˆœìœ„: first ë‹¹ì§ íšŸìˆ˜ (ë‚®ì„ìˆ˜ë¡ ìš°ì„ )
                if (a.primaryCount !== b.primaryCount) {
                    return a.primaryCount - b.primaryCount;
                }
                // 2ìˆœìœ„: ê°€ì¤‘ì¹˜ ë¶€ë‹´ (ë‚®ì„ìˆ˜ë¡ ìš°ì„ )
                const aBurden = calcBurden(a);
                const bBurden = calcBurden(b);
                return aBurden - bBurden;
            });

            // ë‹¹ì§ íšŸìˆ˜ê°€ ìµœì†Œì¸ í›„ë³´ ì¤‘ì—ì„œ ëœë¤ ì„ íƒ
            const minCount = candidates[0].primaryCount;
            const topCandidates = candidates.filter(c => c.primaryCount <= minCount);
            return topCandidates[Math.floor(Math.random() * topCandidates.length)];
        }

        function selectSecondary(yearType, persons, schedule, day, dayOfWeek, weekDutyPerson, assignedToday) {
            // [ì ˆëŒ€ì¡°ê±´] ê°„ë‹¹ì§ì - í™”ìš”ì¼ì— ë‹¹ì§ì— ë°°ì • ì•ˆëìœ¼ë©´ ë°˜ë“œì‹œ 2ndë¡œ ë°°ì •
            if (dayOfWeek === 2 && weekDutyPerson) {
                const weekDutyPersonObj = persons.find(p => p.name === weekDutyPerson);
                // ê°„ë‹¹ì§ìê°€ ì•„ì§ ì˜¤ëŠ˜ ë°°ì • ì•ˆëìœ¼ë©´ ë°˜ë“œì‹œ 2ndë¡œ ë°°ì •
                if (weekDutyPersonObj && !assignedToday.includes(weekDutyPersonObj)) {
                    // ì—°ì† ë‹¹ì§ ì²´í¬ë¥¼ í•˜ë˜, í™”ìš”ì¼ ê°„ë‹¹ì§ì€ ì ˆëŒ€ì¡°ê±´ì´ë¯€ë¡œ
                    // ì—°ì†ì´ë”ë¼ë„ ê°•ì œ ë°°ì • (ë‹¨, ê²½ê³  í‘œì‹œ)
                    return weekDutyPersonObj;
                }
            }

            let candidates = persons.filter(p =>
                !assignedToday.includes(p) &&
                canAssignSecondary(p, schedule, day, dayOfWeek)
            );

            if (candidates.length === 0) return null;

            // ì„ í˜¸ ìš”ì¼ì¸ ì‚¬ëŒ ìš°ì„ 
            const preferredCandidates = candidates.filter(p =>
                p.preferredDays && p.preferredDays.includes(dayOfWeek)
            );
            if (preferredCandidates.length > 0) {
                candidates = preferredCandidates;
            }

            // ê¸°í”¼ ìš”ì¼ì¸ ì‚¬ëŒ ì œì™¸ (ê°€ëŠ¥í•˜ë©´)
            const nonAvoidedCandidates = candidates.filter(p =>
                !p.avoidedDays || !p.avoidedDays.includes(dayOfWeek)
            );
            if (nonAvoidedCandidates.length > 0) {
                candidates = nonAvoidedCandidates;
            }

            // ê°€ì¤‘ì¹˜ ë¶€ë‹´ ê· ë“± - ë¶€ë‹´ ì ì€ ì‚¬ëŒì—ê²Œ 2nd ë°°ì • (ë¹„ì–´ë‹¹Ã—3, ì–´ë‹¹Ã—2, 2ndÃ—1)
            const calcBurden = (p) => {
                return (p.nonEodangCount || 0) * 3 + (p.eodangCount || 0) * 2 + (p.secondaryCount || 0) * 1;
            };

            candidates.sort((a, b) => {
                const aBurden = calcBurden(a);
                const bBurden = calcBurden(b);
                if (aBurden !== bBurden) {
                    return aBurden - bBurden; // ê°€ì¤‘ì¹˜ ë¶€ë‹´ ì ì€ ì‚¬ëŒ ìš°ì„ 
                }
                return a.secondaryCount - b.secondaryCount;
            });

            const minBurden = calcBurden(candidates[0]);
            const topCandidates = candidates.filter(c => calcBurden(c) <= minBurden + 1);
            return topCandidates[Math.floor(Math.random() * topCandidates.length)];
        }

        // ê°„ë‹¹ì§ì ì „ìš© ì—°ì† ë‹¹ì§ ì²´í¬ (í™”ìš”ì¼ ì ˆëŒ€ì¡°ê±´ìš©)
        function canAssignForWeekDuty(person, schedule, day) {
            if (schedule.length > 0) {
                const yesterday = schedule[schedule.length - 1];
                // firstë‹¹ì§ ë‹¤ìŒë‚ ë§Œ ë¶ˆê°€ (2ndë‹¹ì§ ë‹¤ìŒë‚ ì€ ê°€ëŠ¥)
                if (yesterday.primaries.includes(person.name)) {
                    return false;
                }
            }
            return true;
        }

        function canAssign(person, schedule, day, dayOfWeek) {
            // firstë‹¹ì§ ë‹¤ìŒë‚  â†’ first, 2nd ë‘˜ ë‹¤ ë¶ˆê°€
            // 2ndë‹¹ì§ ë‹¤ìŒë‚  â†’ first, 2nd ë‘˜ ë‹¤ ê°€ëŠ¥
            if (schedule.length > 0) {
                const yesterday = schedule[schedule.length - 1];
                if (yesterday.primaries.includes(person.name)) {
                    return false; // ì–´ì œ firstë‹¹ì§ì´ë©´ ì˜¤ëŠ˜ ë¶ˆê°€
                }
                // ì–´ì œ 2ndë‹¹ì§ì´ì—ˆìœ¼ë©´ ì˜¤ëŠ˜ ê°€ëŠ¥ (ì²´í¬ ì•ˆí•¨)
            }
            return true;
        }

        function canAssignPrimary(person, dayOfWeek, weekDutyPerson) {
            // ê°„ë‹¹ì§ìëŠ” ì¼(0), ì›”(1), ìˆ˜(3) "ë‹¹ì§" ë¶ˆê°€ (2ndë‹¹ì§ì€ ê°€ëŠ¥!)
            if (person.name === weekDutyPerson) {
                if (dayOfWeek === 0 || dayOfWeek === 1 || dayOfWeek === 3) {
                    return false;
                }
            }
            return true;
        }

        function canAssignSecondary(person, schedule, day, dayOfWeek) {
            // firstë‹¹ì§ ë‹¤ìŒë‚ ë§Œ ë¶ˆê°€, 2ndë‹¹ì§ ë‹¤ìŒë‚ ì€ ê°€ëŠ¥
            return canAssign(person, schedule, day, dayOfWeek);
        }

        // ===== í›„ë³´ ìŠ¤ì¼€ì¤„ ì„ íƒ UI =====
        function renderCandidateSelector(yearType) {
            const container = document.getElementById(`${yearType}-candidates`);
            if (!container) {
                // í›„ë³´ ì„ íƒ ì˜ì—­ì´ ì—†ìœ¼ë©´ ìƒì„±
                const calendarContainer = document.getElementById(`${yearType}-calendar`);
                const candidateDiv = document.createElement('div');
                candidateDiv.id = `${yearType}-candidates`;
                candidateDiv.className = 'candidate-selector';
                calendarContainer.parentNode.insertBefore(candidateDiv, calendarContainer);
            }

            const candidates = data[yearType].candidates || [];
            const selectedIdx = data[yearType].selectedCandidate || 0;

            if (candidates.length <= 1) {
                document.getElementById(`${yearType}-candidates`).innerHTML = '';
                return;
            }

            let html = `
                <div class="settings-section" style="margin-top: 15px;">
                    <h4>í›„ë³´ ìŠ¤ì¼€ì¤„ ì„ íƒ (${candidates.length}ê°œ)</h4>
                    <p class="small-text">
                        <strong>ê°€ì¤‘ì¹˜:</strong> ì–´ë‹¹(Ã—3) > ë¹„ì–´ë‹¹(Ã—2) > 2nd(Ã—1)<br>
                        <span style="color: #666;">firstë‹¹ì§ ê· ë“± í›„ ê°€ì¤‘ì¹˜ ë¶€ë‹´ìœ¼ë¡œ ê· í˜• ë§ì¶¤</span>
                    </p>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;">
            `;

            candidates.forEach((candidate, idx) => {
                const isSelected = idx === selectedIdx;
                const scores = candidate.scoreDetails;
                const btnClass = isSelected ? 'primary' : 'secondary';

                // ì°¨ì´ê°€ 0ì´ë©´ ë…¹ìƒ‰, ì•„ë‹ˆë©´ ì£¼í™©/ë¹¨ê°•
                const getDiffColor = (diff) => diff === 0 ? '#27ae60' : diff <= 2 ? '#f39c12' : '#e74c3c';

                html += `
                    <div class="candidate-card" style="background: ${isSelected ? '#e8f4fd' : '#f8f9fa'};
                         border: 2px solid ${isSelected ? '#3498db' : '#ddd'};
                         border-radius: 8px; padding: 10px; min-width: 160px;">
                        <div style="font-weight: 600; margin-bottom: 5px;">í›„ë³´ ${idx + 1}</div>
                        <div style="font-size: 11px;">
                            <div style="color: ${getDiffColor(scores.primaryDiff)};">firstë‹¹ì§ì°¨ì´: ${scores.primaryDiff}</div>
                            <div style="color: ${getDiffColor(scores.burdenDiff)};">ê°€ì¤‘ì¹˜ë¶€ë‹´ì°¨ì´: ${scores.burdenDiff}</div>
                            <div style="color: ${getDiffColor(scores.totalDiff)};">ì „ì²´ë‹¹ì§ì°¨ì´: ${scores.totalDiff}</div>
                        </div>
                        <button onclick="selectCandidate('${yearType}', ${idx})"
                                class="${btnClass}"
                                style="margin-top: 8px; padding: 5px 15px; font-size: 12px;">
                            ${isSelected ? 'ì„ íƒë¨' : 'ì„ íƒ'}
                        </button>
                    </div>
                `;
            });

            html += `
                    </div>
                </div>
            `;

            document.getElementById(`${yearType}-candidates`).innerHTML = html;
        }

        function selectCandidate(yearType, index) {
            const candidates = data[yearType].candidates || [];
            if (index < 0 || index >= candidates.length) return;

            data[yearType].selectedCandidate = index;
            const candidate = candidates[index];

            // ìŠ¤ì¼€ì¤„ ë° ì¹´ìš´íŠ¸ ë³µì›
            data[yearType].schedule = candidate.schedule;
            const persons = data[yearType].persons;

            candidate.personCounts.forEach(pc => {
                const person = persons.find(p => p.name === pc.name);
                if (person) {
                    person.primaryCount = pc.primaryCount;
                    person.eodangCount = pc.eodangCount;
                    person.nonEodangCount = pc.nonEodangCount;
                    person.secondaryCount = pc.secondaryCount;
                    person.tuesdayCount = pc.tuesdayCount;
                }
            });

            renderCandidateSelector(yearType);
            renderCalendar(yearType);
            renderStats(yearType);

            const scores = candidate.scoreDetails;
            showMessage(yearType, `í›„ë³´ ${index + 1} ì„ íƒë¨ - ` +
                `firstë‹¹ì§ì°¨ì´: ${scores.primaryDiff}, ` +
                `ê°€ì¤‘ì¹˜ë¶€ë‹´ì°¨ì´: ${scores.burdenDiff}, ` +
                `ì „ì²´ë‹¹ì§ì°¨ì´: ${scores.totalDiff}`, 'info');
        }

        // ===== ìº˜ë¦°ë” ë Œë”ë§ =====
        function renderCalendar(yearType) {
            const container = document.getElementById(`${yearType}-calendar`);
            const schedule = data[yearType].schedule;

            if (!schedule || schedule.length === 0) {
                container.innerHTML = '';
                return;
            }

            // ì²« ë²ˆì§¸ ë‚ ì§œ ì°¾ê¸°
            const firstDate = parseDate(schedule[0].date);
            const lastDate = parseDate(schedule[schedule.length - 1].date);

            // í•´ë‹¹ ì›”ì˜ ì²«ë‚ ë¶€í„° ì‹œì‘
            const calendarStart = new Date(firstDate.getFullYear(), firstDate.getMonth(), 1);
            const calendarEnd = new Date(lastDate.getFullYear(), lastDate.getMonth() + 1, 0);

            let html = '<div class="calendar">';

            // ìš”ì¼ í—¤ë”
            DAYS_OF_WEEK.forEach((name, i) => {
                let headerClass = 'calendar-day-header';
                if (i === 0) headerClass += ' sunday';
                if (i === 6) headerClass += ' saturday';
                html += `<div class="${headerClass}">${name}</div>`;
            });

            // ë¹ˆ ì¹¸
            const firstDayOfWeek = calendarStart.getDay();
            for (let i = 0; i < firstDayOfWeek; i++) {
                html += '<div class="calendar-day empty"></div>';
            }

            // ë‚ ì§œ
            const current = new Date(calendarStart);
            while (current <= calendarEnd) {
                const dateStr = formatDate(current);
                const dayOfWeek = current.getDay();
                const holidayName = HOLIDAYS[dateStr];
                const daySchedule = schedule.find(s => s.date === dateStr);

                let dayClass = 'calendar-day';
                if (dayOfWeek === 0) dayClass += ' sunday';
                if (dayOfWeek === 6) dayClass += ' saturday';
                if (holidayName) dayClass += ' holiday';
                if (!daySchedule) dayClass += ' empty';

                html += `<div class="${dayClass}">`;
                html += `<div class="day-number">${current.getDate()}</div>`;

                if (holidayName) {
                    html += `<div class="holiday-name">${holidayName}</div>`;
                }

                if (daySchedule) {
                    daySchedule.primaries.forEach(name => {
                        html += `<div class="duty-item ${yearType} primary">ë‹¹ì§: ${name}</div>`;
                    });
                    daySchedule.secondaries.forEach(name => {
                        html += `<div class="duty-item ${yearType} secondary">2nd: ${name}</div>`;
                    });
                }

                html += '</div>';
                current.setDate(current.getDate() + 1);
            }

            html += '</div>';
            container.innerHTML = html;
        }

        // ===== í†µê³„ ë Œë”ë§ =====
        function renderStats(yearType) {
            const container = document.getElementById(`${yearType}-stats`);
            const persons = data[yearType].persons;

            if (persons.length === 0) {
                container.innerHTML = '';
                return;
            }

            // ê°€ì¤‘ì¹˜ ìƒìˆ˜ (ë¹„ì–´ë‹¹ì´ ê°€ì¥ í˜ë“¦)
            const WEIGHT_NON_EODANG = 3;  // ë¹„ì–´ë‹¹ - ê°€ì¥ í˜ë“¦
            const WEIGHT_EODANG = 2;
            const WEIGHT_SECONDARY = 1;

            // ì°¨ì´ ê³„ì‚° (max - min)
            const primaryValues = persons.map(p => p.primaryCount);
            const burdenValues = persons.map(p => {
                return (p.eodangCount || 0) * WEIGHT_EODANG +
                       (p.nonEodangCount || 0) * WEIGHT_NON_EODANG +
                       (p.secondaryCount || 0) * WEIGHT_SECONDARY;
            });
            const totalValues = persons.map(p => p.primaryCount + p.secondaryCount);

            const calcDiff = (arr) => Math.max(...arr) - Math.min(...arr);
            const getDiffColor = (diff, threshold) => diff === 0 ? '#27ae60' : diff <= threshold ? '#f39c12' : '#e74c3c';

            const primaryDiff = calcDiff(primaryValues);
            const burdenDiff = calcDiff(burdenValues);
            const totalDiff = calcDiff(totalValues);

            let html = `
                <h3>í†µê³„ (4ì£¼ ê¸°ì¤€)</h3>
                <div class="alert alert-info" style="margin-bottom: 15px;">
                    <strong>ê· ë“± ë¶„í¬ í˜„í™©</strong><br>
                    <span style="color: ${getDiffColor(primaryDiff, 1)}; font-weight: 600;">1ìˆœìœ„ firstë‹¹ì§ì°¨ì´: ${primaryDiff}</span> |
                    <span style="color: ${getDiffColor(burdenDiff, 2)}; font-weight: 600;">2ìˆœìœ„ ê°€ì¤‘ì¹˜ë¶€ë‹´ì°¨ì´: ${burdenDiff}</span> |
                    <span style="color: ${getDiffColor(totalDiff, 1)}; font-weight: 600;">ì „ì²´ë‹¹ì§ì°¨ì´: ${totalDiff}</span>
                </div>
                <div class="stats-grid">
            `;

            persons.forEach(person => {
                const total = person.primaryCount + person.secondaryCount;
                const eodang = person.eodangCount || 0;
                const nonEodang = person.nonEodangCount || 0;
                const burden = eodang * WEIGHT_EODANG + nonEodang * WEIGHT_NON_EODANG + person.secondaryCount * WEIGHT_SECONDARY;

                html += `
                    <div class="stat-card">
                        <h4>${person.name}</h4>
                        <div class="stat-row">
                            <span class="stat-label">firstë‹¹ì§</span>
                            <span class="stat-value" style="color: #c0392b;">${person.primaryCount}íšŒ</span>
                        </div>
                        <div class="stat-row" style="font-size: 11px; padding-left: 10px;">
                            <span class="stat-label">- ë¹„ì–´ë‹¹ (Ã—3)</span>
                            <span class="stat-value">${nonEodang}íšŒ</span>
                        </div>
                        <div class="stat-row" style="font-size: 11px; padding-left: 10px;">
                            <span class="stat-label">- ì–´ë‹¹ (Ã—2)</span>
                            <span class="stat-value">${eodang}íšŒ</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">2ndë‹¹ì§ (Ã—1)</span>
                            <span class="stat-value">${person.secondaryCount}íšŒ</span>
                        </div>
                        <div class="stat-row" style="border-top: 1px solid #eee; padding-top: 5px; margin-top: 5px;">
                            <span class="stat-label">ê°€ì¤‘ì¹˜ ë¶€ë‹´</span>
                            <span class="stat-value" style="color: #2980b9; font-weight: 600;">${burden}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">ì „ì²´ë‹¹ì§</span>
                            <span class="stat-value" style="color: #27ae60;">${total}íšŒ</span>
                        </div>
                    </div>
                `;
            });

            html += '</div>';

            // ì„¤ëª… ì¶”ê°€
            html += `
                <p class="small-text" style="margin-top: 10px;">
                    <strong>ê°€ì¤‘ì¹˜ ë¶€ë‹´</strong> = (ì–´ë‹¹ Ã— 3) + (ë¹„ì–´ë‹¹ Ã— 2) + (2nd Ã— 1)<br>
                    <strong>ì–´ë‹¹:</strong> ì¼~ëª© firstë‹¹ì§ (íœ´ì¼ ì œì™¸) | <strong>ë¹„ì–´ë‹¹:</strong> ê¸ˆ/í†  firstë‹¹ì§ ë˜ëŠ” íœ´ì¼<br>
                    firstë‹¹ì§ ê· ë“± â†’ ê°€ì¤‘ì¹˜ ë¶€ë‹´ ê· ë“± ìˆœìœ¼ë¡œ ìµœì í™”
                </p>
            `;

            container.innerHTML = html;
        }

        // ===== í†µí•© ìº˜ë¦°ë” =====
        function renderCombinedCalendar() {
            const container = document.getElementById('combined-calendar');

            const year1Schedule = data.year1.schedule;
            const year2Schedule = data.year2.schedule;
            const seniorSchedule = data.senior.schedule;

            if (year1Schedule.length === 0 && year2Schedule.length === 0 && seniorSchedule.length === 0) {
                container.innerHTML = '<p class="small-text">ìƒì„±ëœ ë‹¹ì§í‘œê°€ ì—†ìŠµë‹ˆë‹¤. ê° ë…„ì°¨ë³„ ë‹¹ì§í‘œë¥¼ ë¨¼ì € ìƒì„±í•´ì£¼ì„¸ìš”.</p>';
                return;
            }

            // ë‚ ì§œ ë²”ìœ„ ì°¾ê¸°
            const allDates = [...year1Schedule, ...year2Schedule, ...seniorSchedule].map(s => s.date);
            if (allDates.length === 0) {
                container.innerHTML = '<p class="small-text">ìƒì„±ëœ ë‹¹ì§í‘œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            allDates.sort();
            const firstDate = parseDate(allDates[0]);
            const lastDate = parseDate(allDates[allDates.length - 1]);

            const calendarStart = new Date(firstDate.getFullYear(), firstDate.getMonth(), 1);
            const calendarEnd = new Date(lastDate.getFullYear(), lastDate.getMonth() + 1, 0);

            let html = '<div class="calendar">';

            // ìš”ì¼ í—¤ë”
            DAYS_OF_WEEK.forEach((name, i) => {
                let headerClass = 'calendar-day-header';
                if (i === 0) headerClass += ' sunday';
                if (i === 6) headerClass += ' saturday';
                html += `<div class="${headerClass}">${name}</div>`;
            });

            // ë¹ˆ ì¹¸
            const firstDayOfWeek = calendarStart.getDay();
            for (let i = 0; i < firstDayOfWeek; i++) {
                html += '<div class="calendar-day empty"></div>';
            }

            // ë‚ ì§œ
            const current = new Date(calendarStart);
            while (current <= calendarEnd) {
                const dateStr = formatDate(current);
                const dayOfWeek = current.getDay();
                const holidayName = HOLIDAYS[dateStr];

                const y1 = year1Schedule.find(s => s.date === dateStr);
                const y2 = year2Schedule.find(s => s.date === dateStr);
                const sr = seniorSchedule.find(s => s.date === dateStr);

                const hasData = y1 || y2 || sr;

                let dayClass = 'calendar-day';
                if (dayOfWeek === 0) dayClass += ' sunday';
                if (dayOfWeek === 6) dayClass += ' saturday';
                if (holidayName) dayClass += ' holiday';
                if (!hasData) dayClass += ' empty';

                html += `<div class="${dayClass}">`;
                html += `<div class="day-number">${current.getDate()}</div>`;

                if (holidayName) {
                    html += `<div class="holiday-name">${holidayName}</div>`;
                }

                // ì‹œë‹ˆì–´
                if (sr) {
                    sr.primaries.forEach(name => {
                        html += `<div class="duty-item senior primary">S: ${name}</div>`;
                    });
                }

                // 2ë…„ì°¨
                if (y2) {
                    y2.primaries.forEach(name => {
                        html += `<div class="duty-item year2 primary">2: ${name}</div>`;
                    });
                    y2.secondaries.forEach(name => {
                        html += `<div class="duty-item year2 secondary">2-2nd: ${name}</div>`;
                    });
                }

                // 1ë…„ì°¨
                if (y1) {
                    y1.primaries.forEach(name => {
                        html += `<div class="duty-item year1 primary">1: ${name}</div>`;
                    });
                    y1.secondaries.forEach(name => {
                        html += `<div class="duty-item year1 secondary">1-2nd: ${name}</div>`;
                    });
                }

                html += '</div>';
                current.setDate(current.getDate() + 1);
            }

            html += '</div>';
            container.innerHTML = html;
        }

        // ===== ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° =====
        function saveSchedule(yearType) {
            const saveData = {
                yearType: yearType,
                startDate: startDate ? formatDate(startDate) : null,
                persons: data[yearType].persons,
                schedule: data[yearType].schedule,
                weekDutyPerson: data[yearType].weekDutyPerson,
                dateSpecificDutyCounts: dateSpecificDutyCounts,
                savedAt: new Date().toISOString()
            };

            const json = JSON.stringify(saveData, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${yearType}_ë‹¹ì§í‘œ_4ì£¼.json`;
            a.click();
            URL.revokeObjectURL(url);

            showMessage(yearType, 'ë‹¹ì§í‘œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }

        function loadSchedule(yearType) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const loadedData = JSON.parse(e.target.result);

                        data[yearType].persons = loadedData.persons || [];
                        data[yearType].schedule = loadedData.schedule || [];
                        data[yearType].weekDutyPerson = loadedData.weekDutyPerson || '';

                        if (loadedData.startDate) {
                            startDate = parseDate(loadedData.startDate);
                            document.getElementById('startDate').value = loadedData.startDate;
                            updateStartDate();
                        }

                        if (loadedData.dateSpecificDutyCounts) {
                            dateSpecificDutyCounts = loadedData.dateSpecificDutyCounts;
                        }

                        renderPersonList(yearType);
                        renderWeekDutySelector(yearType);
                        renderCalendar(yearType);
                        renderStats(yearType);
                        renderPreviewCalendar();

                        showMessage(yearType, 'ë‹¹ì§í‘œë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.', 'success');
                    } catch (error) {
                        showMessage(yearType, 'íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: ' + error.message, 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function loadAllSchedules() {
            showMessage('combined', 'ê° ë…„ì°¨ë³„ ë‹¹ì§í‘œë¥¼ ë¨¼ì € ìƒì„±í•˜ê±°ë‚˜ ë¶ˆëŸ¬ì˜¨ í›„ í†µí•© ìº˜ë¦°ë”ë¥¼ í™•ì¸í•˜ì„¸ìš”.', 'info');
            renderCombinedCalendar();
        }

        // ===== ì˜ˆì‹œ ë°ì´í„° ë¡œë“œ =====
        function loadExampleData(yearType) {
            const examplePersons = {
                year1: [
                    { name: 'ê¹€ë¯¼ìˆ˜' },
                    { name: 'ì´ì˜í¬' },
                    { name: 'ë°•ì² ìˆ˜' },
                    { name: 'ì •ìˆ˜ì§„' },
                    { name: 'ìµœë™í˜„' },
                    { name: 'í•œë¯¸ì˜' }
                ],
                year2: [
                    { name: 'ê°•ì§€í›ˆ' },
                    { name: 'ìœ¤ì„œì—°' },
                    { name: 'ì„íƒœí˜„' },
                    { name: 'ì†¡ì§€ì€' },
                    { name: 'í™©ë¯¼í˜¸' }
                ],
                senior: [
                    { name: 'ì˜¤ìŠ¹í˜„' },
                    { name: 'ì‹ ì˜ˆì§„' },
                    { name: 'ë¥˜í˜„ìš°' },
                    { name: 'í™ì§€ë¯¼' }
                ]
            };

            data[yearType].persons = examplePersons[yearType].map(p => ({
                name: p.name,
                preferredDays: p.preferredDays || [],
                avoidedDays: p.avoidedDays || [],
                primaryCount: 0,
                eodangCount: 0,
                nonEodangCount: 0,
                secondaryCount: 0,
                tuesdayCount: 0
            }));

            // ì²« ë²ˆì§¸ ì‚¬ëŒì„ ê°„ë‹¹ì§ìë¡œ ì§€ì •
            data[yearType].weekDutyPerson = data[yearType].persons[0].name;
            data[yearType].schedule = [];

            renderPersonList(yearType);
            renderWeekDutySelector(yearType);

            showMessage(yearType, `ì˜ˆì‹œ ë°ì´í„°ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. (${data[yearType].persons.length}ëª…)`, 'success');
        }

        function exportCombined() {
            const year1Schedule = data.year1.schedule;
            const year2Schedule = data.year2.schedule;
            const seniorSchedule = data.senior.schedule;

            if (year1Schedule.length === 0 && year2Schedule.length === 0 && seniorSchedule.length === 0) {
                showMessage('combined', 'ë‚´ë³´ë‚¼ ë‹¹ì§í‘œê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            let text = `ì „ê³µì˜ ë‹¹ì§í‘œ (4ì£¼)\n`;
            text += '='.repeat(50) + '\n\n';

            const allDates = [...new Set([
                ...year1Schedule.map(s => s.date),
                ...year2Schedule.map(s => s.date),
                ...seniorSchedule.map(s => s.date)
            ])].sort();

            allDates.forEach(dateStr => {
                const date = parseDate(dateStr);
                const dayOfWeek = date.getDay();
                const dayName = DAYS_OF_WEEK[dayOfWeek];
                const holidayName = HOLIDAYS[dateStr];

                const y1 = year1Schedule.find(s => s.date === dateStr);
                const y2 = year2Schedule.find(s => s.date === dateStr);
                const sr = seniorSchedule.find(s => s.date === dateStr);

                text += `${dateStr} (${dayName})${holidayName ? ' [' + holidayName + ']' : ''}\n`;

                if (sr && sr.primaries.length > 0) text += `  ì‹œë‹ˆì–´: ${sr.primaries.join(', ')}\n`;
                if (y2) {
                    if (y2.primaries.length > 0) text += `  2ë…„ì°¨: ${y2.primaries.join(', ')}`;
                    if (y2.secondaries.length > 0) text += `, 2nd: ${y2.secondaries.join(', ')}`;
                    text += '\n';
                }
                if (y1) {
                    if (y1.primaries.length > 0) text += `  1ë…„ì°¨: ${y1.primaries.join(', ')}`;
                    if (y1.secondaries.length > 0) text += `, 2nd: ${y1.secondaries.join(', ')}`;
                    text += '\n';
                }
                text += '\n';
            });

            // í†µê³„
            text += '\n' + '='.repeat(50) + '\n';
            text += 'í†µê³„ (4ì£¼ ê¸°ì¤€)\n';
            text += '='.repeat(50) + '\n\n';

            ['year1', 'year2', 'senior'].forEach(yearType => {
                const label = yearType === 'year1' ? '1ë…„ì°¨' : yearType === 'year2' ? '2ë…„ì°¨' : 'ì‹œë‹ˆì–´';
                text += `[${label}]\n`;
                data[yearType].persons.forEach(p => {
                    text += `  ${p.name}: ë‹¹ì§ ${p.primaryCount}íšŒ, ì–´ë‹¹ ${p.eodangCount || 0}íšŒ, `;
                    text += `2nd ${p.secondaryCount}íšŒ, í™”ìš”ì¼ ${p.tuesdayCount || 0}íšŒ\n`;
                });
                text += '\n';
            });

            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `í†µí•©ë‹¹ì§í‘œ_4ì£¼.txt`;
            a.click();
            URL.revokeObjectURL(url);

            showMessage('combined', 'í†µí•© ë‹¹ì§í‘œê°€ ë‚´ë³´ë‚´ê¸° ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }

        // ===== ë©”ì‹œì§€ =====
        function showMessage(yearType, message, type) {
            const container = document.getElementById(`${yearType}-messages`);
            if (!container) return;

            const alertClass = type === 'error' ? 'alert-error' :
                              type === 'success' ? 'alert-success' :
                              type === 'warning' ? 'alert-warning' : 'alert-info';

            container.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;

            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }
    </script>
</body>
</html>
